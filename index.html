<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Driver Prep</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<link rel="manifest" href="data:application/manifest+json,{
  &quot;name&quot;: &quot;Driver Prep Demo&quot;,
  &quot;short_name&quot;: &quot;DriverPrep&quot;,
  &quot;description&quot;: &quot;Demo dashboard for driver prep orders&quot;,
  &quot;start_url&quot;: &quot;/index.html&quot;,
  &quot;display&quot;: &quot;standalone&quot;,
  &quot;background_color&quot;: &quot;#0b0e1b&quot;,
  &quot;theme_color&quot;: &quot;#3b82f6&quot;,
  &quot;icons&quot;: [{
    &quot;src&quot;: &quot;data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiBmaWxsPSIjM2I4MmY2Ii8+Cjx0ZXh0IHg9Ijk2IiB5PSIxMDYiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSI0OCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5EUzwvdGV4dD4KPC9zdmc+&quot;,
    &quot;sizes&quot;: &quot;192x192&quot;,
    &quot;type&quot;: &quot;image/svg+xml&quot;
  }, {
    &quot;src&quot;: &quot;data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgdmlld0JveD0iMCAwIDUxMiA1MTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiBmaWxsPSIjM2I4MmY2Ii8+Cjx0ZXh0IHg9IjI1NiIgeT0iMjc2IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTI4IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkRQPjwvdGV4dD4KPC9zdmc+&quot;,
    &quot;sizes&quot;: &quot;512x512&quot;,
    &quot;type&quot;: &quot;image/svg+xml&quot;
  }]
}">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="DriverPrep">
<link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiBmaWxsPSIjM2I4MmY2Ii8+Cjx0ZXh0IHg9Ijk2IiB5PSIxMDYiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSI0OCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5EUzwvdGV4dD4KPC9zdmc+">
<style>
:root{ 
  --bg:#0b0e1b; 
  --bg-elev:#0f1222; 
  --card:#161a31; 
  --muted:#8b90b0; 
  --text:#e8ebff; 
  --border:#272a44; 
  --chip:#1b2150; 
  --focus:#3b82f6; 
  --accent:#22c55e; 
  --shadow:0 10px 30px rgba(0,0,0,.35); 
  --spacing-xs:4px; 
  --spacing-sm:8px; 
  --spacing-md:12px; 
  --spacing-lg:16px; 
  --spacing-xl:20px; 
}
*{box-sizing:border-box}
html,body{height:100%; -webkit-overflow-scrolling: touch; -webkit-tap-highlight-color: transparent;}
body{ 
  margin:0; 
  font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; 
  background:var(--bg); 
  color:var(--text); 
  -webkit-font-smoothing:antialiased; 
  -moz-osx-font-smoothing:grayscale; 
  padding-bottom:calc(64px + env(safe-area-inset-bottom)); 
  overflow-x:hidden; 
  line-height:1.5; 
}
/* Top App Bar - Mobile Optimized */
.top{ 
  position:sticky; 
  top:0; 
  z-index:20; 
  padding:var(--spacing-sm) var(--spacing-lg) calc(var(--spacing-sm) + env(safe-area-inset-top)) var(--spacing-lg); 
  border-bottom:1px solid var(--border); 
  background:linear-gradient(180deg, rgba(17,21,42,.95), rgba(17,21,42,.85)); 
  backdrop-filter: blur(10px); 
  display:flex; 
  justify-content:space-between; 
  align-items:center; 
  gap:var(--spacing-md); 
  box-shadow:0 2px 10px rgba(0,0,0,.1); 
}
.brand{display:flex; align-items:center; gap:var(--spacing-sm)}
.brand .logo{width:28px; height:28px; border-radius:8px; background:var(--focus); display:grid; place-items:center; color:white; font-weight:800; font-size:12px;}
.top h1{margin:0; font-size:clamp(16px, 4vw, 18px); font-weight:600;}
.top .actions{display:flex; align-items:center; gap:var(--spacing-sm); flex-shrink:0;}
.icon-btn{ 
  width:40px; 
  height:40px; 
  border-radius:12px; 
  border:1px solid var(--border); 
  background:var(--card); 
  display:grid; 
  place-items:center; 
  color:var(--text); 
  cursor:pointer; 
  transition:transform .08s ease, box-shadow .1s ease; 
  font-size:16px; 
  touch-action:manipulation; 
}
.icon-btn:active{ transform:scale(.96); box-shadow:0 4px 12px rgba(59,130,246,.3); }
/* Header search for customers - Mobile */
.header-search{ 
  background:#0f1330; 
  color:var(--text); 
  border:1px solid var(--border); 
  border-radius:12px; 
  padding:var(--spacing-sm) var(--spacing-md); 
  font-size:14px; 
  min-width:140px; 
  flex:1; 
  max-width:200px; 
}
/* Cards, Panels - Responsive */
.wrap{max-width:1200px; margin:var(--spacing-lg) auto; padding:0 var(--spacing-lg)}
.cards{display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:var(--spacing-md); margin-bottom:var(--spacing-lg)}
.card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:var(--spacing-md); box-shadow:var(--shadow); transition:transform .1s ease;}
.card:active{transform:scale(.98);}
.card-title{font-size:12px; color:var(--muted); margin-bottom:var(--spacing-xs); text-transform:uppercase; letter-spacing:0.5px;}
.kpi{font-size:clamp(20px, 6vw, 28px); font-weight:800; line-height:1.2;}
.grid{display:grid; grid-template-columns:1fr; gap:var(--spacing-lg)} /* Stack on mobile */
@media (min-width:768px){.grid{grid-template-columns:1fr 1fr;}}
.panel{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:var(--spacing-lg); box-shadow:var(--shadow); margin-bottom:var(--spacing-lg);}
.panel h3{margin:0 0 var(--spacing-md) 0; font-size:clamp(16px, 4vw, 18px); font-weight:600;}
/* Tables - Mobile Horizontal Scroll */
.table-wrap{overflow:auto; border:1px solid var(--border); border-radius:12px; margin-bottom:var(--spacing-md); -webkit-overflow-scrolling: touch;}
.table{width:auto; min-width:100%; border-collapse:collapse; font-size:clamp(12px, 3.5vw, 14px);}
.table th,.table td{padding:var(--spacing-sm) var(--spacing-md); border-bottom:1px solid var(--border); white-space:nowrap;} /* No-wrap for mobile */
.table th{color:var(--muted); background:#151936; text-align:left; position:sticky; top:0; z-index:1; font-weight:600;}
.table tr:hover td{background:#14183a;}
.table a{ color:var(--focus); text-decoration:none; } .table a:hover{text-decoration:underline;}
/* Bottom App Nav - Mobile Optimized */
.navbar{ 
  position:fixed; 
  left:0; 
  right:0; 
  bottom:0; 
  z-index:24; 
  backdrop-filter: blur(10px); 
  background:linear-gradient(0deg, rgba(17,21,42,.95), rgba(17,21,42,.85)); 
  border-top:1px solid var(--border); 
  padding-bottom:env(safe-area-inset-bottom); 
}
.nav{ display:flex; justify-content:space-around; align-items:center; padding:var(--spacing-sm) var(--spacing-md); gap:var(--spacing-sm); }
.nav button{ 
  flex:1; 
  margin:0 var(--spacing-xs); 
  padding:var(--spacing-md) var(--spacing-sm); 
  background:none; 
  border:none; 
  color:var(--muted); 
  font-size:clamp(11px, 3vw, 12px); 
  cursor:pointer; 
  border-radius:12px; 
  display:flex; 
  flex-direction:column; 
  gap:var(--spacing-xs); 
  align-items:center; 
  transition:background .1s ease; 
  min-height:44px; /* Touch target */
}
.nav .ico{font-size:clamp(18px, 5vw, 20px);}
.nav button.active{ color:var(--text); background:rgba(59,130,246,.14); border:1px solid var(--border); }
/* Views */
.view{display:none} .view.active{display:block}
/* MultiSelect - Mobile */
.ms{ position:relative; min-width:200px; max-width:100%; background:#0f1330; border:1px solid var(--border); border-radius:12px; padding:var(--spacing-sm); cursor:text; font-size:14px; }
.ms:focus-within{ outline:2px solid var(--focus); outline-offset:2px; }
.ms-inner{ display:flex; align-items:center; gap:var(--spacing-xs); flex-wrap:wrap }
.ms-tags{ display:flex; gap:var(--spacing-xs); flex-wrap:wrap; align-items:center; }
.ms-tag{ display:inline-flex; align-items:center; gap:var(--spacing-xs); background:var(--chip); border:1px solid var(--border); border-radius:999px; padding:var(--spacing-sm) var(--spacing-md); font-size:12px; white-space:nowrap; max-width:calc(100% - 40px); overflow:hidden; text-overflow:ellipsis; }
.ms-tag button{ background:none; border:0; color:var(--muted); cursor:pointer; padding:0 0 0 var(--spacing-xs); line-height:1; font-size:16px; min-width:20px; }
.ms-input{ flex:1 0 60px; min-width:60px; border:0; outline:0; background:transparent; color:var(--text); padding:var(--spacing-sm) var(--spacing-xs); font:inherit; font-size:14px; }
.ms-actions{ display:flex; align-items:center; gap:var(--spacing-xs); margin-left:auto; flex-shrink:0;}
.ms-icon{ background:none; border:0; color:var(--muted); cursor:pointer; padding:var(--spacing-xs); line-height:1; font-size:14px; min-width:24px; }
.ms-list{ position:absolute; top:100%; left:0; right:0; margin-top:var(--spacing-sm); background:#14183a; border:1px solid var(--border); border-radius:12px; padding:var(--spacing-sm) 0; max-height:50vh; overflow:auto; box-shadow:var(--shadow); display:none; z-index:30; }
.ms.open .ms-list{ display:block }
.ms-group{ padding:var(--spacing-md) var(--spacing-lg); font-size:12px; color:var(--muted); font-weight:500; }
.ms-option{ padding:var(--spacing-md) var(--spacing-lg); cursor:pointer; font-size:14px; }
.ms-option[aria-selected="true"]{ color:#9cc3ff; background:rgba(59,130,246,.1); }
.ms-option:hover, .ms-option.active{ background:#172058; }
.ms-empty{ padding:var(--spacing-md) var(--spacing-lg); color:var(--muted); text-align:center; }
/* Generic Modal - Slide from Top on Mobile */
.modal-bg{ 
  position:fixed; 
  inset:0; 
  background:rgba(0,0,0,.5); 
  display:none; 
  align-items:flex-start; 
  justify-content:center; 
  z-index:40; 
  padding-top:env(safe-area-inset-top); 
}
.modal-content{ 
  width:100%; 
  max-width:600px; /* Narrower on mobile */
  max-height:90vh; 
  background:var(--bg-elev); 
  border:1px solid var(--border); 
  border-radius:0 0 16px 16px; /* Rounded bottom */
  padding:var(--spacing-lg); 
  overflow:auto; 
  position:relative; 
  box-shadow:var(--shadow); 
  transform:translateY(-100%); /* Start off-screen top */
  opacity:0; 
  transition:transform .3s cubic-bezier(0.25,0.46,0.45,0.94), opacity .3s ease; /* Smooth slide */
}
.modal-bg.show{display:flex; align-items:flex-start;}
.modal-bg.show .modal-content{transform:translateY(0); opacity:1;}
@media (min-width:768px){
  .modal-content{border-radius:16px; transform:translateY(20px); max-width:900px; max-height:92vh;}
  .modal-bg.show .modal-content{transform:translateY(0);}
}
.modal-header{display:flex; align-items:center; justify-content:space-between; gap:var(--spacing-md); position:sticky; top:0; background:var(--bg-elev); padding-bottom:var(--spacing-sm); margin:-var(--spacing-lg) -var(--spacing-lg) var(--spacing-md); padding:var(--spacing-md) var(--spacing-lg); border-bottom:1px solid var(--border); border-radius:0 0 16px 16px;}
.modal-title{font-size:clamp(16px, 4vw, 18px); font-weight:700;}
.modal-actions{display:flex; gap:var(--spacing-sm);}
.btn{ 
  border:1px solid var(--border); 
  background:var(--card); 
  color:var(--text); 
  padding:var(--spacing-sm) var(--spacing-md); 
  border-radius:10px; 
  cursor:pointer; 
  font-size:14px; 
  min-height:36px; 
  transition:background .1s ease; 
}
.btn.primary{ background:var(--focus); color:#fff; border-color:transparent; }
.btn.ghost{ background:none; color:var(--muted); }
.btn:active{opacity:0.9;}
/* FAB - Mobile Safe */
.fab{ 
  position:fixed; 
  right:var(--spacing-lg); 
  bottom:calc(80px + env(safe-area-inset-bottom)); 
  width:56px; 
  height:56px; 
  border-radius:999px; 
  background:var(--focus); 
  color:#fff; 
  display:grid; 
  place-items:center; 
  border:none; 
  box-shadow:var(--shadow); 
  cursor:pointer; 
  font-size:24px; 
  z-index:10; 
  transition:transform .1s ease; 
}
.fab:active{transform:scale(.95);}
/* Footer - Hide on Desktop, Show on Mobile */
.foot{display:none; color:var(--muted); text-align:center; padding:var(--spacing-lg);}
@media (max-width:768px){.foot{display:block;}}
/* Mobile-Specific Adjustments */
@media (max-width:768px){
  .wrap{margin:var(--spacing-md) var(--spacing-sm); padding:0;}
  .top{padding:var(--spacing-sm) var(--spacing-md);}
  .brand .logo{font-size:10px;}
  .cards{grid-template-columns:1fr; gap:var(--spacing-md);}
  .grid{gap:var(--spacing-md);}
  .panel{padding:var(--spacing-md); margin-bottom:var(--spacing-md);}
  .table{font-size:12px;}
  .table th,.table td{padding:var(--spacing-xs) var(--spacing-sm);}
  .nav{padding:var(--spacing-md);}
  .nav button{padding:var(--spacing-sm) var(--spacing-xs); min-height:48px;}
  .ms{min-width:100%; max-width:100%;}
  .ms-tag{max-width:calc(100% - 50px);}
  .modal-content{max-width:100%; height:100vh; border-radius:0; margin-top:env(safe-area-inset-top);}
  .modal-header{margin:-var(--spacing-md) -var(--spacing-md) var(--spacing-md); padding:var(--spacing-md);}
  .fab{bottom:calc(80px + env(safe-area-inset-bottom)); right:var(--spacing-md);}
}
/* Landscape Mobile */
@media (max-height:500px) and (orientation:landscape){
  .modal-content{max-height:100vh;}
  .ms-list{max-height:40vh;}
}
/* High DPI Displays */
@media (-webkit-min-device-pixel-ratio:2), (min-resolution:192dpi){
  .icon-btn{width:44px; height:44px;}
}
</style>
</head>
<body>
<header class="top" role="banner">
  <div class="brand"><div class="logo">DP</div><h1 id="page-title">Driver Prep</h1></div>
  <div class="actions" id="top-actions">
    <!-- Dynamic content set by JS -->
  </div>
</header>
<main class="wrap" role="main">
  <div id="view-prep" class="view active">
    <section class="cards" aria-label="KPIs">
      <div class="card"><div class="card-title">Total Pre-orders (lbs)</div><div class="kpi" id="kpi-total-lbs">‚Äî</div></div>
      <div class="card"><div class="card-title">Items / Orders</div><div class="kpi" id="kpi-orders">‚Äî</div></div>
      <div class="card"><div class="card-title">Total Value ($)</div><div class="kpi" id="kpi-total-value">‚Äî</div></div>
    </section>
    <section class="grid">
      <div class="panel">
        <h3>What to Load (lbs)</h3>
        <!-- Walk-in buffer -->
        <div class="card" style="margin:0 0 var(--spacing-md) 0">
          <label style="display:block; font-size:14px; margin-bottom:var(--spacing-sm);">Walk-in buffer
            <div style="display:flex; align-items:center; gap:var(--spacing-md); margin-top:var(--spacing-sm)">
              <input id="buffer" type="range" min="0" max="30" value="10" style="flex:1; -webkit-appearance:none; height:4px; background:var(--border); border-radius:2px;">
              <span id="buffer-val" style="min-width:40px; text-align:center; font-weight:600;">10%</span>
            </div>
          </label>
        </div>
        <div class="table-wrap">
          <table class="table" id="fruit-table">
            <thead><tr><th>Fruit</th><th>Pre-orders (lbs)</th><th>+ Buffer</th><th>Total to Load</th></tr></thead>
            <tbody><!-- rows --></tbody>
          </table>
        </div>
        <canvas id="fruit-chart" style="max-height: 250px; width:100%;"></canvas>
      </div>
      <div class="panel">
        <h3>Stops (matched to filters)</h3>
        <div class="table-wrap">
          <table class="table" id="stops-table">
            <thead><tr><th>City</th><th>Arrival</th><th>Departure</th><th>Orders</th><th>lbs</th><th>Value ($)</th><th>Top Items</th></tr></thead>
            <tbody><!-- rows --></tbody>
          </table>
        </div>
      </div>
    </section>
    <div class="panel">
      <h3>Customers (matched to filters)</h3>
      <div class="table-wrap">
        <table class="table" id="customers-table">
          <thead><tr><th>Customer</th><th>Orders</th><th>Total lbs</th><th>Total Value ($)</th><th>Cities</th><th>Top Items</th></tr></thead>
          <tbody><!-- rows --></tbody>
        </table>
      </div>
    </div>
  </div>
  <div id="view-customers" class="view">
    <div class="panel">
      <h3>Contacts</h3>
      <div class="table-wrap">
        <table class="table" id="contacts-table">
          <thead><tr><th>Name</th><th>Type</th><th>Email</th><th>Phone</th></tr></thead>
          <tbody><!-- rows --></tbody>
        </table>
      </div>
    </div>
  </div>
</main>
<footer class="navbar" role="navigation" aria-label="Bottom Navigation">
  <nav class="nav">
    <button id="nav-prep" class="active" aria-current="page"><span class="ico">üì¶</span><span>Driver Prep</span></button>
    <button id="nav-customers"><span class="ico">üë•</span><span>Customers</span></button>
  </nav>
</footer>
<button id="fab-prep" class="fab" title="Open Driver Prep">üì¶</button>
<!-- Driver Prep Modal -->
<div id="prep-modal" class="modal-bg" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="prep-title">
    <div class="modal-header">
      <div class="modal-title" id="prep-title">Driver Prep</div>
      <div class="modal-actions">
        <button id="btn-print" class="btn">Print</button>
        <button id="btn-export" class="btn">Export</button>
        <button data-close="prep-modal" class="btn ghost" type="button">Close</button>
      </div>
    </div>
    <div id="prep-body" class="modal-body"><!-- filled via JS --></div>
  </div>
</div>
<!-- Prep Filters Modal -->
<div id="filter-modal" class="modal-bg" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="filter-title">
    <div class="modal-header">
      <div class="modal-title" id="filter-title">Driver Prep Filters</div>
      <div class="modal-actions">
        <button data-close="filter-modal" class="btn ghost" type="button">Close</button>
      </div>
    </div>
    <div class="modal-body">
      <div class="panel" style="margin:0">
        <div class="cards" style="grid-template-columns:1fr; gap:var(--spacing-md)">
          <label class="card">Date
            <input id="filter-date" type="date" style="margin-top:var(--spacing-sm); width:100%; background:#0f1330; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:var(--spacing-md); font-size:14px">
          </label>
          <label class="card">Province
            <select id="filter-province" style="margin-top:var(--spacing-sm); width:100%; background:#0f1330; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:var(--spacing-md); font-size:14px">
              <option value="">All</option>
              <option>British Columbia</option>
              <option>Alberta</option>
              <option>Saskatchewan</option>
              <option>Manitoba</option>
              <option>Ontario</option>
              <option>NWT/Yukon</option>
            </select>
          </label>
          <label class="card">City
            <select id="filter-city" style="margin-top:var(--spacing-sm); width:100%; background:#0f1330; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:var(--spacing-md); font-size:14px"></select>
          </label>
          <label class="card" style="align-items:stretch">Fruits
            <div id="fruit-ms" class="ms" role="combobox" aria-haspopup="listbox" aria-expanded="false" style="margin-top:var(--spacing-sm)">
              <div class="ms-inner">
                <div class="ms-tags" aria-live="polite" aria-relevant="additions removals"></div>
                <input class="ms-input" type="text" placeholder="Type to search‚Ä¶" aria-autocomplete="list" />
                <div class="ms-actions">
                  <button class="ms-icon ms-clear" title="Clear selection" aria-label="Clear selection">√ó</button>
                  <button class="ms-icon ms-caret" title="Toggle" aria-label="Toggle">‚ñæ</button>
                </div>
              </div>
              <div class="ms-list" role="listbox"></div>
            </div>
          </label>
        </div>
        <div style="display:flex; gap:var(--spacing-sm); justify-content:flex-end; margin-top:var(--spacing-lg)">
          <button id="filters-reset" class="btn">Reset</button>
          <button id="filters-apply" class="btn primary">Apply</button>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Customer Filters Modal -->
<div id="cust-filter-modal" class="modal-bg" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="cust-filter-title">
    <div class="modal-header">
      <div class="modal-title" id="cust-filter-title">Customer Filters</div>
      <div class="modal-actions">
        <button data-close="cust-filter-modal" class="btn ghost" type="button">Close</button>
      </div>
    </div>
    <div class="modal-body">
      <div class="panel" style="margin:0">
        <div class="cards" style="grid-template-columns:1fr; gap:var(--spacing-md)">
          <label class="card">Province
            <select id="cust-filter-province" style="margin-top:var(--spacing-sm); width:100%; background:#0f1330; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:var(--spacing-md); font-size:14px">
              <option value="">All Provinces</option>
            </select>
          </label>
          <label class="card">City
            <select id="cust-filter-city" style="margin-top:var(--spacing-sm); width:100%; background:#0f1330; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:var(--spacing-md); font-size:14px">
              <option value="">All Cities</option>
            </select>
          </label>
        </div>
        <div style="display:flex; gap:var(--spacing-sm); justify-content:flex-end; margin-top:var(--spacing-lg)">
          <button id="cust-filters-reset" class="btn">Reset</button>
          <button id="cust-filters-apply" class="btn primary">Apply</button>
        </div>
      </div>
    </div>
  </div>
</div>
<footer class="foot">PWA demo. Install to home screen for app feel. Works offline after first load.</footer>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
/*********** LIVE DATA LOADER (Google Sheets via Apps Script) ***********/
const API_URL = 'YOUR_APPS_SCRIPT_WEB_APP_URL'; // e.g., https://script.google.com/macros/s/XXXX/exec
let contacts = [];
let fruitPrices = {};
let fruitsByGroup = {};
let cities = [];
let orders = [];
// load data (network-first). fall back to localStorage if offline.
async function loadData() {
  const res = await fetch(`${API_URL}?t=all`, { cache: 'no-store' });
  if (!res.ok) throw new Error('HTTP ' + res.status);
  const data = await res.json();
  applyData(data);
  localStorage.setItem('driverprep-cache', JSON.stringify(data));
}
function applyData(data){
  contacts = data.contacts || [];
  fruitPrices = data.fruitPrices || {};
  fruitsByGroup = data.fruitsByGroup || {};
  cities = data.cities || [];
  orders = data.orders || [];
}
/*********** HELPERS + STATE ***********/
const $=sel=>document.querySelector(sel);
const fmtLbs=n=>`${Number(n||0).toLocaleString()} lbs`;
const fmtDollar=n=>`$${Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}`;
const todayISO=new Date().toISOString().slice(0,10);
const uniqueCitiesFor=(province,date)=>{const set=new Set(cities.filter(c=>(!province||c.province===province)&&(!date||String(c.date)===String(date))).map(c=>c.city));return ["All",...Array.from(set)].map(n=>({label:n,value:n==="All"?"":n}))};
const state={date:todayISO,province:"",city:"",bufferPct:10,fruits:[]};
// Customer-specific state for filters
const custState = { search: '', province: '', city: '' };
let fruitChart; let currentView='prep';
let isMobile = window.innerWidth <= 768;
/*********** MODALS ***********/
function showModal(id){ 
  const bg=document.getElementById(id); 
  bg.classList.add('show'); 
  bg.setAttribute('aria-hidden','false');
  if (isMobile && bg.querySelector('.modal-content')) {
    // Ensure slide animation on mobile
    bg.querySelector('.modal-content').style.transform = 'translateY(-100%)';
    setTimeout(() => { bg.querySelector('.modal-content').style.transform = 'translateY(0)'; }, 10);
  }
}
function hideModal(id){ 
  const bg=document.getElementById(id); 
  bg.classList.remove('show'); 
  bg.setAttribute('aria-hidden','true');
}
/*********** DRIVER PREP MODAL CONTENT ***********/
function openDriverPrepModal(){
  const ord=getFilteredOrders();
  const fruitAgg=aggregateByFruit(ord);
  const totalLbs=Object.values(fruitAgg).reduce((s,n)=>s+n,0);
  const totalValue=ord.reduce((sum,o)=>sum+o.items.reduce((s,it)=>s+((!state.fruits.length||state.fruits.includes(it.fruit))?it.lbs*(fruitPrices[it.fruit]||0):0),0),0);
  const stops=aggregateStops(ord);
  const rowsFruit=Object.keys(fruitAgg).map(name=>{
    const pre=fruitAgg[name]; const add=Math.round(pre*state.bufferPct/100); const total=pre+add;
    return `<tr><td>${name}</td><td>${fmtLbs(pre)}</td><td>${fmtLbs(add)}</td><td><strong>${fmtLbs(total)}</strong></td></tr>`;
  }).join("");
  const rowsStops=stops.map(s=>`
    <tr><td>${s.city}</td><td>${s.arrive||"‚Äî"}</td><td>${s.depart||"‚Äî"}</td><td>${s.orders}</td><td>${fmtLbs(s.lbs)}</td><td>${fmtDollar(s.value)}</td><td>${(s.topItems||[]).join(", ")||"‚Äî"}</td></tr>
  `).join("");
  const filtersBadge=`
    <div class="kpi" style="font-size:14px; color:var(--muted); display:flex; flex-wrap:wrap; gap:var(--spacing-sm); padding:var(--spacing-sm); background:var(--bg-elev); border-radius:8px; margin-bottom:var(--spacing-md);">
      <span>üìÖ ${state.date||'All'}</span>
      <span>‚Ä¢ üèûÔ∏è ${state.province||'All provinces'}</span>
      <span>‚Ä¢ üèôÔ∏è ${state.city||'All cities'}</span>
      <span>‚Ä¢ üßÆ Buffer ${state.bufferPct}%</span>
      ${state.fruits.length? `<span>‚Ä¢ üçì ${state.fruits.join(', ')}</span>`:''}
    </div>`;
  const html=`
    ${filtersBadge}
    <section class="cards" style="margin-top:var(--spacing-md); grid-template-columns:repeat(auto-fit, minmax(200px,1fr))">
      <div class="card"><div class="card-title">Total Pre-orders (lbs)</div><div class="kpi">${fmtLbs(totalLbs)}</div></div>
      <div class="card"><div class="card-title">Orders</div><div class="kpi">${ord.length}</div></div>
      <div class="card"><div class="card-title">Total Value</div><div class="kpi">${fmtDollar(totalValue)}</div></div>
    </section>
    <div class="panel" style="margin-top:var(--spacing-lg)">
      <h3>What to Load (with Buffer)</h3>
      <div class="table-wrap"><table class="table">
        <thead><tr><th>Fruit</th><th>Pre-orders</th><th>+ Buffer</th><th>Total to Load</th></tr></thead>
        <tbody>${rowsFruit || `<tr><td colspan="4" style="text-align:center; color:var(--muted);">No items</td></tr>`}</tbody>
      </table></div>
    </div>
    <div class="panel">
      <h3>Stops</h3>
      <div class="table-wrap"><table class="table">
        <thead><tr><th>City</th><th>Arrival</th><th>Departure</th><th>Orders</th><th>lbs</th><th>Value</th><th>Top Items</th></tr></thead>
        <tbody>${rowsStops || `<tr><td colspan="7" style="text-align:center; color:var(--muted);">No stops</td></tr>`}</tbody>
      </table></div>
    </div>
  `;
  document.getElementById('prep-body').innerHTML=html;
  showModal('prep-modal');
}
/*********** CUSTOMER MODAL ENHANCEMENT ***********/
document.addEventListener("click",e=>{
  if(e.target.tagName==="A" && e.target.dataset.contId){
    e.preventDefault();
    const id=Number(e.target.dataset.contId);
    const cont=contacts.find(c=>c.id===id);
    if(!cont) return;
    const custOrders = orders.filter(o => o.customerId === id).sort((a, b) => new Date(b.date) - new Date(a.date));
    const totalLbs = custOrders.reduce((sum, o) => sum + o.items.reduce((s, it) => s + Number(it.lbs || 0), 0), 0);
    const totalValue = custOrders.reduce((sum, o) => sum + o.items.reduce((s, it) => s + Number(it.lbs || 0) * (fruitPrices[it.fruit] || 0), 0), 0);
    const numOrders = custOrders.length;
    let html = `<div class="panel" style="margin:0"><h3 style="margin-top:0; font-size:clamp(16px,4vw,18px);">${cont.name}</h3>
      <p style="margin:var(--spacing-sm) 0;"><strong>Email:</strong> ${cont.email || '‚Äî'}</p>
      <p style="margin:var(--spacing-sm) 0;"><strong>Phone:</strong> ${cont.phone || '‚Äî'}</p>
      <p style="margin:var(--spacing-sm) 0;"><strong>Address:</strong> ${cont.address || '‚Äî'}</p>
    `;
    if (cont.type === 'lead') {
      html += `<div style="margin-top:var(--spacing-md);color:var(--muted); padding:var(--spacing-sm); background:var(--bg-elev); border-radius:8px;">This is a lead. No orders yet.</div>`;
    } else if (numOrders > 0) {
      html += `
        <div class="panel" style="margin-top:var(--spacing-lg)">
          <h3>Order History</h3>
          <section class="cards" style="margin-bottom:var(--spacing-md); grid-template-columns:repeat(auto-fit, minmax(150px,1fr))">
            <div class="card"><div class="card-title">Total Orders</div><div class="kpi">${numOrders}</div></div>
            <div class="card"><div class="card-title">Total lbs</div><div class="kpi">${fmtLbs(totalLbs)}</div></div>
            <div class="card"><div class="card-title">Total Value</div><div class="kpi">${fmtDollar(totalValue)}</div></div>
          </section>
          <div class="table-wrap">
            <table class="table">
              <thead><tr><th>Date</th><th>City</th><th>Total lbs</th><th>Total Value ($)</th><th>Line Items</th></tr></thead>
              <tbody>
      `;
      custOrders.forEach(o => {
        const oLbs = o.items.reduce((s, it) => s + Number(it.lbs || 0), 0);
        const oValue = o.items.reduce((s, it) => s + Number(it.lbs || 0) * (fruitPrices[it.fruit] || 0), 0);
        const itemsStr = o.items.map(it => `${it.fruit} ${fmtLbs(it.lbs)}`).join(', ');
        html += `<tr><td>${o.date}</td><td>${o.city}</td><td>${fmtLbs(oLbs)}</td><td>${fmtDollar(oValue)}</td><td style="white-space: normal; max-width: 200px; word-break:break-word;">${itemsStr}</td></tr>`;
      });
      html += `</tbody></table></div></div>`;
    } else {
      html += `<div style="margin-top:var(--spacing-md);color:var(--muted); padding:var(--spacing-sm); background:var(--bg-elev); border-radius:8px;">No orders yet.</div>`;
    }
    html += `</div>`;
    document.getElementById('prep-body').innerHTML=html;
    document.getElementById('prep-title').textContent='Customer Details';
    showModal('prep-modal');
  }
});
/*********** MULTISELECT ***********/
class MultiSelect {
  constructor(root,groups,{placeholder="Type to search‚Ä¶",onChange=()=>{}}={}){
    this.root=root; this.groups=groups; this.onChange=onChange; this.value=new Set();
    this.tagsEl=root.querySelector(".ms-tags"); this.inputEl=root.querySelector(".ms-input");
    this.listEl=root.querySelector(".ms-list"); this.clearBtn=root.querySelector(".ms-clear"); this.caretBtn=root.querySelector(".ms-caret");
    this.inputEl.placeholder=placeholder;
    root.addEventListener("click",()=>this.open());
    this.caretBtn.addEventListener("click",(e)=>{e.stopPropagation();this.toggle()});
    this.clearBtn.addEventListener("click",(e)=>{e.preventDefault();e.stopPropagation();this.clear()});
    this.inputEl.addEventListener("input",()=>this.renderList());
    this.inputEl.addEventListener("keydown",(e)=>this.handleKeys(e));
    document.addEventListener("click",(e)=>{if(!root.contains(e.target))this.close()});
    this.renderList(); this.renderTags();
  }
  get selected(){return Array.from(this.value)}
  set selected(arr){this.value=new Set(arr); this.renderTags(); this.renderList(); this.onChange(this.selected)}
  open(){this.root.classList.add("open"); this.root.setAttribute("aria-expanded","true"); this.inputEl.focus(); this.renderList()}
  close(){this.root.classList.remove("open"); this.root.setAttribute("aria-expanded","false")}
  toggle(){this.root.classList.contains("open")?this.close():this.open()}
  clear(){this.value.clear(); this.renderTags(); this.renderList(); this.onChange(this.selected)}
  handleKeys(e){
    const active=this.listEl.querySelector(".ms-option.active");
    if(e.key==="ArrowDown"){e.preventDefault();const opts=[...this.listEl.querySelectorAll(".ms-option")];const i=Math.max(0,opts.indexOf(active)+1);opts.forEach(o=>o.classList.remove("active")); if(opts[i])opts[i].classList.add("active");return}
    if(e.key==="ArrowUp"){e.preventDefault();const opts=[...this.listEl.querySelectorAll(".ms-option")];const i=Math.max(0,(opts.indexOf(active)<=0?0:opts.indexOf(active)-1));opts.forEach(o=>o.classList.remove("active")); if(opts[i])opts[i].classList.add("active");return}
    if(e.key==="Enter"){const target=active||this.listEl.querySelector(".ms-option"); if(target){e.preventDefault(); this.toggleItem(target.dataset.value)} return}
    if(e.key==="Backspace" && !this.inputEl.value && this.value.size){const last=[...this.value].pop(); this.value.delete(last); this.renderTags(); this.renderList(); this.onChange(this.selected)}
  }
  toggleItem(val){ if(this.value.has(val))this.value.delete(val); else this.value.add(val);
    this.inputEl.value=""; this.renderTags(); this.renderList(); this.onChange(this.selected); this.open() }
  renderTags(){ this.tagsEl.innerHTML=""; if(!this.value.size)return; this.selected.forEach(v=>{const tag=document.createElement("span"); tag.className="ms-tag"; tag.innerHTML=`${v} <button aria-label="Remove ${v}">√ó</button>`; tag.querySelector("button").addEventListener("click",(e)=>{e.stopPropagation(); this.toggleItem(v)}); this.tagsEl.appendChild(tag)})}
  renderList(){ const q=this.inputEl.value.trim().toLowerCase(); this.listEl.innerHTML=""; let any=false;
    Object.entries(this.groups||{}).forEach(([title,items])=>{const matches=(items||[]).filter(x=>String(x).toLowerCase().includes(q)); if(!matches.length)return;
      const g=document.createElement("div"); g.className="ms-group"; g.textContent=title; this.listEl.appendChild(g);
      matches.forEach(v=>{any=true; const opt=document.createElement("div"); opt.className="ms-option"; opt.setAttribute("role","option"); opt.dataset.value=v; opt.setAttribute("aria-selected",this.value.has(v)?"true":"false"); opt.textContent=v;
        opt.addEventListener("click",(e)=>{e.stopPropagation(); this.toggleItem(v)});
        opt.addEventListener("mouseenter",()=>{[...this.listEl.querySelectorAll(".ms-option")].forEach(o=>o.classList.remove("active")); opt.classList.add("active")});
        this.listEl.appendChild(opt)})});
    if(!any){const empty=document.createElement("div"); empty.className="ms-empty"; empty.textContent="No results"; this.listEl.appendChild(empty)}
  }
}
/*********** VIEW + RENDER ***********/
function switchView(viewName){
  if(currentView===viewName)return;
  currentView=viewName;
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
  document.getElementById(`view-${viewName}`).classList.add('active');
  document.getElementById(`nav-${viewName}`).classList.add('active');
  // Update header title and actions
  const titleEl = document.getElementById('page-title');
  const actionsEl = document.getElementById('top-actions');
  if(viewName === 'prep'){
    titleEl.textContent = 'Driver Prep';
    actionsEl.innerHTML = `
      <button id="btn-filter" class="icon-btn" title="Driver Prep Filters">‚öôÔ∏è</button>
      <button id="btn-prep" class="icon-btn" title="Open Prep Modal">üì¶</button>
    `;
    // Re-attach listeners
    document.getElementById('btn-filter').addEventListener("click",()=>showModal('filter-modal'));
    document.getElementById('btn-prep').addEventListener("click",openDriverPrepModal);
  } else {
    titleEl.textContent = 'Customers';
    actionsEl.innerHTML = `
      <input type="search" id="header-cust-search" class="header-search" placeholder="Search customers..." value="${custState.search}">
      <button id="btn-cust-filter" class="icon-btn" title="Customer Filters">‚öôÔ∏è</button>
    `;
    // Re-attach listeners
    document.getElementById('header-cust-search').addEventListener('input', e => {
      custState.search = e.target.value.trim();
      renderCustomers();
    });
    document.getElementById('btn-cust-filter').addEventListener("click",()=>showModal('cust-filter-modal'));
  }
  if(viewName==='prep'){renderPrep()} else {renderCustomers()}
}
function getFilteredOrders(){
  return (orders||[]).filter(o =>
    (!state.date || String(o.date)===String(state.date)) &&
    (!state.province || o.province===state.province) &&
    (!state.city || o.city===state.city) &&
    (state.fruits.length===0 || (o.items||[]).some(it=>state.fruits.includes(it.fruit)))
  );
}
// Customer filter helpers
function getUniqueProvinces() {
  return [...new Set(contacts.filter(c => c.type === 'customer').map(c => {
    const parts = (c.address || '').split(',');
    return parts.length > 1 ? parts[1].trim() : '';
  }).filter(p => p))].sort();
}
function getUniqueCitiesForProvince(province) {
  const set = new Set();
  contacts.filter(c => c.type === 'customer' && (!province || c.address.includes(province))).forEach(c => {
    const parts = (c.address || '').split(',');
    if (parts.length > 0) set.add(parts[0].trim());
  });
  return [...set].sort();
}
function filterCustomers() {
  return contacts.filter(c => c.type === 'customer' && // Only customers
    (!custState.search || 
      c.name.toLowerCase().includes(custState.search.toLowerCase()) ||
      (c.email || '').toLowerCase().includes(custState.search.toLowerCase())
    ) &&
    (!custState.province || c.address.includes(custState.province)) &&
    (!custState.city || c.address.startsWith(custState.city + ','))
  ).sort((a, b) => a.name.localeCompare(b.name));
}
function aggregateByFruit(ord){
  const agg={}; (ord||[]).forEach(o=>(o.items||[]).forEach(it=>{ if(!state.fruits.length || state.fruits.includes(it.fruit)){ agg[it.fruit]=(agg[it.fruit]||0)+Number(it.lbs||0) }}));
  return agg;
}
function aggregateStops(ord){
  const map=new Map();
  (ord||[]).forEach(o=>{
    const key=o.city;
    const filtered=(o.items||[]).filter(it=>!state.fruits.length||state.fruits.includes(it.fruit));
    const lbs=filtered.reduce((s,it)=>s+Number(it.lbs||0),0);
    const value=filtered.reduce((s,it)=>s+Number(it.lbs||0)*(Number(fruitPrices[it.fruit])||0),0);
    const entry=map.get(key)||{city:key,orders:0,lbs:0,value:0,arrive:"",depart:"",topItems:[]};
    entry.orders+=1; entry.lbs+=lbs; entry.value+=value;
    const sched=(cities||[]).find(c=>c.city===o.city && String(c.date)===String(o.date))||{};
    entry.arrive=sched.arrive||""; entry.depart=sched.depart||"";
    entry.topItems=Array.from(new Set([...(entry.topItems), ...filtered.map(i=>i.fruit)]));
    map.set(key,entry);
  });
  return Array.from(map.values()).sort((a,b)=>b.value-a.value);
}
function aggregateCustomers(ord){
  const map=new Map();
  (ord||[]).forEach(o=>{
    const custId=o.customerId;
    const custData=(contacts||[]).find(c=>Number(c.id)===Number(custId) && c.type==='customer'); if(!custData)return;
    const entry=map.get(custId)||{...custData,orders:0,lbs:0,value:0,cities:[],topItems:[]};
    entry.orders+=1;
    const filtered=(o.items||[]).filter(it=>!state.fruits.length||state.fruits.includes(it.fruit));
    entry.lbs+=filtered.reduce((s,it)=>s+Number(it.lbs||0),0);
    entry.value+=filtered.reduce((s,it)=>s+Number(it.lbs||0)*(Number(fruitPrices[it.fruit])||0),0);
    entry.cities.push(o.city); entry.topItems.push(...filtered.map(i=>i.fruit));
    map.set(custId,entry);
  });
  return Array.from(map.values()).map(c=>{c.cities=[...new Set(c.cities)]; c.topItems=[...new Set(c.topItems)]; return c}).sort((a,b)=>b.value-a.value);
}
function renderPrep(){
  const ord=getFilteredOrders();
  const fruitAgg=aggregateByFruit(ord);
  const totalLbs=Object.values(fruitAgg).reduce((s,n)=>s+n,0);
  const totalValue=ord.reduce((sum,o)=>sum+o.items.reduce((s,it)=>s+((!state.fruits.length||state.fruits.includes(it.fruit))?Number(it.lbs||0)*(Number(fruitPrices[it.fruit])||0):0),0),0);
  $('#kpi-total-lbs').textContent=fmtLbs(totalLbs);
  $('#kpi-orders').textContent=`${ord.length} orders`;
  $('#kpi-total-value').textContent=fmtDollar(totalValue);
  // Fruit table + chart
  const tbody=$("#fruit-table tbody"); tbody.innerHTML="";
  const labels=Object.keys(fruitAgg); const data=labels.map(k=>fruitAgg[k]);
  labels.forEach(name=>{
    const pre=fruitAgg[name]; const add=Math.round(pre*state.bufferPct/100); const total=pre+add;
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${name}</td><td>${fmtLbs(pre)}</td><td>${fmtLbs(add)}</td><td><strong>${fmtLbs(total)}</strong></td>`;
    tbody.appendChild(tr);
  });
  if(window.fruitChart)fruitChart.destroy();
  const ctx=document.getElementById("fruit-chart");
  fruitChart=new Chart(ctx,{
    type:"bar", 
    data:{labels,datasets:[{label:"Pre-orders (lbs)",data,backgroundColor:'#3b82f6', borderRadius:4}]}, 
    options:{ 
      responsive:true, 
      maintainAspectRatio:false,
      plugins:{legend:{display:false}}, 
      scales:{y:{beginAtZero:true, ticks:{color:var(--muted)}}},
      animation:{duration:300}
    }
  });
  // Stops
  const stops=aggregateStops(ord);
  const tb2=$("#stops-table tbody"); tb2.innerHTML="";
  stops.forEach(s=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${s.city}</td><td>${s.arrive||"‚Äî"}</td><td>${s.depart||"‚Äî"}</td><td>${s.orders}</td><td>${fmtLbs(s.lbs)}</td><td>${fmtDollar(s.value)}</td><td>${(s.topItems||[]).join(", ")||"‚Äî"}</td>`;
    tb2.appendChild(tr);
  });
  // Customers
  const custs=aggregateCustomers(ord);
  const tb3=$("#customers-table tbody"); tb3.innerHTML="";
  custs.forEach(c=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td><a href="#" data-cont-id="${c.id}">${c.name}</a></td><td>${c.orders}</td><td>${fmtLbs(c.lbs)}</td><td>${fmtDollar(c.value)}</td><td>${c.cities.join(", ")||"‚Äî"}</td><td>${c.topItems.join(", ")||"‚Äî"}</td>`;
    tb3.appendChild(tr);
  });
}
function renderCustomers(){
  // Populate province select in modal if needed
  const provSelect = $('#cust-filter-province');
  if (provSelect.children.length === 1) { // Only "All" exists
    getUniqueProvinces().forEach(p => {
      const opt = document.createElement('option');
      opt.value = p;
      opt.textContent = p;
      provSelect.appendChild(opt);
    });
  }
  // Populate city select based on province in modal
  const citySelect = $('#cust-filter-city');
  citySelect.innerHTML = '<option value="">All Cities</option>';
  if (custState.province) {
    getUniqueCitiesForProvince(custState.province).forEach(city => {
      const opt = document.createElement('option');
      opt.value = city;
      opt.textContent = city;
      citySelect.appendChild(opt);
    });
  }
  // Render filtered customers
  const filtered = filterCustomers();
  const tb=$("#contacts-table tbody"); tb.innerHTML="";
  filtered.forEach(c=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td><a href="#" data-cont-id="${c.id}">${c.name}</a></td><td>${c.type}</td><td>${c.email}</td><td>${c.phone||'‚Äî'}</td>`;
    tb.appendChild(tr);
  });
  // If no results
  if (filtered.length === 0) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="4" style="text-align:center; color:var(--muted); padding:var(--spacing-lg);">No customers match the filters.</td>`;
    tb.appendChild(tr);
  }
}
/*********** EXPORT CSV ***********/
function exportPrepCSV(){
  const ord=getFilteredOrders();
  const stops=aggregateStops(ord);
  const fruitAgg=aggregateByFruit(ord);
  let csv="Section,Field,Value\n";
  csv+=`Filters,Date,${state.date}\n`;
  csv+=`Filters,Province,${state.province||'All'}\n`;
  csv+=`Filters,City,${state.city||'All'}\n`;
  csv+=`Filters,Buffer,${state.bufferPct}%\n`;
  if(state.fruits.length)csv+=`Filters,Fruits,${state.fruits.join('; ')}\n`;
  csv+="\nFruit,Pre-orders (lbs),Buffer (lbs),Total to Load (lbs)\n";
  Object.keys(fruitAgg).forEach(name=>{const pre=fruitAgg[name]; const add=Math.round(pre*state.bufferPct/100); const total=pre+add; csv+=`${name},${pre},${add},${total}\n`});
  csv+="\nCity,Arrival,Departure,Orders,lbs,Value,Top Items\n";
  stops.forEach(s=>{csv+=`${s.city},${s.arrive||''},${s.depart||''},${s.orders},${s.lbs},${s.value},${(s.topItems||[]).join(' ')}\n`});
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`driver-prep-${state.date||'all'}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
/*********** INIT ***********/
function fillCitySelect(){
  const opts=uniqueCitiesFor(state.province,state.date);
  $("#filter-city").innerHTML=opts.map(o=>`<option value="${o.value}">${o.label}</option>`).join("");
  state.city="";
}
async function boot(){
  isMobile = window.innerWidth <= 768;
  // Try live first, then cached
  try {
    await loadData();
  } catch (err) {
    const cached = localStorage.getItem('driverprep-cache');
    if (cached) applyData(JSON.parse(cached));
    else console.error('No data available', err);
  }
  init();
}
function init(){
  // default demo date (if your sheet uses other dates, pick one from cities or orders)
  const d=(cities[0]?.date)||"2025-10-08"; state.date=String(d);
  $("#filter-date").value=state.date; fillCitySelect();
  const ms=new MultiSelect($("#fruit-ms"),fruitsByGroup,{onChange:(vals)=>{state.fruits=vals;}});
  window.fruitFilter=ms;
  // filter inputs
  $("#filter-date").addEventListener("change",e=>{state.date=e.target.value; fillCitySelect(); renderPrep();});
  $("#filter-province").addEventListener("change",e=>{state.province=e.target.value; fillCitySelect(); renderPrep();});
  $("#filter-city").addEventListener("change",e=>{state.city=e.target.value; renderPrep();});
  // buffer slider
  $("#buffer").addEventListener("input",e=>{
    state.bufferPct=Number(e.target.value);
    $("#buffer-val").textContent=`${state.bufferPct}%`;
    renderPrep();
  });
  // Customer filter modal inputs (attached once)
  $('#cust-filter-province').addEventListener('change', e => {
    custState.province = e.target.value;
    custState.city = ''; // Reset city
    $('#cust-filter-city').innerHTML = '<option value="">All Cities</option>';
    if (custState.province) {
      getUniqueCitiesForProvince(custState.province).forEach(city => {
        const opt = document.createElement('option');
        opt.value = city;
        opt.textContent = city;
        $('#cust-filter-city').appendChild(opt);
      });
    }
    renderCustomers();
  });
  $('#cust-filter-city').addEventListener('change', e => {
    custState.city = e.target.value;
    renderCustomers();
  });
  // Customer modal apply/reset
  $("#cust-filters-apply").addEventListener("click",()=>{ hideModal('cust-filter-modal'); renderCustomers(); });
  $("#cust-filters-reset").addEventListener("click",()=>{
    custState.province = ''; custState.city = '';
    $('#cust-filter-province').value = '';
    $('#cust-filter-city').innerHTML = '<option value="">All Cities</option>';
    renderCustomers();
  });
  // open/close modals
  $("#fab-prep").addEventListener("click",openDriverPrepModal);
  document.querySelectorAll("[data-close]").forEach(btn=>btn.addEventListener("click",e=>hideModal(e.currentTarget.getAttribute("data-close"))));
  document.getElementById('filter-modal').addEventListener('click',e=>{if(e.target.id==='filter-modal')hideModal('filter-modal')});
  document.getElementById('prep-modal').addEventListener('click',e=>{if(e.target.id==='prep-modal')hideModal('prep-modal')});
  document.getElementById('cust-filter-modal').addEventListener('click',e=>{if(e.target.id==='cust-filter-modal')hideModal('cust-filter-modal')});
  // apply/reset filters (prep)
  $("#filters-apply").addEventListener("click",()=>{ hideModal('filter-modal'); renderPrep(); });
  $("#filters-reset").addEventListener("click",()=>{
    state.province=""; state.city=""; state.bufferPct=10; state.fruits=[];
    $("#buffer").value=10; $("#buffer-val").textContent="10%";
    $("#filter-province").value=""; fillCitySelect(); window.fruitFilter.clear();
    renderPrep();
  });
  // nav
  $("#nav-prep").addEventListener("click",()=>switchView('prep'));
  $("#nav-customers").addEventListener("click",()=>switchView('customers'));
  // modal actions
  $("#btn-print").addEventListener("click",()=>window.print());
  $("#btn-export").addEventListener("click",exportPrepCSV);
  // initial draw
  switchView('prep'); // Calls renderPrep
  // PWA service worker
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('./sw.js').catch(console.error);
  }
  // Resize listener for mobile/desktop switch
  window.addEventListener('resize', () => { isMobile = window.innerWidth <= 768; });
  // esc to close modals
  document.addEventListener('keydown',e=>{
    if(e.key==='Escape'){
      if(document.getElementById('filter-modal').classList.contains('show')) hideModal('filter-modal');
      if(document.getElementById('cust-filter-modal').classList.contains('show')) hideModal('cust-filter-modal');
      if(document.getElementById('prep-modal').classList.contains('show')) hideModal('prep-modal');
    }
  });
}
// Go!
boot();
</script>
<!-- ============== DEMO SEED (adds customers/products/orders; remove if not needed) ============== -->
<script>
(function seedDemo(){
  const KEY='driverprep-cache';
  let data;
  try{ data = JSON.parse(localStorage.getItem(KEY)) || {}; }catch{ data = {}; }
  data.contacts = Array.isArray(data.contacts) ? data.contacts : [];
  data.fruitPrices = data.fruitPrices || {};
  data.fruitsByGroup = data.fruitsByGroup || {};
  data.cities = Array.isArray(data.cities) ? data.cities : [];
  data.orders = Array.isArray(data.orders) ? data.orders : [];
  // --- Products + prices
  const DEMO_PRICES = {
    Blueberries: 3.50,
    Raspberries: 4.20,
    Strawberries: 2.80,
    Blackberries: 4.00,
    Cherries: 3.80,
    Peaches: 2.50
  };
  data.fruitPrices = { ...DEMO_PRICES, ...data.fruitPrices };
  data.fruitsByGroup = {
    Berries: ["Blueberries","Raspberries","Strawberries","Blackberries"],
    "Stone Fruit": ["Cherries","Peaches"],
    ...(data.fruitsByGroup||{})
  };
  // --- City ‚Üí Province (Canada)
  const PROV = {
    "Vancouver":"British Columbia","Peachland":"British Columbia","Langford":"British Columbia",
    "Nanaimo":"British Columbia","Port Alberni":"British Columbia","Vernon":"British Columbia",
    "Edmonton":"Alberta","Grande Prairie":"Alberta","Rocky Mountain House":"Alberta",
    "Airdrie":"Alberta","Fairview":"Alberta","High Prairie":"Alberta","Okotoks":"Alberta",
    "Calgary":"Alberta","Fort McMurray":"Alberta","Hinton":"Alberta","Leduc":"Alberta",
    "Lethbridge":"Alberta","St. Albert":"Alberta","Whitecourt":"Alberta","Barrhead":"Alberta",
    "Beaumont":"Alberta",
    "Prince Albert":"Saskatchewan","Moose Jaw":"Saskatchewan","Yorkton":"Saskatchewan",
    "Winnipeg":"Manitoba","Brandon":"Manitoba",
    "Fort Frances":"Ontario"
  };
  // --- Your demo customers
  const RAW = [
    ["Matt","Wilkinson","+17809728434","mrjdub2017@gmail.com","Edmonton"],
    ["Kristi","Bull","+17808325816","kris.vano12@gmail.com","Grande Prairie"],
    ["Jan","Van doorn","+12507673384","jjvavdoorn40@gmail.com","Peachland"],
    ["Glen peutert","Assiniboia","+13066408034","gm93@sasktel.net","Moose Jaw"],
    ["Nicole","Brong","+17802949015","timeucreekcontracting@gmail.com","Barrhead"],
    ["Jacqueline","Shimko","+17809700596","jshimko@shaw.ca","Beaumont"],
    ["Kim","Jago","+17809160364","kimberly.jago@gmail.com","Beaumont"],
    ["Gordon","Holland","+17804352692","girdoil@shaw.com","Edmonton"],
    ["Maryna","Poslavska","+12506619591","mposlavska@outlook.com","Grande Prairie"],
    ["Leigh-anne","Wright","+14038461233","leighwright55@gmail.com","Rocky Mountain House"],
    ["Norma","Smith","+18072714788","aleenorm33@ggmail.com","Fort Frances"],
    ["Pam","Delair","+14038181023","pdelair13@gmail.com","Airdrie"],
    ["Amber","Chelick","+17808347163","amberchelick@gmail.com","Fairview"],
    ["Ellen","Dalke","+17808353647","edalke25@yahoo.com","Fairview"],
    ["Gwen","Stout","+17805232466","gwen333@telus.net","High Prairie"],
    ["Ilona","Falat","+14165645077","irblueskies@gmail.com","Okotoks"],
    ["Joanne","Starchuk","+13069608094","jstarchuk@sasktel.net","Prince Albert"],
    ["Shyla","Bourgonje","+13068147592","shyla_bourgonje@icloud.com","Yorkton"],
    ["Juanita","Todd","+15879985238","amazing.neth@yahoo.com","Calgary"],
    ["Jackee","Mckay","+17808350117","jackee769@msn.com","Fairview"],
    ["Carmen","Enns","+17808356075","ckenns@hotmail.com","Fairview"],
    ["Bev","Cameron","+15875995553","cameron.bev@gmail.com","Fort McMurray"],
    ["Cherie","Cole","+17807251377","ccole7759@gmail.com","Hinton"],
    ["Danika","Amyotte","+17809165638","danika.amyotte@gmail.com","Leduc"],
    ["Karen","Kalau","+14037150420","kahlua67@hotmail.com","Lethbridge"],
    ["Erin","Anderson","+17809662310","purpleduck100@gmail.com","St. Albert"],
    ["Randy","Hough","+17807060884","randyhough@live.com","Whitecourt"],
    ["Myriam","Saabel","+14383987083","myriamdhaisne@hotmail.fr","Langford"],
    ["Catherine","Ross","+12502685078","catherineross90@gmail.com","Nanaimo"],
    ["Ciara","Joseph","+12506675482","ciarajospeh133@gmail.com","Port Alberni"],
    ["Carol","Chamberlain","+12503092504","crlchamberlain@gmail.com","Vernon"],
    ["Juanita","Withrow","+12506122125","juanitaw16@hotmail.com","Vernon"],
    ["Lucine","Gagne","+12047240397","alucine2006@hotmail.com","Brandon"],
    ["Carmen","Champoux","+16046710126","cchampoux@shaw.ca","Winnipeg"],
    ["Sharon","Faul","+16393143291","s.l.faul@hotmail.com","Prince Albert"]
  ];
  // --- Upsert contacts (avoid dupes)
  const keyOf = (c)=>`${c.name}|${c.email}`.toLowerCase();
  const existingKeys = new Set(data.contacts.map(c=>keyOf({name:c.name,email:c.email||""})));
  let nextId = data.contacts.reduce((m,c)=>Math.max(m,Number(c.id)||0), 300)+1;
  const added = [];
  RAW.forEach(([first,last,phone,email,city])=>{
    const name = `${first} ${last}`.replace(/\s+/g,' ').trim();
    const addr = `${city}, ${PROV[city]||'??'}, Canada`;
    const rec = { id: nextId, type:'customer', name, email, phone, address: addr };
    if(!existingKeys.has(keyOf(rec))){
      data.contacts.push({...rec});
      added.push({...rec});
      existingKeys.add(keyOf(rec));
      nextId++;
    }
  });
  // --- City schedules for Stops view
  const DEMO_DATES = ["2024-11-15","2025-10-15"];
  function addSchedule(city,date){
    const exists = data.cities.some(c=>c.city===city && String(c.date)===String(date));
    if(!exists){
      data.cities.push({
        city,
        province: PROV[city]||"",
        date,
        arrive: city==="Edmonton" ? "13:45" : "09:00",
        depart: city==="Edmonton" ? "15:30" : "10:30"
      });
    }
  }
  // schedules for all demo cities + Vancouver/Edmonton
  const demoCities = new Set( RAW.map(r=>r[4]) );
  demoCities.add("Vancouver").add("Edmonton");
  DEMO_DATES.forEach(d=>demoCities.forEach(c=>addSchedule(c,d)));
  // --- Create orders (2023‚Äì2025) connected to Driver Prep
  const FRUITS = ["Blueberries","Raspberries","Strawberries","Blackberries","Cherries","Peaches"];
  const price = f => Number(data.fruitPrices?.[f]||0);
  const orderIds = new Set(data.orders.map(o=>o.id));
  let seq = data.orders.length + 1;
  function linesFor(i){
    const a=FRUITS[i%FRUITS.length], b=FRUITS[(i+1)%FRUITS.length], c=FRUITS[(i+2)%FRUITS.length];
    return [
      { fruit:a, lbs: 60 + (i%3)*20 }, // 60/80/100
      { fruit:b, lbs: 40 + (i%4)*15 }, // 40/55/70/85
      { fruit:c, lbs: 30 + (i%5)*10 } // 30/40/50/60/70
    ];
  }
  function addOrder(cust, dateIdx){
    const city = (cust.address||"").split(",")[0].trim();
    const province = PROV[city] || "";
    const date = DEMO_DATES[dateIdx % DEMO_DATES.length];
    const id = `${city.replace(/\s+/g,'').slice(0,3).toUpperCase()}-${String(seq).padStart(4,'0')}`;
    if(orderIds.has(id)) return;
    const items = linesFor(seq);
    // compute value once to ensure meaningful Stops totals (UI also recomputes)
    const value = items.reduce((s,it)=>s + (Number(it.lbs)||0)*price(it.fruit),0);
    data.orders.push({ id, date, province, city, customerId: cust.id, items, _value:value });
    orderIds.add(id); seq++;
  }
  // one order for everyone on 2024-11-15; ~1/3 also get one on 2025-10-15
  data.contacts.filter(c=>c.type==='customer' && RAW.some(r=>(`${r[0]} ${r[1]}`).replace(/\s+/g,' ').trim()===c.name))
    .forEach((c,i)=>{ addOrder(c,0); if(i%3===0) addOrder(c,1); });
  // --- Extra seed: Vancouver & Edmonton wholesale customers so you can filter easily
  function ensureCustomer(name,email,phone,city){
    const addr = `${city}, ${PROV[city]||'??'}, Canada`;
    const rec = { id: ++nextId, type:'customer', name, email, phone, address: addr };
    const k = keyOf(rec);
    const found = data.contacts.find(c=>keyOf(c)===k);
    if(found) return found;
    data.contacts.push(rec); return rec;
  }
  const van = ensureCustomer("Granville Greens","orders@granvillegreens.ca","+1-604-555-0147","Vancouver");
  const edm = ensureCustomer("River City Market","buy@rivercitymarket.ca","+1-780-555-0192","Edmonton");
  addOrder(van,0); addOrder(van,1);
  addOrder(edm,0); addOrder(edm,1);
  // --- Save
  localStorage.setItem(KEY, JSON.stringify(data));
})();
</script>
</body>
</html>
