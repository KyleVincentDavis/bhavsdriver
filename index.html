<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Driver Prep</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#0b0e1b" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<link rel="manifest" href="data:application/manifest+json,{
  &quot;name&quot;: &quot;Driver Prep Demo&quot;,
  &quot;short_name&quot;: &quot;DriverPrep&quot;,
  &quot;description&quot;: &quot;Demo dashboard for driver prep orders&quot;,
  &quot;start_url&quot;: &quot;/index.html&quot;,
  &quot;display&quot;: &quot;standalone&quot;,
  &quot;background_color&quot;: &quot;#0b0e1b&quot;,
  &quot;theme_color&quot;: &quot;#3b82f6&quot;,
  &quot;icons&quot;: [{
    &quot;src&quot;: &quot;data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiBmaWxsPSIjM2I4MmY2Ii8+Cjx0ZXh0IHg9Ijk2IiB5PSIxMDYiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSI0OCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5EUzwvdGV4dD4KPC9zdmc+&quot;,
    &quot;sizes&quot;: &quot;192x192&quot;,
    &quot;type&quot;: &quot;image/svg+xml&quot;
  }]
}">
<style>
:root {
  --bg: #0b0e1b;
  --bg-elev: #0f1222;
  --card: #161a31;
  --muted: #8b90b0;
  --text: #e8ebff;
  --border: #272a44;
  --chip: #1b2150;
  --focus: #3b82f6;
  --accent: #22c55e;
  --warning: #f59e0b;
  --danger: #ef4444;
  --shadow: 0 10px 30px rgba(0,0,0,.35);
  --radius: 16px;
  --radius-sm: 12px;
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}
* {
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}
html, body {
  height: 100%;
  margin: 0;
  padding: 0;
  background: var(--bg);
  color: var(--text);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  overflow-x: hidden;
}
/* App Layout */
.app {
  display: flex;
  flex-direction: column;
  height: 100vh;
  height: 100dvh;
  padding-top: var(--safe-top);
}
/* Header - Dynamic */
.header {
  position: sticky;
  top: 0;
  z-index: 100;
  background: rgba(11, 14, 27, 0.95);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
  padding: 12px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  min-height: 60px;
}
.header-content {
  display: flex;
  align-items: center;
  gap: 12px;
  flex: 1;
  min-width: 0;
}
.header-title {
  display: flex;
  flex-direction: column;
  min-width: 0;
  flex: 1;
}
.header h1 {
  margin: 0;
  font-size: 20px;
  font-weight: 700;
  line-height: 1.2;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.header-subtitle {
  font-size: 12px;
  color: var(--muted);
  margin: 0;
  line-height: 1.2;
}
.header-actions {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-shrink: 0;
}
/* Main Content */
.main {
  flex: 1;
  overflow: auto;
  padding-bottom: calc(72px + var(--safe-bottom));
}
/* Bottom Navigation */
.nav-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 90;
  background: rgba(15, 18, 34, 0.95);
  backdrop-filter: blur(20px);
  border-top: 1px solid var(--border);
  padding: 8px 12px var(--safe-bottom);
}
.nav-items {
  display: flex;
  justify-content: space-around;
  align-items: center;
  max-width: 400px;
  margin: 0 auto;
}
.nav-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  padding: 8px 12px;
  background: none;
  border: none;
  color: var(--muted);
  font-size: 12px;
  cursor: pointer;
  border-radius: var(--radius-sm);
  transition: all 0.2s ease;
  min-height: 52px;
  justify-content: center;
}
.nav-item.active {
  color: var(--focus);
  background: rgba(59, 130, 246, 0.1);
}
.nav-icon {
  font-size: 20px;
  transition: transform 0.2s ease;
}
.nav-item.active .nav-icon {
  transform: scale(1.1);
}
/* Cards & Layout */
.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 16px;
}
.cards-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}
.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  box-shadow: var(--shadow);
}
.card-header {
  display: flex;
  align-items: center;
  justify-content: between;
  margin-bottom: 16px;
}
.card-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--muted);
  margin: 0;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.kpi {
  font-size: 28px;
  font-weight: 800;
  line-height: 1.2;
}
/* Grid Layout */
.grid-2 {
  display: grid;
  grid-template-columns: 1fr;
  gap: 20px;
  margin-bottom: 24px;
}
.panel {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  box-shadow: var(--shadow);
}
.panel-header {
  display: flex;
  align-items: center;
  justify-content: between;
  margin-bottom: 16px;
}
.panel-title {
  font-size: 18px;
  font-weight: 700;
  margin: 0;
  color: var(--text);
}
/* Tables */
.table-container {
  overflow: auto;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  margin-bottom: 16px;
  background: var(--bg-elev);
}
.table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
  min-width: 600px;
}
.table th {
  background: var(--bg-elev);
  color: var(--muted);
  font-weight: 600;
  text-align: left;
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 2;
}
.table th:first-child {
  position: sticky;
  left: 0;
  z-index: 3;
  background: var(--bg-elev);
}
.table td {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  background: var(--card);
}
.table td:first-child {
  position: sticky;
  left: 0;
  z-index: 1;
  background: var(--card);
}
.table tbody tr:last-child td {
  border-bottom: none;
}
.table tbody tr:hover td {
  background: var(--bg-elev);
}
.table tbody tr:hover td:first-child {
  background: var(--card);
}
/* Buttons */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 10px 16px;
  border: 1px solid var(--border);
  background: var(--card);
  color: var(--text);
  border-radius: var(--radius-sm);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  text-decoration: none;
  min-height: 44px;
}
.btn:active {
  transform: scale(0.98);
}
.btn-primary {
  background: var(--focus);
  color: white;
  border-color: var(--focus);
}
.btn-ghost {
  background: transparent;
  border-color: transparent;
}
.btn-icon {
  width: 44px;
  height: 44px;
  padding: 0;
  border-radius: 12px;
}
/* Search & Filter Bar */
.search-bar {
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px;
  margin-bottom: 20px;
}
.search-input {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 12px 16px;
  color: var(--text);
  font-size: 16px;
  width: 100%;
}
.search-input::placeholder {
  color: var(--muted);
}
.filter-select {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 12px 16px;
  color: var(--text);
  font-size: 16px;
  width: 100%;
}
/* FAB */
.fab {
  position: fixed;
  right: 20px;
  bottom: calc(84px + var(--safe-bottom));
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: var(--focus);
  color: white;
  border: none;
  box-shadow: var(--shadow);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  z-index: 80;
  transition: all 0.3s ease;
}
.fab:active {
  transform: scale(0.9);
}
/* Views */
.view {
  display: none;
  animation: fadeIn 0.3s ease;
}
.view.active {
  display: block;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
/* Customer Cards */
.customers-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 16px;
}
.customer-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  cursor: pointer;
  transition: all 0.2s ease;
}
.customer-card:active {
  transform: scale(0.98);
}
.customer-card:hover {
  border-color: var(--focus);
}
.customer-name {
  font-size: 18px;
  font-weight: 700;
  margin: 0 0 8px 0;
  color: var(--text);
}
.customer-meta {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-bottom: 12px;
}
.customer-field {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  color: var(--muted);
}
.customer-stats {
  display: flex;
  gap: 12px;
  padding-top: 12px;
  border-top: 1px solid var(--border);
}
.stat {
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.stat-value {
  font-size: 16px;
  font-weight: 700;
  color: var(--text);
}
.stat-label {
  font-size: 12px;
  color: var(--muted);
}
/* Order Cards */
.orders-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
  gap: 16px;
}
.order-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  cursor: pointer;
  transition: all 0.2s ease;
}
.order-card:active {
  transform: scale(0.98);
}
.order-card:hover {
  border-color: var(--focus);
}
.order-header {
  display: flex;
  justify-content: between;
  align-items: flex-start;
  margin-bottom: 12px;
}
.order-id {
  font-size: 16px;
  font-weight: 700;
  color: var(--text);
  margin: 0;
}
.order-date {
  font-size: 14px;
  color: var(--muted);
}
.order-customer {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
  font-size: 14px;
  color: var(--muted);
}
.order-items {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 12px;
}
.order-item {
  display: flex;
  justify-content: between;
  align-items: center;
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
}
.order-item:last-child {
  border-bottom: none;
}
.order-total {
  display: flex;
  justify-content: between;
  align-items: center;
  padding-top: 12px;
  border-top: 2px solid var(--border);
  font-weight: 700;
  font-size: 16px;
}
/* Modals */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(8px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 20px;
  animation: fadeIn 0.3s ease;
}
.modal.active {
  display: flex;
}
.modal-content {
  background: var(--bg-elev);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  width: 100%;
  max-width: 600px;
  max-height: 90vh;
  overflow: auto;
  animation: slideUp 0.3s ease;
}
@keyframes slideUp {
  from { opacity: 0; transform: translateY(30px); }
  to { opacity: 1; transform: translateY(0); }
}
.modal-header {
  display: flex;
  align-items: center;
  justify-content: between;
  padding: 20px 24px 0;
  margin-bottom: 20px;
}
.modal-title {
  font-size: 20px;
  font-weight: 700;
  margin: 0;
  flex: 1;
}
.modal-body {
  padding: 0 24px 24px;
}
.modal-actions {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  padding: 20px 24px;
  border-top: 1px solid var(--border);
  margin-top: 20px;
}
/* Filter Sections */
.filter-section {
  margin-bottom: 24px;
}
.filter-section:last-child {
  margin-bottom: 0;
}
.filter-label {
  display: block;
  font-size: 14px;
  font-weight: 600;
  color: var(--muted);
  margin-bottom: 8px;
}
/* Date Picker with Highlights */
.date-picker-container {
  position: relative;
}
.date-picker {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 12px 16px;
  color: var(--text);
  font-size: 16px;
  width: 100%;
}
.date-has-orders {
  border-color: var(--accent);
  background: rgba(34, 197, 94, 0.1);
}
/* Order Items in Modal */
.order-item-detail {
  display: flex;
  justify-content: between;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid var(--border);
}
.order-item-detail:last-child {
  border-bottom: none;
}
.order-item-info {
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.order-item-name {
  font-weight: 600;
}
.order-item-meta {
  font-size: 12px;
  color: var(--muted);
}
/* Empty States */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--muted);
}
.empty-icon {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.5;
}
/* Responsive Design */
@media (min-width: 768px) {
  .grid-2 {
    grid-template-columns: 1fr 1fr;
  }
  
  .header h1 {
    font-size: 24px;
  }
  
  .search-bar {
    grid-template-columns: 1fr auto auto auto;
    gap: 12px;
  }
  
  .driver-prep-filters {
    grid-template-columns: auto auto auto 1fr;
  }
}
@media (max-width: 767px) {
  .container {
    padding: 12px;
  }
  
  .card, .panel {
    padding: 16px;
  }
  
  .modal-content {
    margin: 0;
    border-radius: var(--radius) var(--radius) 0 0;
    max-height: 85vh;
  }
  
  .table {
    font-size: 13px;
  }
  
  .table th,
  .table td {
    padding: 8px 12px;
  }
  
  .orders-grid,
  .customers-grid {
    grid-template-columns: 1fr;
  }
  
  .cards-grid {
    grid-template-columns: 1fr;
  }
  
  /* Better mobile spacing */
  .panel {
    margin-bottom: 16px;
  }
  
  .kpi {
    font-size: 24px;
  }
  
  /* Improved mobile table views */
  .table-container {
    margin: 0 -12px;
    border-radius: 0;
    border-left: none;
    border-right: none;
  }
}
/* Utility Classes */
.text-muted { color: var(--muted); }
.text-center { text-align: center; }
.flex { display: flex; }
.flex-col { flex-direction: column; }
.items-center { align-items: center; }
.justify-between { justify-content: space-between; }
.gap-2 { gap: 8px; }
.gap-4 { gap: 16px; }
.mb-4 { margin-bottom: 16px; }
.mt-4 { margin-top: 16px; }
.w-full { width: 100%; }
/* Loading States */
.loading {
  opacity: 0.6;
  pointer-events: none;
}
.skeleton {
  background: linear-gradient(90deg, var(--border) 25%, var(--card) 50%, var(--border) 75%);
  background-size: 200% 100%;
  animation: loading 1.5s infinite;
  border-radius: 4px;
}
@keyframes loading {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}
/* Driver Prep Mobile Optimizations */
.driver-prep-summary {
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px;
  margin-bottom: 20px;
}
.driver-prep-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  text-align: center;
}
.driver-prep-value {
  font-size: 24px;
  font-weight: 800;
  margin: 8px 0 4px;
}
.driver-prep-label {
  font-size: 12px;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
/* Buffer Control Mobile */
.buffer-control {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 20px;
}
.buffer-slider {
  display: flex;
  align-items: center;
  gap: 12px;
}
.buffer-value {
  min-width: 50px;
  text-align: center;
  font-weight: 600;
}
</style>
</head>
<body>
<div class="app">
  <!-- Dynamic Header -->
  <header class="header" role="banner">
    <div class="header-content">
      <div class="header-title">
        <h1 id="header-main">Driver Prep</h1>
        <p class="header-subtitle" id="header-subtitle">Pre-order dashboard</p>
      </div>
    </div>
    <div class="header-actions">
      <button id="btn-header-action" class="btn btn-icon" aria-label="View options">
        <span>‚öôÔ∏è</span>
      </button>
    </div>
  </header>
  <!-- Main Content -->
  <main class="main" role="main">
    <!-- Driver Prep View -->
    <div id="view-prep" class="view active">
      <div class="container">
        <!-- Quick Filter Bar -->
        <div class="search-bar driver-prep-filters">
          <div class="date-picker-container">
            <input type="date" id="prep-filter-date" class="date-picker" value="">
          </div>
          <select id="prep-filter-province" class="filter-select">
            <option value="">All Provinces</option>
          </select>
          <select id="prep-filter-city" class="filter-select">
            <option value="">All Cities</option>
          </select>
          <button class="btn btn-primary" onclick="app.openModal('modal-filters')">
            More Filters
          </button>
        </div>
        <!-- KPI Cards - Mobile Optimized -->
        <div class="driver-prep-summary">
          <div class="driver-prep-card">
            <div class="driver-prep-label">Total Pre-orders</div>
            <div class="driver-prep-value" id="kpi-total-lbs">‚Äî</div>
          </div>
          <div class="driver-prep-card">
            <div class="driver-prep-label">Orders</div>
            <div class="driver-prep-value" id="kpi-orders">‚Äî</div>
          </div>
          <div class="driver-prep-card">
            <div class="driver-prep-label">Total Value</div>
            <div class="driver-prep-value" id="kpi-total-value">‚Äî</div>
          </div>
        </div>
        <!-- Buffer Control -->
        <div class="buffer-control">
          <label class="filter-label">Walk-in Buffer: <span id="buffer-val" class="buffer-value">10%</span></label>
          <div class="buffer-slider">
            <input id="buffer" type="range" min="0" max="30" value="10" class="w-full">
          </div>
        </div>
        <!-- Main Grid -->
        <div class="grid-2">
          <!-- Loading Plan -->
          <div class="panel">
            <div class="panel-header">
              <h2 class="panel-title">What to Load</h2>
            </div>
            <!-- Fruit Table -->
            <div class="table-container">
              <table class="table" id="fruit-table">
                <thead>
                  <tr>
                    <th>Fruit</th>
                    <th>Pre-orders</th>
                    <th>+ Buffer</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody><!-- Dynamic --></tbody>
              </table>
            </div>
            <!-- Chart -->
            <canvas id="fruit-chart" style="max-height: 200px; margin-top: 20px;"></canvas>
          </div>
          <!-- Stops -->
          <div class="panel">
            <div class="panel-header">
              <h2 class="panel-title">Stops</h2>
            </div>
            <div class="table-container">
              <table class="table" id="stops-table">
                <thead>
                  <tr>
                    <th>City</th>
                    <th>Arrive</th>
                    <th>Depart</th>
                    <th>Orders</th>
                    <th>lbs</th>
                  </tr>
                </thead>
                <tbody><!-- Dynamic --></tbody>
              </table>
            </div>
          </div>
        </div>
        <!-- Customers -->
        <div class="panel">
          <div class="panel-header">
            <h2 class="panel-title">Customers</h2>
          </div>
          <div class="table-container">
            <table class="table" id="customers-table">
              <thead>
                <tr>
                  <th>Customer</th>
                  <th>Orders</th>
                  <th>Total lbs</th>
                  <th>Value</th>
                </tr>
              </thead>
              <tbody><!-- Dynamic --></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <!-- Customers View -->
    <div id="view-customers" class="view">
      <div class="container">
        <!-- Search & Filter -->
        <div class="search-bar">
          <input type="text" id="customer-search" class="search-input" placeholder="Search customers...">
          <select id="customer-filter-province" class="filter-select">
            <option value="">All Provinces</option>
          </select>
          <select id="customer-filter-city" class="filter-select">
            <option value="">All Cities</option>
          </select>
        </div>
        <!-- Customers Grid -->
        <div class="customers-grid" id="customers-grid">
          <!-- Dynamic customer cards -->
        </div>
      </div>
    </div>
    <!-- Orders View -->
    <div id="view-orders" class="view">
      <div class="container">
        <!-- Search & Filter -->
        <div class="search-bar">
          <input type="text" id="orders-search" class="search-input" placeholder="Search orders or customers...">
          <select id="orders-filter-customer" class="filter-select">
            <option value="">All Customers</option>
          </select>
          <select id="orders-filter-product" class="filter-select">
            <option value="">All Products</option>
          </select>
          <select id="orders-filter-city" class="filter-select">
            <option value="">All Cities</option>
          </select>
        </div>
        <!-- Orders Grid -->
        <div class="orders-grid" id="orders-grid">
          <!-- Dynamic order cards -->
        </div>
      </div>
    </div>
  </main>
  <!-- Bottom Navigation -->
  <nav class="nav-bar" role="navigation" aria-label="Main navigation">
    <div class="nav-items">
      <button class="nav-item active" data-view="prep">
        <span class="nav-icon">üì¶</span>
        <span>Driver Prep</span>
      </button>
      <button class="nav-item" data-view="customers">
        <span class="nav-icon">üë•</span>
        <span>Customers</span>
      </button>
      <button class="nav-item" data-view="orders">
        <span class="nav-icon">üìã</span>
        <span>Orders</span>
      </button>
    </div>
  </nav>
  <!-- FAB -->
  <button id="fab-main" class="fab" aria-label="Quick actions">
    <span>üì¶</span>
  </button>
</div>
<!-- Driver Prep Modal -->
<div id="modal-prep" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Driver Prep Summary</h2>
      <button class="btn btn-ghost btn-icon" data-close="modal-prep">√ó</button>
    </div>
    <div class="modal-body" id="modal-prep-body">
      <!-- Dynamic content -->
    </div>
    <div class="modal-actions">
      <button class="btn" id="btn-print">Print</button>
      <button class="btn" id="btn-export">Export CSV</button>
      <button class="btn btn-primary" data-close="modal-prep">Close</button>
    </div>
  </div>
</div>
<!-- Customer Details Modal -->
<div id="modal-customer" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="modal-customer-title">Customer Details</h2>
      <button class="btn btn-ghost btn-icon" data-close="modal-customer">√ó</button>
    </div>
    <div class="modal-body" id="modal-customer-body">
      <!-- Dynamic content -->
    </div>
    <div class="modal-actions">
      <button class="btn btn-primary" id="btn-use-in-driverprep">Use in Driver Prep</button>
      <button class="btn" id="btn-view-orders">View All Orders</button>
      <button class="btn" data-close="modal-customer">Close</button>
    </div>
  </div>
</div>
<!-- Order Details Modal -->
<div id="modal-order" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="modal-order-title">Order Details</h2>
      <button class="btn btn-ghost btn-icon" data-close="modal-order">√ó</button>
    </div>
    <div class="modal-body" id="modal-order-body">
      <!-- Dynamic content -->
    </div>
    <div class="modal-actions">
      <button class="btn btn-primary" id="btn-view-customer">View Customer</button>
      <button class="btn" data-close="modal-order">Close</button>
    </div>
  </div>
</div>
<!-- Filters Modal -->
<div id="modal-filters" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="modal-filters-title">Driver Prep Filters</h2>
      <button class="btn btn-ghost btn-icon" data-close="modal-filters">√ó</button>
    </div>
    <div class="modal-body">
      <div class="filter-section">
        <label class="filter-label">Date</label>
        <div class="date-picker-container">
          <input type="date" id="filter-date" class="date-picker">
        </div>
      </div>
      
      <div class="filter-section">
        <label class="filter-label">Province</label>
        <select id="filter-province" class="filter-select">
          <option value="">All Provinces</option>
          <option>British Columbia</option>
          <option>Alberta</option>
          <option>Saskatchewan</option>
          <option>Manitoba</option>
          <option>Ontario</option>
        </select>
      </div>
      
      <div class="filter-section">
        <label class="filter-label">City</label>
        <select id="filter-city" class="filter-select">
          <option value="">All Cities</option>
        </select>
      </div>
      
      <div class="filter-section">
        <label class="filter-label">Fruits</label>
        <div id="fruit-filter" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
          <!-- Dynamic fruit checkboxes -->
        </div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn" id="filters-reset">Reset</button>
      <button class="btn btn-primary" id="filters-apply">Apply Filters</button>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
// Enhanced Mobile-First Web App with Working Driver Prep
class DriverPrepApp {
  constructor() {
    this.state = {
      currentView: 'prep',
      prepFilters: {
        date: '',
        province: '',
        city: '',
        bufferPct: 10,
        fruits: []
      },
      customerFilters: {
        search: '',
        province: '',
        city: ''
      },
      orderFilters: {
        search: '',
        customer: '',
        product: '',
        city: ''
      },
      data: {
        contacts: [],
        fruitPrices: {},
        fruitsByGroup: {},
        cities: [],
        orders: []
      }
    };
    
    this.init();
  }
  async init() {
    await this.loadData();
    this.setupEventListeners();
    this.render();
  }
  async loadData() {
    try {
      // Try to load from API first
      const API_URL = 'YOUR_APPS_SCRIPT_WEB_APP_URL';
      const res = await fetch(`${API_URL}?t=all`, { cache: 'no-store' });
      if (res.ok) {
        this.state.data = await res.json();
        localStorage.setItem('driverprep-cache', JSON.stringify(this.state.data));
      } else {
        throw new Error('API not available');
      }
    } catch (err) {
      // Fallback to cached data
      const cached = localStorage.getItem('driverprep-cache');
      if (cached) {
        this.state.data = JSON.parse(cached);
      } else {
        // Load demo data
        this.loadDemoData();
      }
    }
    
    // Set default date to today if not set
    if (!this.state.prepFilters.date) {
      this.state.prepFilters.date = new Date().toISOString().slice(0,10);
      document.getElementById('prep-filter-date').value = this.state.prepFilters.date;
      document.getElementById('filter-date').value = this.state.prepFilters.date;
    }
    
    this.updateProvinceOptions();
    this.updateCityOptions();
    this.updateDateHighlighting();
  }
  loadDemoData() {
    // Demo data with multiple dates including Nov 9, 2025
    const demoDate1 = new Date().toISOString().slice(0,10);
    const demoDate2 = '2025-11-09'; // Special date with orders
    const demoDate3 = '2025-11-10'; // Another date
    
    this.state.data = {
      contacts: [
        { id: 1, type: 'customer', name: 'John Smith', email: 'john@example.com', phone: '555-0101', address: 'Vancouver, BC' },
        { id: 2, type: 'customer', name: 'Sarah Johnson', email: 'sarah@example.com', phone: '555-0102', address: 'Edmonton, AB' },
        { id: 3, type: 'customer', name: 'Mike Wilson', email: 'mike@example.com', phone: '555-0103', address: 'Calgary, AB' }
      ],
      fruitPrices: {
        'Blueberries': 3.50,
        'Raspberries': 4.20,
        'Strawberries': 2.80,
        'Blackberries': 4.00,
        'Cherries': 3.80,
        'Peaches': 2.50
      },
      fruitsByGroup: {
        'Berries': ['Blueberries', 'Raspberries', 'Strawberries', 'Blackberries'],
        'Stone Fruit': ['Cherries', 'Peaches']
      },
      cities: [
        { city: 'Vancouver', province: 'British Columbia', date: demoDate1, arrive: '09:00', depart: '10:30' },
        { city: 'Edmonton', province: 'Alberta', date: demoDate1, arrive: '13:45', depart: '15:30' },
        { city: 'Calgary', province: 'Alberta', date: demoDate1, arrive: '11:00', depart: '12:30' },
        { city: 'Vancouver', province: 'British Columbia', date: demoDate2, arrive: '08:30', depart: '10:00' },
        { city: 'Edmonton', province: 'Alberta', date: demoDate2, arrive: '14:00', depart: '15:45' }
      ],
      orders: [
        {
          id: 'VAN-0001',
          date: demoDate1,
          province: 'British Columbia',
          city: 'Vancouver',
          customerId: 1,
          items: [
            { fruit: 'Blueberries', lbs: 100 },
            { fruit: 'Raspberries', lbs: 50 },
            { fruit: 'Strawberries', lbs: 80 }
          ]
        },
        {
          id: 'EDM-0001',
          date: demoDate1,
          province: 'Alberta',
          city: 'Edmonton',
          customerId: 2,
          items: [
            { fruit: 'Blueberries', lbs: 60 },
            { fruit: 'Cherries', lbs: 40 },
            { fruit: 'Peaches', lbs: 70 }
          ]
        },
        {
          id: 'CAL-0001',
          date: demoDate1,
          province: 'Alberta',
          city: 'Calgary',
          customerId: 3,
          items: [
            { fruit: 'Strawberries', lbs: 90 },
            { fruit: 'Blackberries', lbs: 30 },
            { fruit: 'Raspberries', lbs: 60 }
          ]
        },
        {
          id: 'VAN-0002',
          date: demoDate1,
          province: 'British Columbia',
          city: 'Vancouver',
          customerId: 1,
          items: [
            { fruit: 'Blueberries', lbs: 40 },
            { fruit: 'Peaches', lbs: 60 }
          ]
        },
        // Orders for Nov 9, 2025
        {
          id: 'VAN-1109',
          date: demoDate2,
          province: 'British Columbia',
          city: 'Vancouver',
          customerId: 1,
          items: [
            { fruit: 'Blueberries', lbs: 120 },
            { fruit: 'Strawberries', lbs: 75 }
          ]
        },
        {
          id: 'EDM-1109',
          date: demoDate2,
          province: 'Alberta',
          city: 'Edmonton',
          customerId: 2,
          items: [
            { fruit: 'Cherries', lbs: 85 },
            { fruit: 'Peaches', lbs: 55 }
          ]
        },
        // Orders for Nov 10, 2025
        {
          id: 'VAN-1110',
          date: demoDate3,
          province: 'British Columbia',
          city: 'Vancouver',
          customerId: 1,
          items: [
            { fruit: 'Raspberries', lbs: 65 },
            { fruit: 'Blackberries', lbs: 45 }
          ]
        }
      ]
    };
    
    localStorage.setItem('driverprep-cache', JSON.stringify(this.state.data));
  }
  setupEventListeners() {
    // Navigation
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', (e) => {
        const view = e.currentTarget.dataset.view;
        this.switchView(view);
      });
    });
    // Header action button
    document.getElementById('btn-header-action').addEventListener('click', () => {
      if (this.state.currentView === 'prep') {
        this.openModal('modal-filters');
      } else if (this.state.currentView === 'customers') {
        document.getElementById('customer-search').focus();
      } else if (this.state.currentView === 'orders') {
        document.getElementById('orders-search').focus();
      }
    });
    // FAB
    document.getElementById('fab-main').addEventListener('click', () => {
      if (this.state.currentView === 'prep') {
        this.openDriverPrepModal();
      }
    });
    // Modal closures
    document.querySelectorAll('[data-close]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const modalId = e.currentTarget.dataset.close;
        this.closeModal(modalId);
      });
    });
    // Click outside modals to close
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          this.closeModal(modal.id);
        }
      });
    });
    // Driver Prep quick filters
    document.getElementById('prep-filter-date').addEventListener('change', (e) => {
      this.state.prepFilters.date = e.target.value;
      document.getElementById('filter-date').value = e.target.value;
      this.updateCityOptions();
      this.renderPrepView();
    });
    document.getElementById('prep-filter-province').addEventListener('change', (e) => {
      this.state.prepFilters.province = e.target.value;
      document.getElementById('filter-province').value = e.target.value;
      this.updateCityOptions();
      this.renderPrepView();
    });
    document.getElementById('prep-filter-city').addEventListener('change', (e) => {
      this.state.prepFilters.city = e.target.value;
      document.getElementById('filter-city').value = e.target.value;
      this.renderPrepView();
    });
    // Driver Prep modal filters
    document.getElementById('filter-date').addEventListener('change', (e) => {
      this.state.prepFilters.date = e.target.value;
      document.getElementById('prep-filter-date').value = e.target.value;
      this.updateCityOptions();
      this.renderPrepView();
    });
    document.getElementById('filter-province').addEventListener('change', (e) => {
      this.state.prepFilters.province = e.target.value;
      document.getElementById('prep-filter-province').value = e.target.value;
      this.updateCityOptions();
      this.renderPrepView();
    });
    document.getElementById('filter-city').addEventListener('change', (e) => {
      this.state.prepFilters.city = e.target.value;
      document.getElementById('prep-filter-city').value = e.target.value;
      this.renderPrepView();
    });
    // Buffer slider
    document.getElementById('buffer').addEventListener('input', (e) => {
      this.state.prepFilters.bufferPct = Number(e.target.value);
      document.getElementById('buffer-val').textContent = `${this.state.prepFilters.bufferPct}%`;
      this.renderPrepView();
    });
    // Customer search and filters
    document.getElementById('customer-search').addEventListener('input', (e) => {
      this.state.customerFilters.search = e.target.value;
      this.renderCustomersView();
    });
    document.getElementById('customer-filter-province').addEventListener('change', (e) => {
      this.state.customerFilters.province = e.target.value;
      this.renderCustomersView();
    });
    document.getElementById('customer-filter-city').addEventListener('change', (e) => {
      this.state.customerFilters.city = e.target.value;
      this.renderCustomersView();
    });
    // Order search and filters
    document.getElementById('orders-search').addEventListener('input', (e) => {
      this.state.orderFilters.search = e.target.value;
      this.renderOrdersView();
    });
    document.getElementById('orders-filter-customer').addEventListener('change', (e) => {
      this.state.orderFilters.customer = e.target.value;
      this.renderOrdersView();
    });
    document.getElementById('orders-filter-product').addEventListener('change', (e) => {
      this.state.orderFilters.product = e.target.value;
      this.renderOrdersView();
    });
    document.getElementById('orders-filter-city').addEventListener('change', (e) => {
      this.state.orderFilters.city = e.target.value;
      this.renderOrdersView();
    });
    // Apply/Reset filters
    document.getElementById('filters-apply').addEventListener('click', () => {
      this.closeModal('modal-filters');
      this.renderPrepView();
    });
    document.getElementById('filters-reset').addEventListener('click', () => {
      this.resetFilters();
      this.renderPrepView();
    });
    // Modal actions
    document.getElementById('btn-print').addEventListener('click', () => window.print());
    document.getElementById('btn-export').addEventListener('click', () => this.exportPrepCSV());
    document.getElementById('btn-use-in-driverprep').addEventListener('click', () => this.useCustomerInDriverPrep());
    document.getElementById('btn-view-orders').addEventListener('click', () => this.viewCustomerOrders());
    document.getElementById('btn-view-customer').addEventListener('click', () => this.viewOrderCustomer());
    // ESC key to close modals
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal.active').forEach(modal => {
          this.closeModal(modal.id);
        });
      }
    });
    // Initialize fruit filter checkboxes
    this.initializeFruitFilters();
  }
  updateDateHighlighting() {
    // Get all unique dates that have orders
    const datesWithOrders = [...new Set(this.state.data.orders.map(order => order.date))];
    
    // Add event listener to date inputs to check if they have orders
    const dateInputs = [
      document.getElementById('prep-filter-date'),
      document.getElementById('filter-date')
    ];
    
    dateInputs.forEach(input => {
      if (input) {
        // Check initial value
        if (datesWithOrders.includes(input.value)) {
          input.classList.add('date-has-orders');
        }
        
        // Add change listener
        input.addEventListener('change', (e) => {
          if (datesWithOrders.includes(e.target.value)) {
            e.target.classList.add('date-has-orders');
          } else {
            e.target.classList.remove('date-has-orders');
          }
        });
      }
    });
  }
  initializeFruitFilters() {
    const container = document.getElementById('fruit-filter');
    const allFruits = Object.values(this.state.data.fruitsByGroup).flat();
    
    container.innerHTML = allFruits.map(fruit => `
      <label style="display: flex; align-items: center; gap: 4px;">
        <input type="checkbox" value="${fruit}" onchange="app.toggleFruitFilter('${fruit}')">
        <span>${fruit}</span>
      </label>
    `).join('');
  }
  toggleFruitFilter(fruit) {
    const index = this.state.prepFilters.fruits.indexOf(fruit);
    if (index > -1) {
      this.state.prepFilters.fruits.splice(index, 1);
    } else {
      this.state.prepFilters.fruits.push(fruit);
    }
    this.renderPrepView();
  }
  updateProvinceOptions() {
    const provinces = [...new Set(this.state.data.orders.map(order => order.province))].sort();
    const provinceSelects = [
      document.getElementById('prep-filter-province'),
      document.getElementById('filter-province'),
      document.getElementById('customer-filter-province')
    ];
    
    provinceSelects.forEach(select => {
      if (select) {
        select.innerHTML = '<option value="">All Provinces</option>' +
          provinces.map(province => `<option value="${province}">${province}</option>`).join('');
      }
    });
  }
  updateCityOptions() {
    const { date, province } = this.state.prepFilters;
    const cities = [...new Set(this.state.data.orders
      .filter(order => (!date || order.date === date) && (!province || order.province === province))
      .map(order => order.city))].sort();
    
    const citySelects = [
      document.getElementById('prep-filter-city'),
      document.getElementById('filter-city'),
      document.getElementById('customer-filter-city'),
      document.getElementById('orders-filter-city')
    ];
    
    citySelects.forEach(select => {
      if (select) {
        select.innerHTML = '<option value="">All Cities</option>' +
          cities.map(city => `<option value="${city}">${city}</option>`).join('');
      }
    });
  }
  // CORE DRIVER PREP FUNCTIONALITY
  getFilteredOrders() {
    const { date, province, city, fruits } = this.state.prepFilters;
    
    return this.state.data.orders.filter(order => {
      // Date filter
      if (date && order.date !== date) return false;
      
      // Province filter
      if (province && order.province !== province) return false;
      
      // City filter
      if (city && order.city !== city) return false;
      
      // Fruit filter
      if (fruits.length > 0) {
        const orderFruits = order.items.map(item => item.fruit);
        if (!fruits.some(fruit => orderFruits.includes(fruit))) return false;
      }
      
      return true;
    });
  }
  aggregateByFruit(orders) {
    const fruitAgg = {};
    
    orders.forEach(order => {
      order.items.forEach(item => {
        if (this.state.prepFilters.fruits.length === 0 ||
            this.state.prepFilters.fruits.includes(item.fruit)) {
          fruitAgg[item.fruit] = (fruitAgg[item.fruit] || 0) + (item.lbs || 0);
        }
      });
    });
    
    return fruitAgg;
  }
  aggregateStops(orders) {
    const stopsMap = new Map();
    
    orders.forEach(order => {
      const cityData = this.state.data.cities.find(c => c.city === order.city && c.date === order.date);
      
      if (!stopsMap.has(order.city)) {
        stopsMap.set(order.city, {
          city: order.city,
          arrive: cityData?.arrive || '‚Äî',
          depart: cityData?.depart || '‚Äî',
          orders: 0,
          lbs: 0,
          value: 0
        });
      }
      
      const stop = stopsMap.get(order.city);
      stop.orders += 1;
      
      order.items.forEach(item => {
        if (this.state.prepFilters.fruits.length === 0 ||
            this.state.prepFilters.fruits.includes(item.fruit)) {
          stop.lbs += (item.lbs || 0);
          stop.value += (item.lbs || 0) * (this.state.data.fruitPrices[item.fruit] || 0);
        }
      });
    });
    
    return Array.from(stopsMap.values()).sort((a, b) => b.lbs - a.lbs);
  }
  aggregateCustomers(orders) {
    const customersMap = new Map();
    
    orders.forEach(order => {
      const customer = this.state.data.contacts.find(c => c.id === order.customerId);
      if (!customer) return;
      
      if (!customersMap.has(customer.id)) {
        customersMap.set(customer.id, {
          customer: customer,
          orders: 0,
          lbs: 0,
          value: 0
        });
      }
      
      const custData = customersMap.get(customer.id);
      custData.orders += 1;
      
      order.items.forEach(item => {
        if (this.state.prepFilters.fruits.length === 0 ||
            this.state.prepFilters.fruits.includes(item.fruit)) {
          custData.lbs += (item.lbs || 0);
          custData.value += (item.lbs || 0) * (this.state.data.fruitPrices[item.fruit] || 0);
        }
      });
    });
    
    return Array.from(customersMap.values()).sort((a, b) => b.value - a.value);
  }
  renderPrepView() {
    const filteredOrders = this.getFilteredOrders();
    const fruitAgg = this.aggregateByFruit(filteredOrders);
    const stops = this.aggregateStops(filteredOrders);
    const customers = this.aggregateCustomers(filteredOrders);
    
    // Update KPIs
    const totalLbs = Object.values(fruitAgg).reduce((sum, lbs) => sum + lbs, 0);
    const totalValue = filteredOrders.reduce((sum, order) => {
      return sum + order.items.reduce((orderSum, item) => {
        if (this.state.prepFilters.fruits.length === 0 ||
            this.state.prepFilters.fruits.includes(item.fruit)) {
          return orderSum + ((item.lbs || 0) * (this.state.data.fruitPrices[item.fruit] || 0));
        }
        return orderSum;
      }, 0);
    }, 0);
    
    document.getElementById('kpi-total-lbs').textContent = this.formatLbs(totalLbs);
    document.getElementById('kpi-orders').textContent = filteredOrders.length;
    document.getElementById('kpi-total-value').textContent = this.formatDollar(totalValue);
    
    // Render fruit table
    const fruitTable = document.getElementById('fruit-table').querySelector('tbody');
    fruitTable.innerHTML = Object.entries(fruitAgg).map(([fruit, preLbs]) => {
      const bufferLbs = Math.round(preLbs * this.state.prepFilters.bufferPct / 100);
      const totalLbs = preLbs + bufferLbs;
      
      return `
        <tr>
          <td>${fruit}</td>
          <td>${this.formatLbs(preLbs)}</td>
          <td>${this.formatLbs(bufferLbs)}</td>
          <td><strong>${this.formatLbs(totalLbs)}</strong></td>
        </tr>
      `;
    }).join('') || '<tr><td colspan="4" class="text-center">No data</td></tr>';
    
    // Render stops table
    const stopsTable = document.getElementById('stops-table').querySelector('tbody');
    stopsTable.innerHTML = stops.map(stop => `
      <tr>
        <td>${stop.city}</td>
        <td>${stop.arrive}</td>
        <td>${stop.depart}</td>
        <td>${stop.orders}</td>
        <td>${this.formatLbs(stop.lbs)}</td>
      </tr>
    `).join('') || '<tr><td colspan="5" class="text-center">No stops</td></tr>';
    
    // Render customers table
    const customersTable = document.getElementById('customers-table').querySelector('tbody');
    customersTable.innerHTML = customers.map(data => `
      <tr>
        <td>${data.customer.name}</td>
        <td>${data.orders}</td>
        <td>${this.formatLbs(data.lbs)}</td>
        <td>${this.formatDollar(data.value)}</td>
      </tr>
    `).join('') || '<tr><td colspan="4" class="text-center">No customers</td></tr>';
    
    // Update chart
    this.updateFruitChart(fruitAgg);
  }
  updateFruitChart(fruitAgg) {
    const ctx = document.getElementById('fruit-chart');
    
    // Destroy existing chart
    if (this.fruitChart) {
      this.fruitChart.destroy();
    }
    
    if (Object.keys(fruitAgg).length === 0) {
      ctx.style.display = 'none';
      return;
    }
    
    ctx.style.display = 'block';
    
    this.fruitChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Object.keys(fruitAgg),
        datasets: [{
          label: 'Pre-orders (lbs)',
          data: Object.values(fruitAgg),
          backgroundColor: '#3b82f6',
          borderColor: '#3b82f6',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Pounds (lbs)'
            }
          }
        }
      }
    });
  }
  switchView(view) {
    this.state.currentView = view;
    
    // Update navigation
    document.querySelectorAll('.nav-item').forEach(item => {
      item.classList.toggle('active', item.dataset.view === view);
    });
    
    // Update views
    document.querySelectorAll('.view').forEach(viewEl => {
      viewEl.classList.toggle('active', viewEl.id === `view-${view}`);
    });
    
    // Update header
    this.updateHeader();
    
    // Render the view
    if (view === 'prep') {
      this.renderPrepView();
    } else if (view === 'customers') {
      this.renderCustomersView();
    } else if (view === 'orders') {
      this.renderOrdersView();
    }
  }
  updateHeader() {
    const headerMain = document.getElementById('header-main');
    const headerSubtitle = document.getElementById('header-subtitle');
    const headerAction = document.getElementById('btn-header-action');
    
    switch (this.state.currentView) {
      case 'prep':
        const filteredOrders = this.getFilteredOrders();
        headerMain.textContent = 'Driver Prep';
        headerSubtitle.textContent = `${filteredOrders.length} orders ‚Ä¢ ${this.formatLbs(Object.values(this.aggregateByFruit(filteredOrders)).reduce((a, b) => a + b, 0))}`;
        headerAction.innerHTML = '‚öôÔ∏è';
        headerAction.title = 'Filters';
        break;
      case 'customers':
        const customerCount = this.getFilteredCustomers().length;
        headerMain.textContent = 'Customers';
        headerSubtitle.textContent = `${customerCount} customer${customerCount !== 1 ? 's' : ''}`;
        headerAction.innerHTML = 'üîç';
        headerAction.title = 'Search & Filter';
        break;
      case 'orders':
        const orderCount = this.getFilteredOrdersForTab().length;
        headerMain.textContent = 'Orders';
        headerSubtitle.textContent = `${orderCount} order${orderCount !== 1 ? 's' : ''}`;
        headerAction.innerHTML = 'üîç';
        headerAction.title = 'Search & Filter';
        break;
      default:
        headerMain.textContent = 'Driver Prep';
        headerSubtitle.textContent = 'Pre-order dashboard';
    }
  }
  render() {
    this.updateHeader();
    
    if (this.state.currentView === 'prep') {
      this.renderPrepView();
    } else if (this.state.currentView === 'customers') {
      this.renderCustomersView();
    } else if (this.state.currentView === 'orders') {
      this.renderOrdersView();
    }
  }
  // Customer methods
  getFilteredCustomers() {
    const { search, province, city } = this.state.customerFilters;
    return this.state.data.contacts.filter(contact => {
      if (contact.type !== 'customer') return false;
      
      // Search filter
      if (search) {
        const searchable = [
          contact.name || '',
          contact.email || '',
          contact.phone || '',
          contact.address || ''
        ].join(' ').toLowerCase();
        if (!searchable.includes(search.toLowerCase())) return false;
      }
      
      return true;
    });
  }
  renderCustomersView() {
    const filteredCustomers = this.getFilteredCustomers();
    const container = document.getElementById('customers-grid');
    
    if (filteredCustomers.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">üë•</div>
          <h3>No customers found</h3>
          <p>Try adjusting your search or filters</p>
        </div>
      `;
      return;
    }
    
    container.innerHTML = filteredCustomers.map(customer => {
      const customerOrders = this.state.data.orders.filter(order => order.customerId === customer.id);
      const totalOrders = customerOrders.length;
      const totalLbs = customerOrders.reduce((sum, order) =>
        sum + order.items.reduce((itemSum, item) => itemSum + (item.lbs || 0), 0), 0);
      const totalValue = customerOrders.reduce((sum, order) =>
        sum + order.items.reduce((itemSum, item) =>
          itemSum + ((item.lbs || 0) * (this.state.data.fruitPrices[item.fruit] || 0)), 0), 0);
      
      return `
        <div class="customer-card" onclick="app.openCustomerDetails(${customer.id})">
          <h3 class="customer-name">${customer.name}</h3>
          <div class="customer-meta">
            <div class="customer-field">üìß ${customer.email || 'No email'}</div>
            <div class="customer-field">üìû ${customer.phone || 'No phone'}</div>
            <div class="customer-field">üìç ${customer.address || 'No address'}</div>
          </div>
          <div class="customer-stats">
            <div class="stat">
              <span class="stat-value">${totalOrders}</span>
              <span class="stat-label">Orders</span>
            </div>
            <div class="stat">
              <span class="stat-value">${this.formatLbs(totalLbs)}</span>
              <span class="stat-label">Total lbs</span>
            </div>
            <div class="stat">
              <span class="stat-value">${this.formatDollar(totalValue)}</span>
              <span class="stat-label">Total Value</span>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }
  // Order methods
  getFilteredOrdersForTab() {
    const { search, customer, product, city } = this.state.orderFilters;
    
    return this.state.data.orders.filter(order => {
      const orderCustomer = this.state.data.contacts.find(c => c.id === order.customerId);
      
      // Search filter
      if (search) {
        const customerName = orderCustomer ? orderCustomer.name : '';
        if (!order.id.toLowerCase().includes(search.toLowerCase()) &&
            !customerName.toLowerCase().includes(search.toLowerCase())) {
          return false;
        }
      }
      
      // Customer filter
      if (customer && orderCustomer && orderCustomer.name !== customer) {
        return false;
      }
      
      // Product filter
      if (product && !order.items.some(item => item.fruit === product)) {
        return false;
      }
      
      // City filter
      if (city && order.city !== city) {
        return false;
      }
      
      return true;
    });
  }
  renderOrdersView() {
    const filteredOrders = this.getFilteredOrdersForTab();
    const container = document.getElementById('orders-grid');
    
    // Update customer and product filter options
    this.updateOrderFilters();
    
    if (filteredOrders.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">üìã</div>
          <h3>No orders found</h3>
          <p>Try adjusting your search or filters</p>
        </div>
      `;
      return;
    }
    
    container.innerHTML = filteredOrders.map(order => {
      const customer = this.state.data.contacts.find(c => c.id === order.customerId);
      const totalLbs = order.items.reduce((sum, item) => sum + (item.lbs || 0), 0);
      const totalValue = this.calculateOrderValue(order);
      
      return `
        <div class="order-card" onclick="app.openOrderDetails('${order.id}')">
          <div class="order-header">
            <h3 class="order-id">${order.id}</h3>
            <span class="order-date">${order.date}</span>
          </div>
          <div class="order-customer">
            <span>üë§ ${customer ? customer.name : 'Unknown Customer'}</span>
            <span>üìç ${order.city}</span>
          </div>
          <div class="order-items">
            ${order.items.map(item => `
              <div class="order-item">
                <span>${item.fruit}</span>
                <span>${this.formatLbs(item.lbs)}</span>
              </div>
            `).join('')}
          </div>
          <div class="order-total">
            <span>Total</span>
            <span>${this.formatDollar(totalValue)}</span>
          </div>
        </div>
      `;
    }).join('');
  }
  updateOrderFilters() {
    // Update customer filter options
    const customerSelect = document.getElementById('orders-filter-customer');
    const customers = [...new Set(this.state.data.orders.map(order => {
      const customer = this.state.data.contacts.find(c => c.id === order.customerId);
      return customer ? customer.name : '';
    }).filter(name => name))].sort();
    
    customerSelect.innerHTML = '<option value="">All Customers</option>' +
      customers.map(name => `<option value="${name}">${name}</option>`).join('');
    
    // Update product filter options
    const productSelect = document.getElementById('orders-filter-product');
    const products = [...new Set(this.state.data.orders.flatMap(order =>
      order.items.map(item => item.fruit)
    ))].sort();
    
    productSelect.innerHTML = '<option value="">All Products</option>' +
      products.map(product => `<option value="${product}">${product}</option>`).join('');
  }
  // Modal methods
  openModal(modalId) {
    document.getElementById(modalId).classList.add('active');
    document.body.style.overflow = 'hidden';
  }
  closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
    document.body.style.overflow = '';
  }
  openCustomerDetails(customerId) {
    const customer = this.state.data.contacts.find(c => c.id === customerId);
    if (!customer) return;
    
    const customerOrders = this.state.data.orders.filter(order => order.customerId === customerId);
    const totalOrders = customerOrders.length;
    const totalLbs = customerOrders.reduce((sum, order) =>
      sum + order.items.reduce((itemSum, item) => itemSum + (item.lbs || 0), 0), 0);
    const totalValue = customerOrders.reduce((sum, order) =>
      sum + order.items.reduce((itemSum, item) =>
        itemSum + ((item.lbs || 0) * (this.state.data.fruitPrices[item.fruit] || 0)), 0), 0);
    
    document.getElementById('modal-customer-title').textContent = customer.name;
    document.getElementById('modal-customer-body').innerHTML = `
      <div class="card">
        <h3>Contact Information</h3>
        <div class="customer-meta">
          <div class="customer-field">üìß ${customer.email || 'No email'}</div>
          <div class="customer-field">üìû ${customer.phone || 'No phone'}</div>
          <div class="customer-field">üìç ${customer.address || 'No address'}</div>
        </div>
      </div>
      <div class="card">
        <h3>Order Summary</h3>
        <div class="customer-stats">
          <div class="stat">
            <span class="stat-value">${totalOrders}</span>
            <span class="stat-label">Total Orders</span>
          </div>
          <div class="stat">
            <span class="stat-value">${this.formatLbs(totalLbs)}</span>
            <span class="stat-label">Total lbs</span>
          </div>
          <div class="stat">
            <span class="stat-value">${this.formatDollar(totalValue)}</span>
            <span class="stat-label">Total Value</span>
          </div>
        </div>
      </div>
      ${totalOrders > 0 ? `
        <div class="card">
          <h3>Recent Orders</h3>
          <div class="order-items">
            ${customerOrders.slice(0, 3).map(order => {
              const orderValue = this.calculateOrderValue(order);
              return `
                <div class="order-item-detail" onclick="app.openOrderDetails('${order.id}')">
                  <div class="order-item-info">
                    <span class="order-item-name">${order.id}</span>
                    <span class="order-item-meta">${order.date} ‚Ä¢ ${this.formatLbs(order.items.reduce((sum, item) => sum + (item.lbs || 0), 0))}</span>
                  </div>
                  <span>${this.formatDollar(orderValue)}</span>
                </div>
              `;
            }).join('')}
          </div>
          ${totalOrders > 3 ? `<p class="text-muted">+ ${totalOrders - 3} more orders</p>` : ''}
        </div>
      ` : ''}
    `;
    
    this.openModal('modal-customer');
  }
  openOrderDetails(orderId) {
    const order = this.state.data.orders.find(o => o.id === orderId);
    if (!order) return;
    
    const customer = this.state.data.contacts.find(c => c.id === order.customerId);
    const totalLbs = order.items.reduce((sum, item) => sum + (item.lbs || 0), 0);
    const totalValue = this.calculateOrderValue(order);
    
    document.getElementById('modal-order-title').textContent = `Order: ${order.id}`;
    document.getElementById('modal-order-body').innerHTML = `
      <div class="card">
        <h3>Order Information</h3>
        <div class="customer-meta">
          <div class="customer-field">üìÖ ${order.date}</div>
          <div class="customer-field">üë§ ${customer ? customer.name : 'Unknown Customer'}</div>
          <div class="customer-field">üìç ${order.city}, ${order.province}</div>
        </div>
      </div>
      <div class="card">
        <h3>Order Items</h3>
        <div class="order-items">
          ${order.items.map(item => {
            const itemValue = (item.lbs || 0) * (this.state.data.fruitPrices[item.fruit] || 0);
            return `
              <div class="order-item-detail">
                <div class="order-item-info">
                  <span class="order-item-name">${item.fruit}</span>
                  <span class="order-item-meta">${this.formatLbs(item.lbs)} √ó ${this.formatDollar(this.state.data.fruitPrices[item.fruit] || 0)}</span>
                </div>
                <span>${this.formatDollar(itemValue)}</span>
              </div>
            `;
          }).join('')}
        </div>
        <div class="order-total">
          <span>Order Total</span>
          <span>${this.formatDollar(totalValue)}</span>
        </div>
      </div>
    `;
    
    // Set up the view customer button
    document.getElementById('btn-view-customer').onclick = () => {
      if (customer) {
        this.closeModal('modal-order');
        this.openCustomerDetails(customer.id);
      }
    };
    
    this.openModal('modal-order');
  }
  openDriverPrepModal() {
    const filteredOrders = this.getFilteredOrders();
    const fruitAgg = this.aggregateByFruit(filteredOrders);
    const stops = this.aggregateStops(filteredOrders);
    
    const totalLbs = Object.values(fruitAgg).reduce((sum, lbs) => sum + lbs, 0);
    const totalValue = filteredOrders.reduce((sum, order) => {
      return sum + order.items.reduce((orderSum, item) => {
        if (this.state.prepFilters.fruits.length === 0 ||
            this.state.prepFilters.fruits.includes(item.fruit)) {
          return orderSum + ((item.lbs || 0) * (this.state.data.fruitPrices[item.fruit] || 0));
        }
        return orderSum;
      }, 0);
    }, 0);
    
    const fruitRows = Object.entries(fruitAgg).map(([fruit, preLbs]) => {
      const bufferLbs = Math.round(preLbs * this.state.prepFilters.bufferPct / 100);
      const totalLbs = preLbs + bufferLbs;
      return `<tr>
        <td>${fruit}</td>
        <td>${this.formatLbs(preLbs)}</td>
        <td>${this.formatLbs(bufferLbs)}</td>
        <td><strong>${this.formatLbs(totalLbs)}</strong></td>
      </tr>`;
    }).join('') || '<tr><td colspan="4">No fruits</td></tr>';
    
    const stopRows = stops.map(stop => `
      <tr>
        <td>${stop.city}</td>
        <td>${stop.arrive}</td>
        <td>${stop.depart}</td>
        <td>${stop.orders}</td>
        <td>${this.formatLbs(stop.lbs)}</td>
        <td>${this.formatDollar(stop.value)}</td>
      </tr>
    `).join('') || '<tr><td colspan="6">No stops</td></tr>';
    
    document.getElementById('modal-prep-body').innerHTML = `
      <div class="driver-prep-summary">
        <div class="driver-prep-card">
          <div class="driver-prep-label">Total Pre-orders</div>
          <div class="driver-prep-value">${this.formatLbs(totalLbs)}</div>
        </div>
        <div class="driver-prep-card">
          <div class="driver-prep-label">Orders</div>
          <div class="driver-prep-value">${filteredOrders.length}</div>
        </div>
        <div class="driver-prep-card">
          <div class="driver-prep-label">Total Value</div>
          <div class="driver-prep-value">${this.formatDollar(totalValue)}</div>
        </div>
      </div>
      
      <div class="panel">
        <h3>What to Load</h3>
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>Fruit</th>
                <th>Pre-orders</th>
                <th>+ Buffer</th>
                <th>Total to Load</th>
              </tr>
            </thead>
            <tbody>${fruitRows}</tbody>
          </table>
        </div>
      </div>
      
      <div class="panel">
        <h3>Stops</h3>
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>City</th>
                <th>Arrival</th>
                <th>Departure</th>
                <th>Orders</th>
                <th>lbs</th>
                <th>Value</th>
              </tr>
            </thead>
            <tbody>${stopRows}</tbody>
          </table>
        </div>
      </div>
    `;
    
    this.openModal('modal-prep');
  }
  // Navigation between views
  useCustomerInDriverPrep() {
    // Apply customer's data to driver prep filters
    this.switchView('prep');
    this.closeModal('modal-customer');
  }
  viewCustomerOrders() {
    this.switchView('orders');
    this.closeModal('modal-customer');
  }
  viewOrderCustomer() {
    this.switchView('customers');
    this.closeModal('modal-order');
  }
  // Utility methods
  calculateOrderValue(order) {
    return order.items.reduce((sum, item) =>
      sum + ((item.lbs || 0) * (this.state.data.fruitPrices[item.fruit] || 0)), 0);
  }
  formatLbs(lbs) {
    return `${Number(lbs || 0).toLocaleString()} lbs`;
  }
  formatDollar(amount) {
    return `$${Number(amount || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
  }
  resetFilters() {
    this.state.prepFilters = {
      date: new Date().toISOString().slice(0,10),
      province: '',
      city: '',
      bufferPct: 10,
      fruits: []
    };
    
    // Reset UI elements
    document.getElementById('prep-filter-date').value = this.state.prepFilters.date;
    document.getElementById('filter-date').value = this.state.prepFilters.date;
    document.getElementById('prep-filter-province').value = '';
    document.getElementById('filter-province').value = '';
    document.getElementById('prep-filter-city').value = '';
    document.getElementById('filter-city').value = '';
    document.getElementById('buffer').value = '10';
    document.getElementById('buffer-val').textContent = '10%';
    
    // Reset fruit checkboxes
    document.querySelectorAll('#fruit-filter input[type="checkbox"]').forEach(checkbox => {
      checkbox.checked = false;
    });
    
    this.updateCityOptions();
    this.updateDateHighlighting();
  }
  exportPrepCSV() {
    const filteredOrders = this.getFilteredOrders();
    const fruitAgg = this.aggregateByFruit(filteredOrders);
    const stops = this.aggregateStops(filteredOrders);
    
    let csv = "Driver Prep Summary\n\n";
    csv += "Filters\n";
    csv += `Date,${this.state.prepFilters.date || 'All'}\n`;
    csv += `Province,${this.state.prepFilters.province || 'All'}\n`;
    csv += `City,${this.state.prepFilters.city || 'All'}\n`;
    csv += `Buffer,${this.state.prepFilters.bufferPct}%\n`;
    csv += `Fruits,${this.state.prepFilters.fruits.join(', ') || 'All'}\n\n`;
    
    csv += "Fruit Loading Plan\n";
    csv += "Fruit,Pre-orders (lbs),Buffer (lbs),Total to Load (lbs)\n";
    Object.entries(fruitAgg).forEach(([fruit, preLbs]) => {
      const bufferLbs = Math.round(preLbs * this.state.prepFilters.bufferPct / 100);
      const totalLbs = preLbs + bufferLbs;
      csv += `${fruit},${preLbs},${bufferLbs},${totalLbs}\n`;
    });
    
    csv += "\nStops\n";
    csv += "City,Arrival,Departure,Orders,lbs,Value\n";
    stops.forEach(stop => {
      csv += `${stop.city},${stop.arrive},${stop.depart},${stop.orders},${stop.lbs},${stop.value}\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `driver-prep-${this.state.prepFilters.date || 'all'}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
}
// Initialize the app
const app = new DriverPrepApp();
// Make app globally available for onclick handlers
window.app = app;
</script>
</body>
</html>
