<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>BerryFarm Analytics Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <style>
        :root {
            /* Light Theme */
            --bg-light: #f8fafc;
            --card-light: #ffffff;
            --border-light: #e2e8f0;
            --text-light: #1e293b;
            --muted-light: #64748b;
            --primary-light: #3b82f6;
            --success-light: #10b981;
            --warning-light: #f59e0b;
            --danger-light: #ef4444;
            
            /* Dark Theme */
            --bg-dark: #0b0e1b;
            --card-dark: #161a31;
            --border-dark: #272a44;
            --text-dark: #e8ebff;
            --muted-dark: #8b90b0;
            --primary-dark: #3b82f6;
            --success-dark: #10b981;
            --warning-dark: #f59e0b;
            --danger-dark: #ef4444;
            
            /* Default to Dark */
            --bg: var(--bg-dark);
            --card: var(--card-dark);
            --border: var(--border-dark);
            --text: var(--text-dark);
            --muted: var(--muted-dark);
            --primary: var(--primary-dark);
            --success: var(--success-dark);
            --warning: var(--warning-dark);
            --danger: var(--danger-dark);
            
            /* Colors for fruits */
            --blueberries: #3b82f6;
            --strawberries: #ef4444;
            --raspberries: #ec4899;
            --peaches: #f97316;
            --cherries: #dc2626;
            --apples: #84cc16;
            --beans: #10b981;
            --grapes: #8b5cf6;
        }
        
        .light-mode {
            --bg: var(--bg-light);
            --card: var(--card-light);
            --border: var(--border-light);
            --text: var(--text-light);
            --muted: var(--muted-light);
            --primary: var(--primary-light);
            --success: var(--success-light);
            --warning: var(--warning-light);
            --danger: var(--danger-light);
        }
        
        * { 
            box-sizing: border-box; 
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            transition: background-color 0.3s ease, color 0.3s ease;
            padding-bottom: 80px; /* Space for mobile nav */
        }
        
        /* Header */
        .header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--card);
            padding: 14px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            font-size: 18px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .theme-toggle {
            background: none;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 12px;
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }
        
        /* Per-Tab Filter Button */
        .view-filter-btn {
            background: none;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 12px;
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }
        
        /* Layout */
        .layout {
            display: flex;
            min-height: calc(100vh - 60px);
        }
        
        /* Desktop Sidebar Navigation */
        .sidebar {
            width: 250px;
            background: var(--card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            transition: transform 0.3s ease;
            overflow-y: auto;
            position: fixed;
            left: 0;
            top: 60px;
            bottom: 0;
            z-index: 90;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: var(--muted);
            text-decoration: none;
            white-space: nowrap;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .nav-item:hover {
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary);
        }
        
        .nav-item.active {
            background: rgba(59, 130, 246, 0.15);
            color: var(--primary);
        }
        
        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--primary);
        }
        
        .nav-icon {
            font-size: 20px;
            min-width: 24px;
        }
        
        .nav-text {
            margin-left: 12px;
            font-size: 14px;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            margin-left: 250px; /* Account for sidebar */
            transition: margin-left 0.3s ease, padding-top 0.3s ease;
        }
        
        .main-content.no-sidebar {
            margin-left: 0;
        }
        
        /* View Filter Bar - Desktop */
        .view-filter-bar {
            background: var(--card);
            padding: 16px;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            display: none; /* Hidden by default */
        }
        
        .view-filter-bar.active {
            display: flex;
        }
        
        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(3px);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            background: var(--card);
            border-radius: 12px;
            overflow: hidden;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--text);
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }
        
        .modal-close:hover {
            background: rgba(0, 0, 0, 0.1);
        }
        
        .modal-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        /* Customer Purchase Grid/List View */
        .purchase-view-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .view-toggle-btn {
            padding: 6px 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            cursor: pointer;
            font-size: 12px;
        }
        
        .view-toggle-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .purchase-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }
        
        .purchase-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
        }
        
        .purchase-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .purchase-item {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Map Container */
        .map-container {
            height: 400px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--muted);
            position: relative;
            overflow: hidden;
        }
        
        .map-placeholder {
            text-align: center;
            padding: 20px;
        }
        
        .province-map {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .province-item {
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.7;
        }
        
        .province-item:hover {
            opacity: 1;
            transform: scale(1.05);
        }
        
        .province-item.active {
            opacity: 1;
            fill: var(--primary);
            stroke: var(--primary);
            stroke-width: 2;
        }
        
        /* Geography Drill Down */
        .geography-breadcrumb {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        .breadcrumb-item {
            padding: 4px 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .breadcrumb-item:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: var(--primary);
        }
        
        .breadcrumb-item.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* Filter Group */
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 150px;
        }
        
        .filter-label {
            font-size: 12px;
            color: var(--muted);
            font-weight: 500;
        }
        
        .filter-select {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 12px;
            color: var(--text);
            font-size: 13px;
            outline: none;
            cursor: pointer;
        }
        
        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .kpi-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
        }
        
        .kpi-card.leads::before { background: var(--primary); }
        .kpi-card.customers::before { background: var(--success); }
        .kpi-card.transactions::before { background: var(--warning); }
        .kpi-card.conversion::before { background: var(--danger); }
        
        .kpi-title {
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 8px;
        }
        
        .kpi-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 6px;
        }
        
        .kpi-trend {
            font-size: 12px;
        }
        
        .kpi-trend.positive {
            color: var(--success);
        }
        
        .kpi-trend.negative {
            color: var(--danger);
        }
        
        /* Tables */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--border);
            margin-top: 20px;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .table th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: var(--muted);
            border-bottom: 1px solid var(--border);
            background: var(--bg);
        }
        
        .table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }
        
        .table tbody tr:hover {
            background: rgba(59, 130, 246, 0.05);
        }
        
        /* Calendar Styles */
        .calendar-container {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .calendar-nav {
            display: flex;
            gap: 10px;
        }
        
        .calendar-nav-btn {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 12px;
            color: var(--text);
            cursor: pointer;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            border-radius: 6px;
            background: var(--bg);
            position: relative;
        }
        
        .calendar-day.other-month {
            color: var(--muted);
            opacity: 0.5;
        }
        
        .calendar-day.has-pickup {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: var(--success);
            font-weight: 600;
        }
        
        .calendar-day.today {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.3);
            font-weight: 700;
        }
        
        .pickup-count {
            position: absolute;
            bottom: 2px;
            right: 2px;
            font-size: 10px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Fruit Cards */
        .fruit-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }
        
        .fruit-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .fruit-card:hover {
            transform: translateY(-2px);
        }
        
        .fruit-card.active {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.05);
        }
        
        .fruit-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }
        
        .fruit-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .fruit-metric {
            font-size: 18px;
            font-weight: 700;
        }
        
        /* Mobile Navigation */
        .mobile-nav {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--card);
            border-top: 1px solid var(--border);
            z-index: 100;
            display: none;
            padding: 8px 0;
        }
        
        .mobile-nav-content {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        
        .mobile-nav-button {
            background: none;
            border: none;
            color: var(--muted);
            font-size: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 10px;
            transition: all 0.3s ease;
            min-width: 60px;
        }
        
        .mobile-nav-button:hover {
            background: rgba(59, 130, 246, 0.1);
            color: var(--text);
        }
        
        .mobile-nav-button.active {
            background: rgba(59, 130, 246, 0.15);
            color: var(--primary);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .mobile-nav-icon {
            font-size: 20px;
        }
        
        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: var(--text);
            font-size: 20px;
            cursor: pointer;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                display: none;
            }
            
            .sidebar.show {
                transform: translateX(0);
                display: flex;
            }
            
            .main-content {
                margin-left: 0;
                padding: 16px;
                padding-bottom: 100px; /* Extra space for mobile nav */
            }
            
            .mobile-nav {
                display: block;
            }
            
            .mobile-menu-btn {
                display: block;
            }
            
            .view-filter-bar {
                display: none !important; /* Hide desktop filters on mobile */
            }
            
            .mobile-view-filter-overlay {
                display: block;
            }
            
            .kpi-grid {
                grid-template-columns: 1fr;
            }
            
            .fruit-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .calendar-grid {
                grid-template-columns: repeat(7, 1fr);
                gap: 2px;
            }
            
            .modal {
                width: 95%;
                max-height: 80vh;
            }
        }
        
        @media (min-width: 1025px) {
            .mobile-nav {
                display: none;
            }
            
            .mobile-menu-btn {
                display: none;
            }
            
            .mobile-view-filter-overlay {
                display: none !important;
            }
        }
        
        /* View containers */
        .view {
            display: none;
        }
        
        .view.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Status badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .status-lead {
            background: rgba(59, 130, 246, 0.15);
            color: #93c5fd;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .status-customer {
            background: rgba(16, 185, 129, 0.15);
            color: #6ee7b7;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        /* Metric change indicator */
        .metric-change {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            margin-left: 6px;
        }
        
        .metric-change.negative {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
        
        /* Active filters display */
        .active-filters {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            font-size: 13px;
        }
        
        .filter-chip {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 16px;
            padding: 4px 10px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .filter-chip button {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            padding: 2px;
            font-size: 14px;
        }
        
        /* Contact Row Clickable */
        .contact-row {
            cursor: pointer;
        }
        
        .contact-row:hover {
            background: rgba(59, 130, 246, 0.08) !important;
        }
        
        /* Mobile Filter Overlay for Views */
        .mobile-view-filter-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 200;
            backdrop-filter: blur(3px);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .mobile-view-filter-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .mobile-view-filter-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            max-width: 400px;
            height: 100vh;
            background: var(--card);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            z-index: 210;
            overflow-y: auto;
        }
        
        .mobile-view-filter-overlay.show .mobile-view-filter-panel {
            transform: translateX(0);
        }
        
        .mobile-view-filter-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .mobile-view-filter-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .mobile-view-filter-close {
            background: none;
            border: none;
            color: var(--text);
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
        }
        
        .mobile-view-filter-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .mobile-view-filter-actions {
            padding: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
        }
        
        .mobile-view-filter-btn {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }
        
        .mobile-view-filter-btn.apply {
            background: var(--primary);
            color: white;
        }
        
        .mobile-view-filter-btn.clear {
            background: var(--card);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        /* Range Input Styles */
        .range-input-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .range-input {
            flex: 1;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 12px;
            color: var(--text);
            font-size: 13px;
            outline: none;
        }
        
        /* View Tabs Navigation */
        .view-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
        }
        
        .view-tab {
            padding: 8px 16px;
            background: none;
            border: none;
            color: var(--muted);
            cursor: pointer;
            font-size: 14px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        
        .view-tab:hover {
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary);
        }
        
        .view-tab.active {
            background: rgba(59, 130, 246, 0.15);
            color: var(--primary);
            font-weight: 600;
        }
    </style>
</head>
<body class="dark-mode">
    <!-- Header -->
    <header class="header">
        <button class="mobile-menu-btn" id="mobileMenuBtn">‚ò∞</button>
        <div class="logo">
            <span>üçì</span>
            <span id="page-title">BerryFarm Analytics</span>
        </div>
        <div class="header-right">
            <button class="view-filter-btn" id="viewFilterBtn">
                <span>‚öôÔ∏è</span>
                <span id="viewFilterText">Filters</span>
            </button>
            <button class="theme-toggle" id="themeToggle">
                <span class="theme-icon">üåô</span>
                <span class="theme-text">Dark</span>
            </button>
        </div>
    </header>

    <!-- Mobile Filter Overlay for Views -->
    <div class="mobile-view-filter-overlay" id="mobileViewFilterOverlay">
        <div class="mobile-view-filter-panel">
            <div class="mobile-view-filter-header">
                <h3 class="mobile-view-filter-title" id="mobileViewFilterTitle">Filters</h3>
                <button class="mobile-view-filter-close" id="mobileViewFilterClose">‚úï</button>
            </div>
            <div class="mobile-view-filter-content" id="mobileViewFilterContent">
                <!-- Filter content will be populated based on current view -->
            </div>
            <div class="mobile-view-filter-actions">
                <button class="mobile-view-filter-btn clear" id="mobileViewFilterClear">Clear All</button>
                <button class="mobile-view-filter-btn apply" id="mobileViewFilterApply">Apply Filters</button>
            </div>
        </div>
    </div>

    <!-- Contact Modal -->
    <div class="modal-overlay" id="contactModalOverlay">
        <div class="modal" id="contactModal">
            <div class="modal-header">
                <h3 class="modal-title" id="contactModalTitle">Contact Details</h3>
                <button class="modal-close" id="contactModalClose">‚úï</button>
            </div>
            <div class="modal-content" id="contactModalContent">
                <!-- Contact details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Desktop Sidebar Navigation -->
    <nav class="sidebar" id="sidebar">
        <div style="padding: 20px; border-bottom: 1px solid var(--border); margin-bottom: 20px;">
            <div style="font-weight: 600; font-size: 16px;">Main Navigation</div>
            <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">Dashboard v1.1</div>
        </div>
        
        <a href="#" class="nav-item active" data-view="main">
            <span class="nav-icon">üìä</span>
            <span class="nav-text">Dashboard</span>
        </a>
        <a href="#" class="nav-item" data-view="customers">
            <span class="nav-icon">üë•</span>
            <span class="nav-text">Customers & Leads</span>
        </a>
        <a href="#" class="nav-item" data-view="fruits">
            <span class="nav-icon">üçì</span>
            <span class="nav-text">Fruit Analytics</span>
        </a>
        <a href="#" class="nav-item" data-view="geography">
            <span class="nav-icon">üìç</span>
            <span class="nav-text">Geography</span>
        </a>
        <a href="#" class="nav-item" data-view="calendar">
            <span class="nav-icon">üìÜ</span>
            <span class="nav-text">Calendar</span>
        </a>
        
        <div style="margin-top: auto; padding: 20px; border-top: 1px solid var(--border);">
            <div style="font-size: 12px; color: var(--muted);">
                <div>üë§ Team Access</div>
                <div style="font-size: 10px; margin-top: 4px;">Connected to Supabase</div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content" id="mainContent">
        <!-- Dashboard Filter Bar -->
        <div class="view-filter-bar" id="main-filter-bar">
            <div class="filter-group">
                <div class="filter-label">Year</div>
                <select class="filter-select" id="mainYearSelect">
                    <option value="all">All Years</option>
                    <option value="2023">2023</option>
                    <option value="2024" selected>2024</option>
                    <option value="2025">2025</option>
                </select>
            </div>
            
            <div class="filter-group">
                <div class="filter-label">Province</div>
                <select class="filter-select" id="mainProvinceSelect">
                    <option value="all">All Provinces</option>
                </select>
            </div>
        </div>

        <!-- Customers Filter Bar -->
        <div class="view-filter-bar" id="customers-filter-bar">
            <div class="filter-group">
                <div class="filter-label">Acquisition Year</div>
                <select class="filter-select" id="customersYearSelect">
                    <option value="all">All Years</option>
                    <option value="2023">2023</option>
                    <option value="2024" selected>2024</option>
                    <option value="2025">2025</option>
                </select>
            </div>
            
            <div class="filter-group">
                <div class="filter-label">Province</div>
                <select class="filter-select" id="customersProvinceSelect">
                    <option value="all">All Provinces</option>
                </select>
            </div>
            
            <div class="filter-group">
                <div class="filter-label">Region</div>
                <select class="filter-select" id="customersRegionSelect" disabled>
                    <option value="all">All Regions</option>
                </select>
            </div>
            
            <div class="filter-group">
                <div class="filter-label">City</div>
                <select class="filter-select" id="customersCitySelect" disabled>
                    <option value="all">All Cities</option>
                </select>
            </div>
            
            <div class="filter-group">
                <div class="filter-label">Status</div>
                <select class="filter-select" id="customersStatusSelect">
                    <option value="all">All Status</option>
                    <option value="lead">Leads Only</option>
                    <option value="customer">Customers Only</option>
                </select>
            </div>
            
            <div class="filter-group" id="customerMetricsGroup">
                <div class="filter-label">Min Transactions</div>
                <input type="number" class="range-input" id="minTransactions" min="0" placeholder="Any">
            </div>
            
            <div class="filter-group">
                <div class="filter-label">Min Total Value</div>
                <input type="number" class="range-input" id="minTotalValue" min="0" placeholder="Any">
            </div>
        </div>

        <!-- Fruits Filter Bar -->
        <div class="view-filter-bar" id="fruits-filter-bar">
            <div class="filter-group">
                <div class="filter-label">Year/Month</div>
                <select class="filter-select" id="fruitsTimeSelect">
                    <option value="all">All Time</option>
                    <option value="2024" selected>2024</option>
                    <option value="2023">2023</option>
                </select>
            </div>
            
            <div class="filter-group">
                <div class="filter-label">Province</div>
                <select class="filter-select" id="fruitsProvinceSelect">
                    <option value="all">All Provinces</option>
                </select>
            </div>
            
            <div class="filter-group">
                <div class="filter-label">Region</div>
                <select class="filter-select" id="fruitsRegionSelect" disabled>
                    <option value="all">All Regions</option>
                </select>
            </div>
            
            <div class="filter-group">
                <div class="filter-label">City</div>
                <select class="filter-select" id="fruitsCitySelect" disabled>
                    <option value="all">All Cities</option>
                </select>
            </div>
            
            <div class="filter-group">
                <div class="filter-label">Fruit Category</div>
                <select class="filter-select" id="fruitsCategorySelect">
                    <option value="all">All Categories</option>
                    <option value="berry">Berries</option>
                    <option value="stone">Stone Fruits</option>
                    <option value="veggie">Vegetables</option>
                </select>
            </div>
        </div>

        <!-- Active Filters Display -->
        <div class="active-filters" id="activeFilters">
            <span style="color: var(--muted);">Active Filters:</span>
            <!-- Filter chips will be added here -->
        </div>

        <!-- Dashboard View -->
        <div id="view-main" class="view active">
            <!-- KPI Grid -->
            <div class="kpi-grid">
                <div class="kpi-card leads">
                    <div class="kpi-title">Total Leads</div>
                    <div class="kpi-value" id="kpi-leads">0</div>
                    <div class="kpi-trend" id="kpi-leads-trend"></div>
                </div>
                
                <div class="kpi-card customers">
                    <div class="kpi-title">Active Customers</div>
                    <div class="kpi-value" id="kpi-customers">0</div>
                    <div class="kpi-trend" id="kpi-customers-trend"></div>
                </div>
                
                <div class="kpi-card transactions">
                    <div class="kpi-title">Total Transactions</div>
                    <div class="kpi-value" id="kpi-transactions">0</div>
                    <div class="kpi-trend" id="kpi-transactions-trend"></div>
                </div>
                
                <div class="kpi-card conversion">
                    <div class="kpi-title">Conversion Rate</div>
                    <div class="kpi-value" id="kpi-conversion">0%</div>
                    <div class="kpi-trend" id="kpi-conversion-trend"></div>
                </div>
            </div>

            <!-- Customer Cohort Analysis -->
            <div class="calendar-container">
                <div class="calendar-header">
                    <h3>Customer Cohort Analysis</h3>
                </div>
                <div class="table-container">
                    <table class="table" id="cohort-table">
                        <thead>
                            <tr>
                                <th>Cohort Year</th>
                                <th>Customers Acquired</th>
                                <th>Year 1 Retention</th>
                                <th>Year 2 Retention</th>
                                <th>Avg Lifetime Value</th>
                                <th>Avg Visits</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Recent Transactions -->
            <div class="calendar-container" style="margin-top: 20px;">
                <div class="calendar-header">
                    <h3>Recent Transactions</h3>
                </div>
                <div class="table-container">
                    <table class="table" id="recent-transactions">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>City</th>
                                <th>Amount</th>
                                <th>Fruits</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Customers View -->
        <div id="view-customers" class="view">
            <div class="view-tabs" id="customersViewTabs">
                <button class="view-tab active" data-subview="contacts">Contacts List</button>
                <button class="view-tab" data-subview="analysis">Customer Analysis</button>
            </div>
            
            <div id="customers-contacts-subview" class="view-subview active">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <h3>Customers & Leads</h3>
                        <div>
                            <button class="view-toggle-btn active" data-purchase-view="grid">Grid</button>
                            <button class="view-toggle-btn" data-purchase-view="list">List</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table" id="customers-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>City</th>
                                    <th>Province</th>
                                    <th>Status</th>
                                    <th>Acquired</th>
                                    <th>Transactions</th>
                                    <th>Total Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="customers-analysis-subview" class="view-subview">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <h3>Customer Analysis</h3>
                    </div>
                    <div class="table-container">
                        <table class="table" id="customer-analysis-table">
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th>Value</th>
                                    <th>Trend</th>
                                    <th>Insight</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Analysis data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fruit Analytics View -->
        <div id="view-fruits" class="view">
            <div class="calendar-container">
                <div class="calendar-header">
                    <h3>Fruit Performance</h3>
                </div>
                <div class="fruit-grid" id="fruit-grid">
                    <!-- Fruit cards will be populated here -->
                </div>
                
                <div style="margin-top: 30px;">
                    <div class="calendar-header">
                        <h3>Top Fruits by Sales</h3>
                    </div>
                    <div class="table-container">
                        <table class="table" id="fruit-sales-table">
                            <thead>
                                <tr>
                                    <th>Fruit</th>
                                    <th>Category</th>
                                    <th>Pounds Sold</th>
                                    <th>Sales Revenue</th>
                                    <th>Avg per Customer</th>
                                    <th>Avg per Transaction</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Geography View -->
        <div id="view-geography" class="view">
            <div class="geography-breadcrumb" id="geographyBreadcrumb">
                <div class="breadcrumb-item active" data-level="country">Canada</div>
                <div style="color: var(--muted);">‚Ä∫</div>
                <div class="breadcrumb-item" data-level="province" style="display: none;">Select Province</div>
                <div style="color: var(--muted); display: none;">‚Ä∫</div>
                <div class="breadcrumb-item" data-level="region" style="display: none;">Select Region</div>
                <div style="color: var(--muted); display: none;">‚Ä∫</div>
                <div class="breadcrumb-item" data-level="city" style="display: none;">Select City</div>
            </div>

            <div class="map-container">
                <div class="map-placeholder" id="mapPlaceholder">
                    <div style="font-size: 24px; margin-bottom: 12px;">üó∫Ô∏è</div>
                    <h3>Revenue Map</h3>
                    <p style="margin-top: 8px; font-size: 14px;">Select a province to view detailed revenue distribution</p>
                </div>
                <svg class="province-map" id="provinceMap" viewBox="0 0 800 400" style="display: none;">
                    <!-- SVG map will be generated here -->
                </svg>
            </div>

            <div class="calendar-container">
                <div class="calendar-header">
                    <h3 id="geographyTableTitle">Revenue by Province</h3>
                </div>
                <div class="table-container">
                    <table class="table" id="geography-table">
                        <thead>
                            <tr id="geography-table-headers">
                                <th>Province</th>
                                <th>2023 Revenue</th>
                                <th>2024 Revenue</th>
                                <th>2025 Revenue</th>
                                <th>Total Revenue</th>
                                <th>Customers</th>
                                <th>Avg per Customer</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Calendar View -->
        <div id="view-calendar" class="view">
            <div class="calendar-container">
                <div class="calendar-header">
                    <h3>Pickup Calendar - <span id="current-month-year">December 2024</span></h3>
                    <div class="calendar-nav">
                        <button class="calendar-nav-btn" id="prev-month">‚Üê</button>
                        <button class="calendar-nav-btn" id="today-btn">Today</button>
                        <button class="calendar-nav-btn" id="next-month">‚Üí</button>
                    </div>
                </div>
                
                <div class="calendar-grid" id="calendar-grid">
                    <!-- Calendar will be generated here -->
                </div>
            </div>

            <div class="calendar-container" style="margin-top: 20px;">
                <div class="calendar-header">
                    <h3>Today's Pickups</h3>
                    <div style="font-size: 12px; color: var(--muted);">
                        <span id="today-date">December 3, 2024</span> ‚Ä¢ 
                        <span id="pickup-count">0</span> pickups scheduled
                    </div>
                </div>
                <div class="table-container">
                    <table class="table" id="today-pickups">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Customer</th>
                                <th>Location</th>
                                <th>Order Total</th>
                                <th>Items</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Pickups will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Mobile Navigation (Bottom) -->
    <nav class="mobile-nav">
        <div class="mobile-nav-content">
            <button class="mobile-nav-button active" data-view="main">
                <span class="mobile-nav-icon">üìä</span>
                <span>Dashboard</span>
            </button>
            <button class="mobile-nav-button" data-view="customers">
                <span class="mobile-nav-icon">üë•</span>
                <span>Customers</span>
            </button>
            <button class="mobile-nav-button" data-view="fruits">
                <span class="mobile-nav-icon">üçì</span>
                <span>Fruit</span>
            </button>
            <button class="mobile-nav-button" data-view="geography">
                <span class="mobile-nav-icon">üìç</span>
                <span>Geography</span>
            </button>
            <button class="mobile-nav-button" data-view="calendar">
                <span class="mobile-nav-icon">üìÜ</span>
                <span>Calendar</span>
            </button>
        </div>
    </nav>

    <script>
        // Enhanced Sample Data
        const sampleData = {
            contacts: [
                {
                    BhavsContactID: "BC001",
                    MainCustomerContactID: "",
                    GHLContactId: "GH001",
                    "Pickup City": "Kelowna",
                    Province: "BC",
                    Region: "Okanagan",
                    Email: "john@example.com",
                    "First Name": "John",
                    "Last Name": "Smith",
                    Phone: "+12505550123",
                    "Lead Acquisition Date": "2023-05-15",
                    "Lead/Customer Status": "customer"
                },
                {
                    BhavsContactID: "BC002",
                    MainCustomerContactID: "",
                    GHLContactId: "GH002",
                    "Pickup City": "Kelowna",
                    Province: "BC",
                    Region: "Okanagan",
                    Email: "sarah@example.com",
                    "First Name": "Sarah",
                    "Last Name": "Johnson",
                    Phone: "+12505550124",
                    "Lead Acquisition Date": "2023-06-20",
                    "Lead/Customer Status": "customer"
                },
                {
                    BhavsContactID: "BC003",
                    MainCustomerContactID: "",
                    GHLContactId: "GH003",
                    "Pickup City": "Vancouver",
                    Province: "BC",
                    Region: "Lower Mainland",
                    Email: "mike@example.com",
                    "First Name": "Mike",
                    "Last Name": "Chen",
                    Phone: "+16045550125",
                    "Lead Acquisition Date": "2024-01-10",
                    "Lead/Customer Status": "customer"
                },
                {
                    BhavsContactID: "BC004",
                    MainCustomerContactID: "",
                    GHLContactId: "GH004",
                    "Pickup City": "Calgary",
                    Province: "AB",
                    Region: "Calgary Region",
                    Email: "lisa@example.com",
                    "First Name": "Lisa",
                    "Last Name": "Wilson",
                    Phone: "+14035550126",
                    "Lead Acquisition Date": "2024-02-15",
                    "Lead/Customer Status": "lead"
                },
                {
                    BhavsContactID: "BC005",
                    MainCustomerContactID: "",
                    GHLContactId: "GH005",
                    "Pickup City": "Edmonton",
                    Province: "AB",
                    Region: "Edmonton Region",
                    Email: "david@example.com",
                    "First Name": "David",
                    "Last Name": "Brown",
                    Phone: "+17805550127",
                    "Lead Acquisition Date": "2024-03-20",
                    "Lead/Customer Status": "customer"
                },
                {
                    BhavsContactID: "BC006",
                    MainCustomerContactID: "",
                    GHLContactId: "GH006",
                    "Pickup City": "Toronto",
                    Province: "ON",
                    Region: "Golden Horseshoe",
                    Email: "emma@example.com",
                    "First Name": "Emma",
                    "Last Name": "Davis",
                    Phone: "+14165550128",
                    "Lead Acquisition Date": "2024-04-25",
                    "Lead/Customer Status": "lead"
                },
                {
                    BhavsContactID: "BC007",
                    MainCustomerContactID: "",
                    GHLContactId: "GH007",
                    "Pickup City": "Penticton",
                    Province: "BC",
                    Region: "Okanagan",
                    Email: "robert@example.com",
                    "First Name": "Robert",
                    "Last Name": "Taylor",
                    Phone: "+12505550129",
                    "Lead Acquisition Date": "2024-05-30",
                    "Lead/Customer Status": "customer"
                }
            ],
            transactions: [
                {
                    "New Unique Id": "BC001",
                    "Pickup City": "Kelowna",
                    "Customer Name": "John Smith",
                    Email: "john@example.com",
                    Source: "Website",
                    "Card Brand": "Visa",
                    "PAN Suffix": "1234",
                    "Gross Sales": 85.00,
                    "Net Total": 82.45,
                    Discounts: 0.0,
                    "Service Charges": 2.55,
                    Fees: 0.0,
                    "Order ID": "ORD001",
                    "Customer ID": "CUST001",
                    "Transaction ID": "TXN001",
                    Date: "2024-06-15",
                    "Event Type": "Payment",
                    "Line Items": "Blueberries x4",
                    Nectarines: 0,
                    "Frozen Blueberries": 0,
                    "Blueberries Pound": 4.0,
                    "Peaches Pound": 0,
                    "Blackberries Pound": 0,
                    "Strawberries Pound": 0,
                    "Raspberries Pound": 0,
                    "Cherries Pound": 0,
                    "Apples Pound": 0,
                    "Pears Pound": 0,
                    "Green Beans Pound": 0,
                    "Brussel Sprouts Pound": 0,
                    "English Peas Pound": 0,
                    "Green Table Grapes Pound": 0,
                    "Jalapenos Pound": 0,
                    "Prune Plums Pound": 0,
                    "Russian Garlic Pound": 0
                },
                {
                    "New Unique Id": "BC002",
                    "Pickup City": "Kelowna",
                    "Customer Name": "Sarah Johnson",
                    Email: "sarah@example.com",
                    Source: "Website",
                    "Card Brand": "MasterCard",
                    "PAN Suffix": "5678",
                    "Gross Sales": 120.50,
                    "Net Total": 117.89,
                    Discounts: 0.0,
                    "Service Charges": 2.61,
                    Fees: 0.0,
                    "Order ID": "ORD002",
                    "Customer ID": "CUST002",
                    "Transaction ID": "TXN002",
                    Date: "2024-06-20",
                    "Event Type": "Payment",
                    "Line Items": "Blueberries x6, Strawberries x2",
                    Nectarines: 0,
                    "Frozen Blueberries": 0,
                    "Blueberries Pound": 6.0,
                    "Peaches Pound": 0,
                    "Blackberries Pound": 0,
                    "Strawberries Pound": 2.0,
                    "Raspberries Pound": 0,
                    "Cherries Pound": 0,
                    "Apples Pound": 0,
                    "Pears Pound": 0,
                    "Green Beans Pound": 0,
                    "Brussel Sprouts Pound": 0,
                    "English Peas Pound": 0,
                    "Green Table Grapes Pound": 0,
                    "Jalapenos Pound": 0,
                    "Prune Plums Pound": 0,
                    "Russian Garlic Pound": 0
                },
                {
                    "New Unique Id": "BC001",
                    "Pickup City": "Kelowna",
                    "Customer Name": "John Smith",
                    Email: "john@example.com",
                    Source: "Website",
                    "Card Brand": "Visa",
                    "PAN Suffix": "1234",
                    "Gross Sales": 65.00,
                    "Net Total": 63.38,
                    Discounts: 0.0,
                    "Service Charges": 1.62,
                    Fees: 0.0,
                    "Order ID": "ORD003",
                    "Customer ID": "CUST001",
                    "Transaction ID": "TXN003",
                    Date: "2024-07-10",
                    "Event Type": "Payment",
                    "Line Items": "Peaches x5",
                    Nectarines: 0,
                    "Frozen Blueberries": 0,
                    "Blueberries Pound": 0,
                    "Peaches Pound": 5.0,
                    "Blackberries Pound": 0,
                    "Strawberries Pound": 0,
                    "Raspberries Pound": 0,
                    "Cherries Pound": 0,
                    "Apples Pound": 0,
                    "Pears Pound": 0,
                    "Green Beans Pound": 0,
                    "Brussel Sprouts Pound": 0,
                    "English Peas Pound": 0,
                    "Green Table Grapes Pound": 0,
                    "Jalapenos Pound": 0,
                    "Prune Plums Pound": 0,
                    "Russian Garlic Pound": 0
                },
                {
                    "New Unique Id": "BC003",
                    "Pickup City": "Vancouver",
                    "Customer Name": "Mike Chen",
                    Email: "mike@example.com",
                    Source: "Mobile App",
                    "Card Brand": "Amex",
                    "PAN Suffix": "9012",
                    "Gross Sales": 95.75,
                    "Net Total": 93.74,
                    Discounts: 0.0,
                    "Service Charges": 2.01,
                    Fees: 0.0,
                    "Order ID": "ORD004",
                    "Customer ID": "CUST003",
                    "Transaction ID": "TXN004",
                    Date: "2024-07-15",
                    "Event Type": "Payment",
                    "Line Items": "Raspberries x3, Cherries x2",
                    Nectarines: 0,
                    "Frozen Blueberries": 0,
                    "Blueberries Pound": 0,
                    "Peaches Pound": 0,
                    "Blackberries Pound": 0,
                    "Strawberries Pound": 0,
                    "Raspberries Pound": 3.0,
                    "Cherries Pound": 2.0,
                    "Apples Pound": 0,
                    "Pears Pound": 0,
                    "Green Beans Pound": 0,
                    "Brussel Sprouts Pound": 0,
                    "English Peas Pound": 0,
                    "Green Table Grapes Pound": 0,
                    "Jalapenos Pound": 0,
                    "Prune Plums Pound": 0,
                    "Russian Garlic Pound": 0
                },
                {
                    "New Unique Id": "BC005",
                    "Pickup City": "Edmonton",
                    "Customer Name": "David Brown",
                    Email: "david@example.com",
                    Source: "Website",
                    "Card Brand": "Visa",
                    "PAN Suffix": "3456",
                    "Gross Sales": 150.25,
                    "Net Total": 147.24,
                    Discounts: 0.0,
                    "Service Charges": 3.01,
                    Fees: 0.0,
                    "Order ID": "ORD005",
                    "Customer ID": "CUST005",
                    "Transaction ID": "TXN005",
                    Date: "2024-08-05",
                    "Event Type": "Payment",
                    "Line Items": "Mixed Fruits",
                    Nectarines: 2.0,
                    "Frozen Blueberries": 0,
                    "Blueberries Pound": 3.0,
                    "Peaches Pound": 4.0,
                    "Blackberries Pound": 2.0,
                    "Strawberries Pound": 3.0,
                    "Raspberries Pound": 2.0,
                    "Cherries Pound": 0,
                    "Apples Pound": 0,
                    "Pears Pound": 0,
                    "Green Beans Pound": 0,
                    "Brussel Sprouts Pound": 0,
                    "English Peas Pound": 0,
                    "Green Table Grapes Pound": 0,
                    "Jalapenos Pound": 0,
                    "Prune Plums Pound": 0,
                    "Russian Garlic Pound": 0
                },
                {
                    "New Unique Id": "BC007",
                    "Pickup City": "Penticton",
                    "Customer Name": "Robert Taylor",
                    Email: "robert@example.com",
                    Source: "Website",
                    "Card Brand": "MasterCard",
                    "PAN Suffix": "7890",
                    "Gross Sales": 75.00,
                    "Net Total": 73.50,
                    Discounts: 0.0,
                    "Service Charges": 1.50,
                    Fees: 0.0,
                    "Order ID": "ORD006",
                    "Customer ID": "CUST007",
                    "Transaction ID": "TXN006",
                    Date: "2024-08-10",
                    "Event Type": "Payment",
                    "Line Items": "Apples x8",
                    Nectarines: 0,
                    "Frozen Blueberries": 0,
                    "Blueberries Pound": 0,
                    "Peaches Pound": 0,
                    "Blackberries Pound": 0,
                    "Strawberries Pound": 0,
                    "Raspberries Pound": 0,
                    "Cherries Pound": 0,
                    "Apples Pound": 8.0,
                    "Pears Pound": 0,
                    "Green Beans Pound": 0,
                    "Brussel Sprouts Pound": 0,
                    "English Peas Pound": 0,
                    "Green Table Grapes Pound": 0,
                    "Jalapenos Pound": 0,
                    "Prune Plums Pound": 0,
                    "Russian Garlic Pound": 0
                }
            ]
        };

        // Fruit categories
        const fruitCategories = {
            'berry': ['Blueberries Pound', 'Strawberries Pound', 'Raspberries Pound', 'Blackberries Pound'],
            'stone': ['Peaches Pound', 'Cherries Pound', 'Nectarines', 'Prune Plums Pound'],
            'veggie': ['Green Beans Pound', 'Brussel Sprouts Pound', 'English Peas Pound', 'Jalapenos Pound', 'Russian Garlic Pound'],
            'other': ['Apples Pound', 'Pears Pound', 'Green Table Grapes Pound']
        };

        // Calendar data - simulating pickup schedule
        const pickupSchedule = {
            '2024-12-03': [
                { time: '09:00 AM', customer: 'John Smith', location: 'Kelowna', total: 85, items: 'Blueberries (4 lbs)', status: 'confirmed' },
                { time: '10:30 AM', customer: 'Sarah Johnson', location: 'Kelowna', total: 120.50, items: 'Blueberries (6 lbs), Strawberries (2 lbs)', status: 'confirmed' }
            ],
            '2024-12-05': [
                { time: '11:00 AM', customer: 'Mike Chen', location: 'Vancouver', total: 95.75, items: 'Raspberries (3 lbs), Cherries (2 lbs)', status: 'scheduled' }
            ],
            '2024-12-10': [
                { time: '02:00 PM', customer: 'David Brown', location: 'Edmonton', total: 150.25, items: 'Mixed Fruits (16 lbs)', status: 'scheduled' }
            ],
            '2024-12-15': [
                { time: '09:30 AM', customer: 'Robert Taylor', location: 'Penticton', total: 75.00, items: 'Apples (8 lbs)', status: 'scheduled' }
            ]
        };

        // Per-view filter states
        const filterStates = {
            main: {
                year: '2024',
                province: 'all'
            },
            customers: {
                year: 'all',
                province: 'all',
                region: 'all',
                city: 'all',
                status: 'all',
                minTransactions: null,
                minTotalValue: null
            },
            fruits: {
                time: '2024',
                province: 'all',
                region: 'all',
                city: 'all',
                category: 'all'
            },
            geography: {
                level: 'country',
                province: null,
                region: null,
                city: null
            },
            calendar: {} // No filters for calendar
        };

        // Current active view
        let currentView = 'main';
        let currentSubView = 'contacts';
        let purchaseViewMode = 'grid';

        // Calendar state
        let currentDate = new Date();
        let currentMonth = currentDate.getMonth();
        let currentYear = currentDate.getFullYear();

        // Geography drill-down state
        let geographyLevel = 'country';
        let selectedProvince = null;
        let selectedRegion = null;
        let selectedCity = null;

        // Modal state
        let currentContactModalId = null;

        function initDashboard() {
            // Initialize all filter selects with provinces
            const provinces = [...new Set(sampleData.contacts.map(c => c.Province))];
            
            // Populate all province selects
            const provinceSelects = [
                'mainProvinceSelect',
                'customersProvinceSelect',
                'fruitsProvinceSelect'
            ];
            
            provinceSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                provinces.forEach(province => {
                    const option = document.createElement('option');
                    option.value = province;
                    option.textContent = province;
                    select.appendChild(option);
                });
            });

            // Initialize main view filters
            setupMainViewFilters();
            
            // Initialize customers view filters
            setupCustomersViewFilters();
            
            // Initialize fruits view filters
            setupFruitsViewFilters();
            
            // Initialize geography view
            setupGeographyView();
            
            // Initialize calendar
            generateCalendar();
            updateTodayPickups();
            
            // Load initial data for current view
            updateViewData();
            
            // Initialize view switching
            switchView('main');
            
            // Initialize mobile filter system
            setupMobileViewFilters();
            
            // Initialize contact modal
            setupContactModal();
            
            // Initialize subview switching for customers
            setupCustomerSubViews();
            
            // Initialize purchase view toggle
            setupPurchaseViewToggle();
        }

        function setupMainViewFilters() {
            const yearSelect = document.getElementById('mainYearSelect');
            const provinceSelect = document.getElementById('mainProvinceSelect');
            
            // Set initial values from filter state
            yearSelect.value = filterStates.main.year;
            provinceSelect.value = filterStates.main.province;
            
            // Add event listeners
            yearSelect.addEventListener('change', function() {
                filterStates.main.year = this.value;
                updateViewData();
                updateActiveFiltersDisplay();
            });
            
            provinceSelect.addEventListener('change', function() {
                filterStates.main.province = this.value;
                updateViewData();
                updateActiveFiltersDisplay();
            });
        }

        function setupCustomersViewFilters() {
            const yearSelect = document.getElementById('customersYearSelect');
            const provinceSelect = document.getElementById('customersProvinceSelect');
            const regionSelect = document.getElementById('customersRegionSelect');
            const citySelect = document.getElementById('customersCitySelect');
            const statusSelect = document.getElementById('customersStatusSelect');
            const minTransactionsInput = document.getElementById('minTransactions');
            const minTotalValueInput = document.getElementById('minTotalValue');
            
            // Set initial values from filter state
            yearSelect.value = filterStates.customers.year;
            provinceSelect.value = filterStates.customers.province;
            regionSelect.value = filterStates.customers.region;
            citySelect.value = filterStates.customers.city;
            statusSelect.value = filterStates.customers.status;
            minTransactionsInput.value = filterStates.customers.minTransactions || '';
            minTotalValueInput.value = filterStates.customers.minTotalValue || '';
            
            // Province change handler
            provinceSelect.addEventListener('change', function() {
                const province = this.value;
                filterStates.customers.province = province;
                
                if (province === 'all') {
                    regionSelect.disabled = true;
                    regionSelect.innerHTML = '<option value="all">All Regions</option>';
                    citySelect.disabled = true;
                    citySelect.innerHTML = '<option value="all">All Cities</option>';
                    filterStates.customers.region = 'all';
                    filterStates.customers.city = 'all';
                } else {
                    // Filter regions for selected province
                    const regions = [...new Set(sampleData.contacts
                        .filter(c => c.Province === province)
                        .map(c => c.Region))];
                    
                    regionSelect.disabled = false;
                    regionSelect.innerHTML = '<option value="all">All Regions</option>';
                    regions.forEach(region => {
                        const option = document.createElement('option');
                        option.value = region;
                        option.textContent = region;
                        regionSelect.appendChild(option);
                    });
                    regionSelect.value = filterStates.customers.region;
                    
                    // Update cities if region is selected
                    updateCitySelectForCustomers();
                }
                
                updateViewData();
                updateActiveFiltersDisplay();
            });
            
            // Region change handler
            regionSelect.addEventListener('change', function() {
                const region = this.value;
                filterStates.customers.region = region;
                
                if (region === 'all') {
                    citySelect.disabled = true;
                    citySelect.innerHTML = '<option value="all">All Cities</option>';
                    filterStates.customers.city = 'all';
                } else {
                    updateCitySelectForCustomers();
                }
                
                updateViewData();
                updateActiveFiltersDisplay();
            });
            
            // City change handler
            citySelect.addEventListener('change', function() {
                filterStates.customers.city = this.value;
                updateViewData();
                updateActiveFiltersDisplay();
            });
            
            // Year change handler
            yearSelect.addEventListener('change', function() {
                filterStates.customers.year = this.value;
                updateViewData();
                updateActiveFiltersDisplay();
            });
            
            // Status change handler
            statusSelect.addEventListener('change', function() {
                filterStates.customers.status = this.value;
                updateViewData();
                updateActiveFiltersDisplay();
            });
            
            // Transaction count filter
            minTransactionsInput.addEventListener('change', function() {
                filterStates.customers.minTransactions = this.value ? parseInt(this.value) : null;
                updateViewData();
                updateActiveFiltersDisplay();
            });
            
            // Total value filter
            minTotalValueInput.addEventListener('change', function() {
                filterStates.customers.minTotalValue = this.value ? parseFloat(this.value) : null;
                updateViewData();
                updateActiveFiltersDisplay();
            });
        }
        
        function updateCitySelectForCustomers() {
            const provinceSelect = document.getElementById('customersProvinceSelect');
            const regionSelect = document.getElementById('customersRegionSelect');
            const citySelect = document.getElementById('customersCitySelect');
            
            const province = provinceSelect.value;
            const region = regionSelect.value;
            
            if (region !== 'all') {
                const cities = [...new Set(sampleData.contacts
                    .filter(c => c.Province === province && c.Region === region)
                    .map(c => c["Pickup City"]))];
                
                citySelect.disabled = false;
                citySelect.innerHTML = '<option value="all">All Cities</option>';
                cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    citySelect.appendChild(option);
                });
                citySelect.value = filterStates.customers.city;
            }
        }

        function setupFruitsViewFilters() {
            const timeSelect = document.getElementById('fruitsTimeSelect');
            const provinceSelect = document.getElementById('fruitsProvinceSelect');
            const regionSelect = document.getElementById('fruitsRegionSelect');
            const citySelect = document.getElementById('fruitsCitySelect');
            const categorySelect = document.getElementById('fruitsCategorySelect');
            
            // Set initial values from filter state
            timeSelect.value = filterStates.fruits.time;
            provinceSelect.value = filterStates.fruits.province;
            regionSelect.value = filterStates.fruits.region;
            citySelect.value = filterStates.fruits.city;
            categorySelect.value = filterStates.fruits.category;
            
            // Province change handler
            provinceSelect.addEventListener('change', function() {
                const province = this.value;
                filterStates.fruits.province = province;
                
                if (province === 'all') {
                    regionSelect.disabled = true;
                    regionSelect.innerHTML = '<option value="all">All Regions</option>';
                    citySelect.disabled = true;
                    citySelect.innerHTML = '<option value="all">All Cities</option>';
                    filterStates.fruits.region = 'all';
                    filterStates.fruits.city = 'all';
                } else {
                    // Filter regions for selected province
                    const regions = [...new Set(sampleData.contacts
                        .filter(c => c.Province === province)
                        .map(c => c.Region))];
                    
                    regionSelect.disabled = false;
                    regionSelect.innerHTML = '<option value="all">All Regions</option>';
                    regions.forEach(region => {
                        const option = document.createElement('option');
                        option.value = region;
                        option.textContent = region;
                        regionSelect.appendChild(option);
                    });
                    regionSelect.value = filterStates.fruits.region;
                    
                    // Update cities if region is selected
                    updateCitySelectForFruits();
                }
                
                updateViewData();
                updateActiveFiltersDisplay();
            });
            
            // Region change handler
            regionSelect.addEventListener('change', function() {
                const region = this.value;
                filterStates.fruits.region = region;
                
                if (region === 'all') {
                    citySelect.disabled = true;
                    citySelect.innerHTML = '<option value="all">All Cities</option>';
                    filterStates.fruits.city = 'all';
                } else {
                    updateCitySelectForFruits();
                }
                
                updateViewData();
                updateActiveFiltersDisplay();
            });
            
            // City change handler
            citySelect.addEventListener('change', function() {
                filterStates.fruits.city = this.value;
                updateViewData();
                updateActiveFiltersDisplay();
            });
            
            // Time change handler
            timeSelect.addEventListener('change', function() {
                filterStates.fruits.time = this.value;
                updateViewData();
                updateActiveFiltersDisplay();
            });
            
            // Category change handler
            categorySelect.addEventListener('change', function() {
                filterStates.fruits.category = this.value;
                updateViewData();
                updateActiveFiltersDisplay();
            });
        }
        
        function updateCitySelectForFruits() {
            const provinceSelect = document.getElementById('fruitsProvinceSelect');
            const regionSelect = document.getElementById('fruitsRegionSelect');
            const citySelect = document.getElementById('fruitsCitySelect');
            
            const province = provinceSelect.value;
            const region = regionSelect.value;
            
            if (region !== 'all') {
                const cities = [...new Set(sampleData.contacts
                    .filter(c => c.Province === province && c.Region === region)
                    .map(c => c["Pickup City"]))];
                
                citySelect.disabled = false;
                citySelect.innerHTML = '<option value="all">All Cities</option>';
                cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    citySelect.appendChild(option);
                });
                citySelect.value = filterStates.fruits.city;
            }
        }

        function setupGeographyView() {
            // Set up breadcrumb navigation
            const breadcrumbItems = document.querySelectorAll('.breadcrumb-item');
            breadcrumbItems.forEach(item => {
                item.addEventListener('click', function() {
                    const level = this.dataset.level;
                    navigateGeographyLevel(level);
                });
            });
            
            // Initialize map
            createProvinceMap();
            
            // Load initial geography data
            updateGeographyData();
        }

        function createProvinceMap() {
            const svg = document.getElementById('provinceMap');
            const provinces = [...new Set(sampleData.contacts.map(c => c.Province))];
            
            // Simple province coordinates for demonstration
            const provinceCoords = {
                'BC': { x: 100, y: 150, width: 120, height: 180 },
                'AB': { x: 220, y: 150, width: 120, height: 180 },
                'ON': { x: 340, y: 150, width: 140, height: 180 },
                'QC': { x: 480, y: 150, width: 120, height: 180 }
            };
            
            svg.innerHTML = '';
            
            provinces.forEach(province => {
                const coords = provinceCoords[province];
                if (!coords) return;
                
                // Calculate revenue for province
                const revenue = calculateProvinceRevenue(province);
                const maxRevenue = 10000; // Adjust based on your data
                const opacity = Math.min(0.3 + (revenue / maxRevenue) * 0.7, 1);
                
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', coords.x);
                rect.setAttribute('y', coords.y);
                rect.setAttribute('width', coords.width);
                rect.setAttribute('height', coords.height);
                rect.setAttribute('rx', '8');
                rect.setAttribute('class', 'province-item');
                rect.setAttribute('data-province', province);
                rect.style.fill = `rgba(59, 130, 246, ${opacity})`;
                rect.style.stroke = 'var(--border)';
                rect.style.strokeWidth = '1';
                
                rect.addEventListener('click', function() {
                    selectProvinceOnMap(province);
                });
                
                // Add province label
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', coords.x + coords.width / 2);
                text.setAttribute('y', coords.y + coords.height / 2);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('dominant-baseline', 'middle');
                text.setAttribute('fill', 'var(--text)');
                text.setAttribute('font-size', '14');
                text.setAttribute('font-weight', '600');
                text.textContent = province;
                
                // Add revenue label
                const revenueText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                revenueText.setAttribute('x', coords.x + coords.width / 2);
                revenueText.setAttribute('y', coords.y + coords.height / 2 + 20);
                revenueText.setAttribute('text-anchor', 'middle');
                revenueText.setAttribute('dominant-baseline', 'middle');
                revenueText.setAttribute('fill', 'var(--muted)');
                revenueText.setAttribute('font-size', '12');
                revenueText.textContent = `$${revenue.toLocaleString()}`;
                
                svg.appendChild(rect);
                svg.appendChild(text);
                svg.appendChild(revenueText);
            });
        }
        
        function calculateProvinceRevenue(province) {
            const provinceTransactions = sampleData.transactions.filter(t => {
                const contact = sampleData.contacts.find(c => c.BhavsContactID === t["New Unique Id"]);
                return contact && contact.Province === province;
            });
            
            return provinceTransactions.reduce((sum, t) => sum + t["Gross Sales"], 0);
        }
        
        function selectProvinceOnMap(province) {
            // Update selected province
            selectedProvince = province;
            geographyLevel = 'province';
            
            // Update breadcrumb
            updateGeographyBreadcrumb();
            
            // Update map display
            const provinceItems = document.querySelectorAll('.province-item');
            provinceItems.forEach(item => {
                if (item.dataset.province === province) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            // Update geography data
            updateGeographyData();
        }
        
        function navigateGeographyLevel(level) {
            geographyLevel = level;
            
            // Reset selections based on level
            if (level === 'country') {
                selectedProvince = null;
                selectedRegion = null;
                selectedCity = null;
            } else if (level === 'province') {
                selectedRegion = null;
                selectedCity = null;
            } else if (level === 'region') {
                selectedCity = null;
            }
            
            // Update breadcrumb
            updateGeographyBreadcrumb();
            
            // Update geography data
            updateGeographyData();
        }
        
        function updateGeographyBreadcrumb() {
            const breadcrumb = document.getElementById('geographyBreadcrumb');
            const provinceItem = breadcrumb.querySelector('[data-level="province"]');
            const regionItem = breadcrumb.querySelector('[data-level="region"]');
            const cityItem = breadcrumb.querySelector('[data-level="city"]');
            const separators = breadcrumb.querySelectorAll('div:not(.breadcrumb-item)');
            
            // Reset all
            provinceItem.style.display = 'none';
            regionItem.style.display = 'none';
            cityItem.style.display = 'none';
            separators[1].style.display = 'none';
            separators[2].style.display = 'none';
            separators[3].style.display = 'none';
            
            // Update active states
            breadcrumb.querySelectorAll('.breadcrumb-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.level === geographyLevel) {
                    item.classList.add('active');
                }
            });
            
            // Show appropriate items based on level
            if (geographyLevel === 'province') {
                provinceItem.style.display = 'block';
                provinceItem.textContent = selectedProvince || 'Select Province';
                separators[1].style.display = 'block';
            } else if (geographyLevel === 'region') {
                provinceItem.style.display = 'block';
                provinceItem.textContent = selectedProvince;
                regionItem.style.display = 'block';
                regionItem.textContent = selectedRegion || 'Select Region';
                separators[1].style.display = 'block';
                separators[2].style.display = 'block';
            } else if (geographyLevel === 'city') {
                provinceItem.style.display = 'block';
                provinceItem.textContent = selectedProvince;
                regionItem.style.display = 'block';
                regionItem.textContent = selectedRegion;
                cityItem.style.display = 'block';
                cityItem.textContent = selectedCity || 'Select City';
                separators[1].style.display = 'block';
                separators[2].style.display = 'block';
                separators[3].style.display = 'block';
            }
        }

        function setupMobileViewFilters() {
            const filterBtn = document.getElementById('viewFilterBtn');
            const filterOverlay = document.getElementById('mobileViewFilterOverlay');
            const filterClose = document.getElementById('mobileViewFilterClose');
            const filterClear = document.getElementById('mobileViewFilterClear');
            const filterApply = document.getElementById('mobileViewFilterApply');
            
            // Toggle filter overlay
            filterBtn.addEventListener('click', () => {
                updateMobileFilterContent();
                filterOverlay.classList.add('show');
            });
            
            // Close filter overlay
            filterClose.addEventListener('click', () => {
                filterOverlay.classList.remove('show');
            });
            
            // Close when clicking overlay
            filterOverlay.addEventListener('click', (e) => {
                if (e.target === filterOverlay) {
                    filterOverlay.classList.remove('show');
                }
            });
            
            // Clear all filters for current view
            filterClear.addEventListener('click', () => {
                clearCurrentViewFilters();
                filterOverlay.classList.remove('show');
            });
            
            // Apply filters
            filterApply.addEventListener('click', () => {
                applyMobileFilters();
                filterOverlay.classList.remove('show');
            });
        }
        
        function updateMobileFilterContent() {
            const content = document.getElementById('mobileViewFilterContent');
            const title = document.getElementById('mobileViewFilterTitle');
            
            if (!content || !title) return;
            
            title.textContent = `${getViewName(currentView)} Filters`;
            
            let filterHTML = '';
            
            switch(currentView) {
                case 'main':
                    filterHTML = getMainViewMobileFilters();
                    break;
                case 'customers':
                    filterHTML = getCustomersViewMobileFilters();
                    break;
                case 'fruits':
                    filterHTML = getFruitsViewMobileFilters();
                    break;
                case 'geography':
                    filterHTML = getGeographyViewMobileFilters();
                    break;
                case 'calendar':
                    filterHTML = '<p>No filters available for calendar view.</p>';
                    break;
            }
            
            content.innerHTML = filterHTML;
            
            // Set up mobile filter interactions
            setupMobileFilterInteractions();
        }
        
        function getMainViewMobileFilters() {
            const provinces = [...new Set(sampleData.contacts.map(c => c.Province))];
            
            return `
                <div class="mobile-filter-group">
                    <label class="mobile-filter-label">Year</label>
                    <select class="mobile-filter-select" id="mobileMainYearSelect">
                        <option value="all" ${filterStates.main.year === 'all' ? 'selected' : ''}>All Years</option>
                        <option value="2023" ${filterStates.main.year === '2023' ? 'selected' : ''}>2023</option>
                        <option value="2024" ${filterStates.main.year === '2024' ? 'selected' : ''}>2024</option>
                        <option value="2025" ${filterStates.main.year === '2025' ? 'selected' : ''}>2025</option>
                    </select>
                </div>
                
                <div class="mobile-filter-group">
                    <label class="mobile-filter-label">Province</label>
                    <select class="mobile-filter-select" id="mobileMainProvinceSelect">
                        <option value="all" ${filterStates.main.province === 'all' ? 'selected' : ''}>All Provinces</option>
                        ${provinces.map(p => `<option value="${p}" ${filterStates.main.province === p ? 'selected' : ''}>${p}</option>`).join('')}
                    </select>
                </div>
            `;
        }
        
        function getCustomersViewMobileFilters() {
            const provinces = [...new Set(sampleData.contacts.map(c => c.Province))];
            let regions = [];
            let cities = [];
            
            if (filterStates.customers.province !== 'all') {
                regions = [...new Set(sampleData.contacts
                    .filter(c => c.Province === filterStates.customers.province)
                    .map(c => c.Region))];
                
                if (filterStates.customers.region !== 'all') {
                    cities = [...new Set(sampleData.contacts
                        .filter(c => c.Province === filterStates.customers.province && 
                                     c.Region === filterStates.customers.region)
                        .map(c => c["Pickup City"]))];
                }
            }
            
            return `
                <div class="mobile-filter-group">
                    <label class="mobile-filter-label">Acquisition Year</label>
                    <select class="mobile-filter-select" id="mobileCustomersYearSelect">
                        <option value="all" ${filterStates.customers.year === 'all' ? 'selected' : ''}>All Years</option>
                        <option value="2023" ${filterStates.customers.year === '2023' ? 'selected' : ''}>2023</option>
                        <option value="2024" ${filterStates.customers.year === '2024' ? 'selected' : ''}>2024</option>
                        <option value="2025" ${filterStates.customers.year === '2025' ? 'selected' : ''}>2025</option>
                    </select>
                </div>
                
                <div class="mobile-filter-group">
                    <label class="mobile-filter-label">Province</label>
                    <select class="mobile-filter-select" id="mobileCustomersProvinceSelect">
                        <option value="all" ${filterStates.customers.province === 'all' ? 'selected' : ''}>All Provinces</option>
                        ${provinces.map(p => `<option value="${p}" ${filterStates.customers.province === p ? 'selected' : ''}>${p}</option>`).join('')}
                    </select>
                </div>
                
                <div class="mobile-filter-group">
                    <label class="mobile-filter-label">Region</label>
                    <select class="mobile-filter-select" id="mobileCustomersRegionSelect" ${filterStates.customers.province === 'all' ? 'disabled' : ''}>
                        <option value="all" ${filterStates.customers.region === 'all' ? 'selected' : ''}>All Regions</option>
                        ${regions.map(r => `<option value="${r}" ${filterStates.customers.region === r ? 'selected' : ''}>${r}</option>`).join('')}
                    </select>
                </div>
                
                <div class="mobile-filter-group">
                    <label class="mobile-filter-label">City</label>
                    <select class="mobile-filter-select" id="mobileCustomersCitySelect" ${filterStates.customers.region === 'all' ? 'disabled' : ''}>
                        <option value="all" ${filterStates.customers.city === 'all' ? 'selected' : ''}>All Cities</option>
                        ${cities.map(c => `<option value="${c}" ${filterStates.customers.city === c ? 'selected' : ''}>${c}</option>`).join('')}
                    </select>
                </div>
                
                <div class="mobile-filter-group">
                    <label class="mobile-filter-label">Status</label>
                    <select class="mobile-filter-select" id="mobileCustomersStatusSelect">
                        <option value="all" ${filterStates.customers.status === 'all' ? 'selected' : ''}>All Status</option>
                        <option value="lead" ${filterStates.customers.status === 'lead' ? 'selected' : ''}>Leads Only</option>
                        <option value="customer" ${filterStates.customers.status === 'customer' ? 'selected' : ''}>Customers Only</option>
                    </select>
                </div>
                
                <div class="mobile-filter-group">
                    <label class="mobile-filter-label">Min Transactions</label>
                    <input type="number" class="range-input" id="mobileMinTransactions" 
                           value="${filterStates.customers.minTransactions || ''}" 
                           placeholder="Any" min="0">
                </div>
                
                <div class="mobile-filter-group">
                    <label class="mobile-filter-label">Min Total Value ($)</label>
                    <input type="number" class="range-input" id="mobileMinTotalValue" 
                           value="${filterStates.customers.minTotalValue || ''}" 
                           placeholder="Any" min="0" step="0.01">
                </div>
            `;
        }
        
        function getFruitsViewMobileFilters() {
            const provinces = [...new Set(sampleData.contacts.map(c => c.Province))];
            let regions = [];
            let cities = [];
            
            if (filterStates.fruits.province !== 'all') {
                regions = [...new Set(sampleData.contacts
                    .filter(c => c.Province === filterStates.fruits.province)
                    .map(c => c.Region))];
                
                if (filterStates.fruits.region !== 'all') {
                    cities = [...new Set(sampleData.contacts
                        .filter(c => c.Province === filterStates.fruits.province && 
                                     c.Region === filterStates.fruits.region)
                        .map(c => c["Pickup City"]))];
                }
            }
            
            return `
                <div class="mobile-filter-group">
                    <label class="mobile-filter-label">Year/Month</label>
                    <select class="mobile-filter-select" id="mobileFruitsTimeSelect">
                        <option value="all" ${filterStates.fruits.time === 'all' ? 'selected' : ''}>All Time</option>
                        <option value="2024" ${filterStates.fruits.time === '2024' ? 'selected' : ''}>2024</option>
                        <option value="2023" ${filterStates.fruits.time === '2023' ? 'selected' : ''}>2023</option>
                    </select>
                </div>
                
                <div class="mobile-filter-group">
                    <label class="mobile-filter-label">Province</label>
                    <select class="mobile-filter-select" id="mobileFruitsProvinceSelect">
                        <option value="all" ${filterStates.fruits.province === 'all' ? 'selected' : ''}>All Provinces</option>
                        ${provinces.map(p => `<option value="${p}" ${filterStates.fruits.province === p ? 'selected' : ''}>${p}</option>`).join('')}
                    </select>
                </div>
                
                <div class="mobile-filter-group">
                    <label class="mobile-filter-label">Region</label>
                    <select class="mobile-filter-select" id="mobileFruitsRegionSelect" ${filterStates.fruits.province === 'all' ? 'disabled' : ''}>
                        <option value="all" ${filterStates.fruits.region === 'all' ? 'selected' : ''}>All Regions</option>
                        ${regions.map(r => `<option value="${r}" ${filterStates.fruits.region === r ? 'selected' : ''}>${r}</option>`).join('')}
                    </select>
                </div>
                
                <div class="mobile-filter-group">
                    <label class="mobile-filter-label">City</label>
                    <select class="mobile-filter-select" id="mobileFruitsCitySelect" ${filterStates.fruits.region === 'all' ? 'disabled' : ''}>
                        <option value="all" ${filterStates.fruits.city === 'all' ? 'selected' : ''}>All Cities</option>
                        ${cities.map(c => `<option value="${c}" ${filterStates.fruits.city === c ? 'selected' : ''}>${c}</option>`).join('')}
                    </select>
                </div>
                
                <div class="mobile-filter-group">
                    <label class="mobile-filter-label">Fruit Category</label>
                    <select class="mobile-filter-select" id="mobileFruitsCategorySelect">
                        <option value="all" ${filterStates.fruits.category === 'all' ? 'selected' : ''}>All Categories</option>
                        <option value="berry" ${filterStates.fruits.category === 'berry' ? 'selected' : ''}>Berries</option>
                        <option value="stone" ${filterStates.fruits.category === 'stone' ? 'selected' : ''}>Stone Fruits</option>
                        <option value="veggie" ${filterStates.fruits.category === 'veggie' ? 'selected' : ''}>Vegetables</option>
                    </select>
                </div>
            `;
        }
        
        function getGeographyViewMobileFilters() {
            return `
                <div class="mobile-filter-group">
                    <p style="color: var(--muted); font-size: 14px;">
                        Use the map and breadcrumb navigation to drill down into geographical data.
                        Click on provinces in the map to select them.
                    </p>
                </div>
            `;
        }
        
        function setupMobileFilterInteractions() {
            // Set up dependencies for customers view
            const customersProvinceSelect = document.getElementById('mobileCustomersProvinceSelect');
            const customersRegionSelect = document.getElementById('mobileCustomersRegionSelect');
            const customersCitySelect = document.getElementById('mobileCustomersCitySelect');
            
            if (customersProvinceSelect) {
                customersProvinceSelect.addEventListener('change', function() {
                    const province = this.value;
                    
                    if (province === 'all') {
                        customersRegionSelect.disabled = true;
                        customersRegionSelect.innerHTML = '<option value="all">All Regions</option>';
                        customersCitySelect.disabled = true;
                        customersCitySelect.innerHTML = '<option value="all">All Cities</option>';
                    } else {
                        const regions = [...new Set(sampleData.contacts
                            .filter(c => c.Province === province)
                            .map(c => c.Region))];
                        
                        customersRegionSelect.disabled = false;
                        customersRegionSelect.innerHTML = '<option value="all">All Regions</option>';
                        regions.forEach(region => {
                            const option = document.createElement('option');
                            option.value = region;
                            option.textContent = region;
                            customersRegionSelect.appendChild(option);
                        });
                        
                        customersCitySelect.disabled = true;
                        customersCitySelect.innerHTML = '<option value="all">All Cities</option>';
                    }
                });
            }
            
            // Set up dependencies for fruits view
            const fruitsProvinceSelect = document.getElementById('mobileFruitsProvinceSelect');
            const fruitsRegionSelect = document.getElementById('mobileFruitsRegionSelect');
            const fruitsCitySelect = document.getElementById('mobileFruitsCitySelect');
            
            if (fruitsProvinceSelect) {
                fruitsProvinceSelect.addEventListener('change', function() {
                    const province = this.value;
                    
                    if (province === 'all') {
                        fruitsRegionSelect.disabled = true;
                        fruitsRegionSelect.innerHTML = '<option value="all">All Regions</option>';
                        fruitsCitySelect.disabled = true;
                        fruitsCitySelect.innerHTML = '<option value="all">All Cities</option>';
                    } else {
                        const regions = [...new Set(sampleData.contacts
                            .filter(c => c.Province === province)
                            .map(c => c.Region))];
                        
                        fruitsRegionSelect.disabled = false;
                        fruitsRegionSelect.innerHTML = '<option value="all">All Regions</option>';
                        regions.forEach(region => {
                            const option = document.createElement('option');
                            option.value = region;
                            option.textContent = region;
                            fruitsRegionSelect.appendChild(option);
                        });
                        
                        fruitsCitySelect.disabled = true;
                        fruitsCitySelect.innerHTML = '<option value="all">All Cities</option>';
                    }
                });
            }
            
            if (fruitsRegionSelect) {
                fruitsRegionSelect.addEventListener('change', function() {
                    const region = this.value;
                    const province = fruitsProvinceSelect.value;
                    
                    if (region === 'all') {
                        fruitsCitySelect.disabled = true;
                        fruitsCitySelect.innerHTML = '<option value="all">All Cities</option>';
                    } else {
                        const cities = [...new Set(sampleData.contacts
                            .filter(c => c.Province === province && c.Region === region)
                            .map(c => c["Pickup City"]))];
                        
                        fruitsCitySelect.disabled = false;
                        fruitsCitySelect.innerHTML = '<option value="all">All Cities</option>';
                        cities.forEach(city => {
                            const option = document.createElement('option');
                            option.value = city;
                            option.textContent = city;
                            fruitsCitySelect.appendChild(option);
                        });
                    }
                });
            }
        }
        
        function applyMobileFilters() {
            switch(currentView) {
                case 'main':
                    applyMainViewMobileFilters();
                    break;
                case 'customers':
                    applyCustomersViewMobileFilters();
                    break;
                case 'fruits':
                    applyFruitsViewMobileFilters();
                    break;
            }
            
            updateViewData();
            updateActiveFiltersDisplay();
        }
        
        function applyMainViewMobileFilters() {
            const yearSelect = document.getElementById('mobileMainYearSelect');
            const provinceSelect = document.getElementById('mobileMainProvinceSelect');
            
            if (yearSelect) filterStates.main.year = yearSelect.value;
            if (provinceSelect) filterStates.main.province = provinceSelect.value;
            
            // Update desktop filters
            document.getElementById('mainYearSelect').value = filterStates.main.year;
            document.getElementById('mainProvinceSelect').value = filterStates.main.province;
        }
        
        function applyCustomersViewMobileFilters() {
            const yearSelect = document.getElementById('mobileCustomersYearSelect');
            const provinceSelect = document.getElementById('mobileCustomersProvinceSelect');
            const regionSelect = document.getElementById('mobileCustomersRegionSelect');
            const citySelect = document.getElementById('mobileCustomersCitySelect');
            const statusSelect = document.getElementById('mobileCustomersStatusSelect');
            const minTransactions = document.getElementById('mobileMinTransactions');
            const minTotalValue = document.getElementById('mobileMinTotalValue');
            
            if (yearSelect) filterStates.customers.year = yearSelect.value;
            if (provinceSelect) filterStates.customers.province = provinceSelect.value;
            if (regionSelect) filterStates.customers.region = regionSelect.value;
            if (citySelect) filterStates.customers.city = citySelect.value;
            if (statusSelect) filterStates.customers.status = statusSelect.value;
            if (minTransactions) filterStates.customers.minTransactions = minTransactions.value ? parseInt(minTransactions.value) : null;
            if (minTotalValue) filterStates.customers.minTotalValue = minTotalValue.value ? parseFloat(minTotalValue.value) : null;
            
            // Update desktop filters
            document.getElementById('customersYearSelect').value = filterStates.customers.year;
            document.getElementById('customersProvinceSelect').value = filterStates.customers.province;
            document.getElementById('customersRegionSelect').value = filterStates.customers.region;
            document.getElementById('customersCitySelect').value = filterStates.customers.city;
            document.getElementById('customersStatusSelect').value = filterStates.customers.status;
            document.getElementById('minTransactions').value = filterStates.customers.minTransactions || '';
            document.getElementById('minTotalValue').value = filterStates.customers.minTotalValue || '';
            
            // Update region/city dependencies
            updateCitySelectForCustomers();
        }
        
        function applyFruitsViewMobileFilters() {
            const timeSelect = document.getElementById('mobileFruitsTimeSelect');
            const provinceSelect = document.getElementById('mobileFruitsProvinceSelect');
            const regionSelect = document.getElementById('mobileFruitsRegionSelect');
            const citySelect = document.getElementById('mobileFruitsCitySelect');
            const categorySelect = document.getElementById('mobileFruitsCategorySelect');
            
            if (timeSelect) filterStates.fruits.time = timeSelect.value;
            if (provinceSelect) filterStates.fruits.province = provinceSelect.value;
            if (regionSelect) filterStates.fruits.region = regionSelect.value;
            if (citySelect) filterStates.fruits.city = citySelect.value;
            if (categorySelect) filterStates.fruits.category = categorySelect.value;
            
            // Update desktop filters
            document.getElementById('fruitsTimeSelect').value = filterStates.fruits.time;
            document.getElementById('fruitsProvinceSelect').value = filterStates.fruits.province;
            document.getElementById('fruitsRegionSelect').value = filterStates.fruits.region;
            document.getElementById('fruitsCitySelect').value = filterStates.fruits.city;
            document.getElementById('fruitsCategorySelect').value = filterStates.fruits.category;
            
            // Update region/city dependencies
            updateCitySelectForFruits();
        }
        
        function clearCurrentViewFilters() {
            switch(currentView) {
                case 'main':
                    filterStates.main = { year: '2024', province: 'all' };
                    document.getElementById('mainYearSelect').value = '2024';
                    document.getElementById('mainProvinceSelect').value = 'all';
                    break;
                case 'customers':
                    filterStates.customers = {
                        year: 'all',
                        province: 'all',
                        region: 'all',
                        city: 'all',
                        status: 'all',
                        minTransactions: null,
                        minTotalValue: null
                    };
                    document.getElementById('customersYearSelect').value = 'all';
                    document.getElementById('customersProvinceSelect').value = 'all';
                    document.getElementById('customersRegionSelect').value = 'all';
                    document.getElementById('customersRegionSelect').disabled = true;
                    document.getElementById('customersCitySelect').value = 'all';
                    document.getElementById('customersCitySelect').disabled = true;
                    document.getElementById('customersStatusSelect').value = 'all';
                    document.getElementById('minTransactions').value = '';
                    document.getElementById('minTotalValue').value = '';
                    break;
                case 'fruits':
                    filterStates.fruits = {
                        time: '2024',
                        province: 'all',
                        region: 'all',
                        city: 'all',
                        category: 'all'
                    };
                    document.getElementById('fruitsTimeSelect').value = '2024';
                    document.getElementById('fruitsProvinceSelect').value = 'all';
                    document.getElementById('fruitsRegionSelect').value = 'all';
                    document.getElementById('fruitsRegionSelect').disabled = true;
                    document.getElementById('fruitsCitySelect').value = 'all';
                    document.getElementById('fruitsCitySelect').disabled = true;
                    document.getElementById('fruitsCategorySelect').value = 'all';
                    break;
                case 'geography':
                    geographyLevel = 'country';
                    selectedProvince = null;
                    selectedRegion = null;
                    selectedCity = null;
                    updateGeographyBreadcrumb();
                    break;
            }
            
            updateViewData();
            updateActiveFiltersDisplay();
        }

        function updateActiveFiltersDisplay() {
            const activeFiltersContainer = document.getElementById('activeFilters');
            if (!activeFiltersContainer) return;
            
            // Clear existing chips
            activeFiltersContainer.querySelectorAll('.filter-chip').forEach(chip => chip.remove());
            
            const filters = filterStates[currentView];
            if (!filters) return;
            
            // Add chips based on current view
            if (currentView === 'main') {
                if (filters.year !== '2024') {
                    addFilterChip('Year', filters.year, 'year');
                }
                if (filters.province !== 'all') {
                    addFilterChip('Province', filters.province, 'province');
                }
            } else if (currentView === 'customers') {
                if (filters.year !== 'all') {
                    addFilterChip('Acquisition Year', filters.year, 'year');
                }
                if (filters.province !== 'all') {
                    addFilterChip('Province', filters.province, 'province');
                }
                if (filters.region !== 'all') {
                    addFilterChip('Region', filters.region, 'region');
                }
                if (filters.city !== 'all') {
                    addFilterChip('City', filters.city, 'city');
                }
                if (filters.status !== 'all') {
                    addFilterChip('Status', filters.status, 'status');
                }
                if (filters.minTransactions) {
                    addFilterChip('Min Transactions', filters.minTransactions, 'minTransactions');
                }
                if (filters.minTotalValue) {
                    addFilterChip('Min Total Value', `$${filters.minTotalValue}`, 'minTotalValue');
                }
            } else if (currentView === 'fruits') {
                if (filters.time !== '2024') {
                    addFilterChip('Time Period', filters.time, 'time');
                }
                if (filters.province !== 'all') {
                    addFilterChip('Province', filters.province, 'province');
                }
                if (filters.region !== 'all') {
                    addFilterChip('Region', filters.region, 'region');
                }
                if (filters.city !== 'all') {
                    addFilterChip('City', filters.city, 'city');
                }
                if (filters.category !== 'all') {
                    addFilterChip('Category', filters.category, 'category');
                }
            } else if (currentView === 'geography') {
                if (selectedProvince) {
                    addFilterChip('Province', selectedProvince, 'province');
                }
                if (selectedRegion) {
                    addFilterChip('Region', selectedRegion, 'region');
                }
                if (selectedCity) {
                    addFilterChip('City', selectedCity, 'city');
                }
            }
        }
        
        function addFilterChip(label, value, filterKey) {
            const activeFiltersContainer = document.getElementById('activeFilters');
            const chip = document.createElement('div');
            chip.className = 'filter-chip';
            chip.innerHTML = `
                ${label}: ${value}
                <button onclick="removeFilterChip('${currentView}', '${filterKey}')">‚úï</button>
            `;
            activeFiltersContainer.appendChild(chip);
        }
        
        function removeFilterChip(view, filterKey) {
            if (view === 'main') {
                if (filterKey === 'year') {
                    filterStates.main.year = '2024';
                    document.getElementById('mainYearSelect').value = '2024';
                } else if (filterKey === 'province') {
                    filterStates.main.province = 'all';
                    document.getElementById('mainProvinceSelect').value = 'all';
                }
            } else if (view === 'customers') {
                if (filterKey === 'year') {
                    filterStates.customers.year = 'all';
                    document.getElementById('customersYearSelect').value = 'all';
                } else if (filterKey === 'province') {
                    filterStates.customers.province = 'all';
                    filterStates.customers.region = 'all';
                    filterStates.customers.city = 'all';
                    document.getElementById('customersProvinceSelect').value = 'all';
                    document.getElementById('customersRegionSelect').value = 'all';
                    document.getElementById('customersRegionSelect').disabled = true;
                    document.getElementById('customersCitySelect').value = 'all';
                    document.getElementById('customersCitySelect').disabled = true;
                } else if (filterKey === 'region') {
                    filterStates.customers.region = 'all';
                    filterStates.customers.city = 'all';
                    document.getElementById('customersRegionSelect').value = 'all';
                    document.getElementById('customersCitySelect').value = 'all';
                    document.getElementById('customersCitySelect').disabled = true;
                } else if (filterKey === 'city') {
                    filterStates.customers.city = 'all';
                    document.getElementById('customersCitySelect').value = 'all';
                } else if (filterKey === 'status') {
                    filterStates.customers.status = 'all';
                    document.getElementById('customersStatusSelect').value = 'all';
                } else if (filterKey === 'minTransactions') {
                    filterStates.customers.minTransactions = null;
                    document.getElementById('minTransactions').value = '';
                } else if (filterKey === 'minTotalValue') {
                    filterStates.customers.minTotalValue = null;
                    document.getElementById('minTotalValue').value = '';
                }
            } else if (view === 'fruits') {
                if (filterKey === 'time') {
                    filterStates.fruits.time = '2024';
                    document.getElementById('fruitsTimeSelect').value = '2024';
                } else if (filterKey === 'province') {
                    filterStates.fruits.province = 'all';
                    filterStates.fruits.region = 'all';
                    filterStates.fruits.city = 'all';
                    document.getElementById('fruitsProvinceSelect').value = 'all';
                    document.getElementById('fruitsRegionSelect').value = 'all';
                    document.getElementById('fruitsRegionSelect').disabled = true;
                    document.getElementById('fruitsCitySelect').value = 'all';
                    document.getElementById('fruitsCitySelect').disabled = true;
                } else if (filterKey === 'region') {
                    filterStates.fruits.region = 'all';
                    filterStates.fruits.city = 'all';
                    document.getElementById('fruitsRegionSelect').value = 'all';
                    document.getElementById('fruitsCitySelect').value = 'all';
                    document.getElementById('fruitsCitySelect').disabled = true;
                } else if (filterKey === 'city') {
                    filterStates.fruits.city = 'all';
                    document.getElementById('fruitsCitySelect').value = 'all';
                } else if (filterKey === 'category') {
                    filterStates.fruits.category = 'all';
                    document.getElementById('fruitsCategorySelect').value = 'all';
                }
            } else if (view === 'geography') {
                if (filterKey === 'province') {
                    selectedProvince = null;
                    geographyLevel = 'country';
                } else if (filterKey === 'region') {
                    selectedRegion = null;
                    geographyLevel = 'province';
                } else if (filterKey === 'city') {
                    selectedCity = null;
                    geographyLevel = 'region';
                }
                updateGeographyBreadcrumb();
            }
            
            updateViewData();
            updateActiveFiltersDisplay();
        }

        function getViewName(view) {
            const names = {
                'main': 'Dashboard',
                'customers': 'Customers',
                'fruits': 'Fruits',
                'geography': 'Geography',
                'calendar': 'Calendar'
            };
            return names[view] || view;
        }

        function updateViewData() {
            switch(currentView) {
                case 'main':
                    updateMainView();
                    break;
                case 'customers':
                    updateCustomersView();
                    break;
                case 'fruits':
                    updateFruitsView();
                    break;
                case 'geography':
                    updateGeographyData();
                    break;
                case 'calendar':
                    // Calendar is already updated by generateCalendar()
                    break;
            }
        }

        function updateMainView() {
            const filters = filterStates.main;
            
            // Filter contacts and transactions based on main view filters
            let filteredContacts = sampleData.contacts;
            let filteredTransactions = sampleData.transactions;
            
            if (filters.year !== 'all') {
                filteredContacts = filteredContacts.filter(c => {
                    const year = new Date(c["Lead Acquisition Date"]).getFullYear().toString();
                    return year === filters.year;
                });
                
                filteredTransactions = filteredTransactions.filter(t => {
                    const year = new Date(t.Date).getFullYear().toString();
                    return year === filters.year;
                });
            }
            
            if (filters.province !== 'all') {
                filteredContacts = filteredContacts.filter(c => c.Province === filters.province);
                // Also filter transactions by province through contact relationship
                filteredTransactions = filteredTransactions.filter(t => {
                    const contact = filteredContacts.find(c => c.BhavsContactID === t["New Unique Id"]);
                    return contact !== undefined;
                });
            }
            
            // Calculate KPIs
            const totalLeads = filteredContacts.filter(c => c["Lead/Customer Status"] === 'lead').length;
            const totalCustomers = filteredContacts.filter(c => c["Lead/Customer Status"] === 'customer').length;
            const totalTransactions = filteredTransactions.length;
            const conversionRate = totalCustomers + totalLeads > 0 
                ? Math.round((totalCustomers / (totalCustomers + totalLeads)) * 100)
                : 0;
            
            // Update KPI cards
            document.getElementById('kpi-leads').textContent = totalLeads.toLocaleString();
            document.getElementById('kpi-customers').textContent = totalCustomers.toLocaleString();
            document.getElementById('kpi-transactions').textContent = totalTransactions.toLocaleString();
            document.getElementById('kpi-conversion').textContent = `${conversionRate}%`;
            
            // Update cohort table
            updateCohortTable(filteredContacts);
            
            // Update recent transactions
            updateRecentTransactions(filteredTransactions);
        }
        
        function updateCohortTable(contacts) {
            const cohorts = [
                {
                    year: '2023',
                    acquired: contacts.filter(c => 
                        c["Lead/Customer Status"] === 'customer' && 
                        c["Lead Acquisition Date"].startsWith('2023')
                    ).length,
                    year1Retention: '68%',
                    year2Retention: '52%',
                    avgLifetimeValue: 1850,
                    avgVisits: 4.2
                },
                {
                    year: '2024',
                    acquired: contacts.filter(c => 
                        c["Lead/Customer Status"] === 'customer' && 
                        c["Lead Acquisition Date"].startsWith('2024')
                    ).length,
                    year1Retention: '72%',
                    year2Retention: '‚Äî',
                    avgLifetimeValue: 1920,
                    avgVisits: 3.8
                }
            ];
            
            const tableBody = document.querySelector('#cohort-table tbody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            cohorts.forEach(cohort => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${cohort.year}</td>
                    <td>${cohort.acquired}</td>
                    <td>${cohort.year1Retention} <span class="metric-change">‚Üë 4%</span></td>
                    <td>${cohort.year2Retention} <span class="metric-change">‚Üë 2%</span></td>
                    <td>$${cohort.avgLifetimeValue.toLocaleString()}</td>
                    <td>${cohort.avgVisits}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function updateRecentTransactions(transactions) {
            const tableBody = document.querySelector('#recent-transactions tbody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            // Show latest 5 transactions
            const recent = transactions.slice(-5).reverse();
            
            recent.forEach(transaction => {
                const row = document.createElement('tr');
                
                // Find fruits in the transaction
                const fruits = [];
                if (transaction['Blueberries Pound'] > 0) fruits.push(`${transaction['Blueberries Pound']}lb Blueberries`);
                if (transaction['Strawberries Pound'] > 0) fruits.push(`${transaction['Strawberries Pound']}lb Strawberries`);
                if (transaction['Peaches Pound'] > 0) fruits.push(`${transaction['Peaches Pound']}lb Peaches`);
                if (transaction['Raspberries Pound'] > 0) fruits.push(`${transaction['Raspberries Pound']}lb Raspberries`);
                if (transaction['Cherries Pound'] > 0) fruits.push(`${transaction['Cherries Pound']}lb Cherries`);
                if (transaction['Apples Pound'] > 0) fruits.push(`${transaction['Apples Pound']}lb Apples`);
                
                row.innerHTML = `
                    <td>${transaction.Date}</td>
                    <td>${transaction["Customer Name"]}</td>
                    <td>${transaction["Pickup City"]}</td>
                    <td>$${transaction["Gross Sales"].toFixed(2)}</td>
                    <td>${fruits.join(', ')}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function updateCustomersView() {
            const filters = filterStates.customers;
            
            // Filter contacts based on customers view filters
            let filteredContacts = sampleData.contacts.filter(contact => {
                // Year filter
                if (filters.year !== 'all') {
                    const contactYear = new Date(contact["Lead Acquisition Date"]).getFullYear().toString();
                    if (contactYear !== filters.year) return false;
                }
                
                // Province filter
                if (filters.province !== 'all' && contact.Province !== filters.province) return false;
                
                // Region filter
                if (filters.region !== 'all' && contact.Region !== filters.region) return false;
                
                // City filter
                if (filters.city !== 'all' && contact["Pickup City"] !== filters.city) return false;
                
                // Status filter
                if (filters.status !== 'all' && contact["Lead/Customer Status"] !== filters.status) return false;
                
                return true;
            });
            
            // Calculate transaction metrics for each contact
            const contactsWithMetrics = filteredContacts.map(contact => {
                const customerTransactions = sampleData.transactions.filter(t => 
                    t["New Unique Id"] === contact.BhavsContactID
                );
                
                const transactionCount = customerTransactions.length;
                const totalValue = customerTransactions.reduce((sum, t) => sum + t["Gross Sales"], 0);
                
                return {
                    ...contact,
                    transactionCount,
                    totalValue
                };
            });
            
            // Apply transaction count filter
            if (filters.minTransactions !== null) {
                contactsWithMetrics = contactsWithMetrics.filter(c => c.transactionCount >= filters.minTransactions);
            }
            
            // Apply total value filter
            if (filters.minTotalValue !== null) {
                contactsWithMetrics = contactsWithMetrics.filter(c => c.totalValue >= filters.minTotalValue);
            }
            
            // Update customers table
            updateCustomersTable(contactsWithMetrics);
            
            // Update customer analysis if that subview is active
            if (currentSubView === 'analysis') {
                updateCustomerAnalysis(contactsWithMetrics);
            }
        }
        
        function updateCustomersTable(contacts) {
            const tableBody = document.querySelector('#customers-table tbody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            contacts.forEach(contact => {
                const row = document.createElement('tr');
                row.className = 'contact-row';
                row.dataset.contactId = contact.BhavsContactID;
                
                const status = contact["Lead/Customer Status"];
                const statusClass = status === 'customer' ? 'status-customer' : 'status-lead';
                
                row.innerHTML = `
                    <td>${contact.BhavsContactID}</td>
                    <td>${contact["First Name"]} ${contact["Last Name"]}</td>
                    <td>${contact.Email}</td>
                    <td>${contact["Pickup City"]}</td>
                    <td>${contact.Province}</td>
                    <td><span class="${statusClass} status-badge">${status}</span></td>
                    <td>${contact["Lead Acquisition Date"]}</td>
                    <td>${contact.transactionCount}</td>
                    <td>$${contact.totalValue.toFixed(2)}</td>
                `;
                
                // Add click event to open modal
                row.addEventListener('click', () => {
                    openContactModal(contact.BhavsContactID);
                });
                
                tableBody.appendChild(row);
            });
        }
        
        function updateCustomerAnalysis(contacts) {
            const tableBody = document.querySelector('#customer-analysis-table tbody');
            if (!tableBody) return;
            
            const customers = contacts.filter(c => c["Lead/Customer Status"] === 'customer');
            const leads = contacts.filter(c => c["Lead/Customer Status"] === 'lead');
            
            const totalCustomers = customers.length;
            const totalLeads = leads.length;
            const conversionRate = totalCustomers + totalLeads > 0 
                ? Math.round((totalCustomers / (totalCustomers + totalLeads)) * 100)
                : 0;
            
            const avgTransactionValue = customers.length > 0 
                ? customers.reduce((sum, c) => sum + c.totalValue, 0) / customers.length
                : 0;
            
            const avgTransactionCount = customers.length > 0
                ? customers.reduce((sum, c) => sum + c.transactionCount, 0) / customers.length
                : 0;
            
            const analysisData = [
                { metric: 'Total Customers', value: totalCustomers, trend: '+2%', insight: 'Steady growth' },
                { metric: 'Total Leads', value: totalLeads, trend: '+5%', insight: 'Good lead generation' },
                { metric: 'Conversion Rate', value: `${conversionRate}%`, trend: '+1%', insight: 'Improving' },
                { metric: 'Avg Transaction Value', value: `$${avgTransactionValue.toFixed(2)}`, trend: '+3%', insight: 'Increasing' },
                { metric: 'Avg Transactions per Customer', value: avgTransactionCount.toFixed(1), trend: '+0.2', insight: 'Stable' }
            ];
            
            tableBody.innerHTML = '';
            
            analysisData.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.metric}</td>
                    <td>${item.value}</td>
                    <td><span class="metric-change">${item.trend}</span></td>
                    <td>${item.insight}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function updateFruitsView() {
            const filters = filterStates.fruits;
            
            // Filter transactions based on fruits view filters
            let filteredTransactions = sampleData.transactions.filter(transaction => {
                // Get the contact for this transaction
                const contact = sampleData.contacts.find(c => c.BhavsContactID === transaction["New Unique Id"]);
                if (!contact) return false;
                
                // Time filter
                if (filters.time !== 'all') {
                    const transactionYear = new Date(transaction.Date).getFullYear().toString();
                    if (transactionYear !== filters.time) return false;
                }
                
                // Province filter
                if (filters.province !== 'all' && contact.Province !== filters.province) return false;
                
                // Region filter
                if (filters.region !== 'all' && contact.Region !== filters.region) return false;
                
                // City filter
                if (filters.city !== 'all' && contact["Pickup City"] !== filters.city) return false;
                
                // Category filter
                if (filters.category !== 'all') {
                    const fruitColumns = fruitCategories[filters.category];
                    if (!fruitColumns) return true; // Show all if category not found
                    
                    // Check if transaction contains any fruit from this category
                    const hasFruitInCategory = fruitColumns.some(column => 
                        transaction[column] && transaction[column] > 0
                    );
                    if (!hasFruitInCategory) return false;
                }
                
                return true;
            });
            
            // Update fruit grid and table
            updateFruitGrid(filteredTransactions);
            updateFruitSalesTable(filteredTransactions);
        }
        
        function updateFruitGrid(transactions) {
            const fruitGrid = document.getElementById('fruit-grid');
            if (!fruitGrid) return;
            
            // Fruit data with categories
            const fruits = [
                { id: 'blueberries', name: 'Blueberries', icon: 'ü´ê', column: 'Blueberries Pound', color: 'var(--blueberries)', category: 'berry' },
                { id: 'strawberries', name: 'Strawberries', icon: 'üçì', column: 'Strawberries Pound', color: 'var(--strawberries)', category: 'berry' },
                { id: 'raspberries', name: 'Raspberries', icon: 'ü´ê', column: 'Raspberries Pound', color: 'var(--raspberries)', category: 'berry' },
                { id: 'peaches', name: 'Peaches', icon: 'üçë', column: 'Peaches Pound', color: 'var(--peaches)', category: 'stone' },
                { id: 'cherries', name: 'Cherries', icon: 'üçí', column: 'Cherries Pound', color: 'var(--cherries)', category: 'stone' },
                { id: 'apples', name: 'Apples', icon: 'üçé', column: 'Apples Pound', color: 'var(--apples)', category: 'other' },
                { id: 'beans', name: 'Green Beans', icon: 'ü´õ', column: 'Green Beans Pound', color: 'var(--beans)', category: 'veggie' },
                { id: 'grapes', name: 'Green Grapes', icon: 'üçá', column: 'Green Table Grapes Pound', color: 'var(--grapes)', category: 'other' }
            ];
            
            // Calculate metrics for each fruit
            const fruitMetrics = fruits.map(fruit => {
                const column = fruit.column;
                const totalPounds = transactions.reduce((sum, t) => sum + (t[column] || 0), 0);
                const fruitRevenue = transactions.reduce((sum, t) => {
                    const pounds = t[column] || 0;
                    const totalPoundsInOrder = Object.values(fruitCategories).flat().reduce((sum, col) => 
                        sum + (t[col] || 0), 0
                    );
                    
                    if (totalPoundsInOrder > 0 && pounds > 0) {
                        return sum + (t["Gross Sales"] * (pounds / totalPoundsInOrder));
                    }
                    return sum;
                }, 0);
                
                return {
                    ...fruit,
                    totalPounds: Math.round(totalPounds * 10) / 10,
                    revenue: Math.round(fruitRevenue * 100) / 100
                };
            }).filter(fruit => fruit.totalPounds > 0); // Only show fruits with sales
            
            fruitGrid.innerHTML = '';
            
            fruitMetrics.forEach(fruit => {
                const card = document.createElement('div');
                card.className = 'fruit-card';
                card.style.borderTop = `3px solid ${fruit.color}`;
                card.dataset.fruit = fruit.id;
                
                card.innerHTML = `
                    <div class="fruit-icon">${fruit.icon}</div>
                    <div class="fruit-name">${fruit.name}</div>
                    <div style="font-size: 24px; font-weight: bold; margin: 8px 0;">${fruit.totalPounds} lb</div>
                    <div style="color: var(--muted); font-size: 12px;">$${fruit.revenue.toLocaleString()}</div>
                `;
                
                card.addEventListener('click', () => {
                    // Set this fruit category in the filter
                    document.getElementById('fruitsCategorySelect').value = fruit.category;
                    filterStates.fruits.category = fruit.category;
                    updateViewData();
                    updateActiveFiltersDisplay();
                });
                
                fruitGrid.appendChild(card);
            });
        }
        
        function updateFruitSalesTable(transactions) {
            const tableBody = document.querySelector('#fruit-sales-table tbody');
            if (!tableBody) return;
            
            // Fruit data with categories
            const fruits = [
                { id: 'blueberries', name: 'Blueberries', icon: 'ü´ê', column: 'Blueberries Pound', category: 'berry' },
                { id: 'strawberries', name: 'Strawberries', icon: 'üçì', column: 'Strawberries Pound', category: 'berry' },
                { id: 'raspberries', name: 'Raspberries', icon: 'ü´ê', column: 'Raspberries Pound', category: 'berry' },
                { id: 'peaches', name: 'Peaches', icon: 'üçë', column: 'Peaches Pound', category: 'stone' },
                { id: 'cherries', name: 'Cherries', icon: 'üçí', column: 'Cherries Pound', category: 'stone' },
                { id: 'apples', name: 'Apples', icon: 'üçé', column: 'Apples Pound', category: 'other' },
                { id: 'beans', name: 'Green Beans', icon: 'ü´õ', column: 'Green Beans Pound', category: 'veggie' },
                { id: 'grapes', name: 'Green Grapes', icon: 'üçá', column: 'Green Table Grapes Pound', category: 'other' }
            ];
            
            // Calculate metrics for each fruit
            const fruitMetrics = fruits.map(fruit => {
                const column = fruit.column;
                const totalPounds = transactions.reduce((sum, t) => sum + (t[column] || 0), 0);
                const fruitRevenue = transactions.reduce((sum, t) => {
                    const pounds = t[column] || 0;
                    const totalPoundsInOrder = Object.values(fruitCategories).flat().reduce((sum, col) => 
                        sum + (t[col] || 0), 0
                    );
                    
                    if (totalPoundsInOrder > 0 && pounds > 0) {
                        return sum + (t["Gross Sales"] * (pounds / totalPoundsInOrder));
                    }
                    return sum;
                }, 0);
                
                // Get unique customers who bought this fruit
                const customers = new Set();
                transactions.forEach(t => {
                    if (t[column] > 0) {
                        const contact = sampleData.contacts.find(c => c.BhavsContactID === t["New Unique Id"]);
                        if (contact && contact["Lead/Customer Status"] === 'customer') {
                            customers.add(contact.BhavsContactID);
                        }
                    }
                });
                
                const customerCount = customers.size;
                const transactionCount = transactions.filter(t => t[column] > 0).length;
                
                return {
                    ...fruit,
                    totalPounds: Math.round(totalPounds * 10) / 10,
                    revenue: Math.round(fruitRevenue * 100) / 100,
                    avgPerCustomer: customerCount > 0 ? Math.round((totalPounds / customerCount) * 10) / 10 : 0,
                    avgPerTransaction: transactionCount > 0 ? Math.round((totalPounds / transactionCount) * 10) / 10 : 0
                };
            }).filter(fruit => fruit.totalPounds > 0); // Only show fruits with sales
            
            tableBody.innerHTML = '';
            
            fruitMetrics.forEach(fruit => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${fruit.icon} ${fruit.name}</td>
                    <td>${getCategoryName(fruit.category)}</td>
                    <td>${fruit.totalPounds} lb</td>
                    <td>$${fruit.revenue.toFixed(2)}</td>
                    <td>${fruit.avgPerCustomer} lb</td>
                    <td>${fruit.avgPerTransaction} lb</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function getCategoryName(category) {
            const names = {
                'berry': 'Berries',
                'stone': 'Stone Fruits',
                'veggie': 'Vegetables',
                'other': 'Other'
            };
            return names[category] || category;
        }

        function updateGeographyData() {
            const tableBody = document.querySelector('#geography-table tbody');
            const tableHeaders = document.getElementById('geography-table-headers');
            const tableTitle = document.getElementById('geographyTableTitle');
            
            if (!tableBody || !tableHeaders || !tableTitle) return;
            
            let data = [];
            let headers = [];
            
            if (geographyLevel === 'country') {
                tableTitle.textContent = 'Revenue by Province';
                headers = ['Province', '2023 Revenue', '2024 Revenue', '2025 Revenue', 'Total Revenue', 'Customers', 'Avg per Customer'];
                
                // Group by province
                const provinces = [...new Set(sampleData.contacts.map(c => c.Province))];
                data = provinces.map(province => {
                    const provinceContacts = sampleData.contacts.filter(c => c.Province === province);
                    const provinceTransactions = sampleData.transactions.filter(t => {
                        const contact = sampleData.contacts.find(c => c.BhavsContactID === t["New Unique Id"]);
                        return contact && contact.Province === province;
                    });
                    
                    const revenue2023 = provinceTransactions
                        .filter(t => t.Date.startsWith('2023'))
                        .reduce((sum, t) => sum + t["Gross Sales"], 0);
                    
                    const revenue2024 = provinceTransactions
                        .filter(t => t.Date.startsWith('2024'))
                        .reduce((sum, t) => sum + t["Gross Sales"], 0);
                    
                    const revenue2025 = provinceTransactions
                        .filter(t => t.Date.startsWith('2025'))
                        .reduce((sum, t) => sum + t["Gross Sales"], 0);
                    
                    const totalRevenue = revenue2023 + revenue2024 + revenue2025;
                    const customerCount = provinceContacts.filter(c => c["Lead/Customer Status"] === 'customer').length;
                    const avgPerCustomer = customerCount > 0 ? totalRevenue / customerCount : 0;
                    
                    return {
                        name: province,
                        values: [
                            `$${revenue2023.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
                            `$${revenue2024.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
                            `$${revenue2025.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
                            `$${totalRevenue.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
                            customerCount,
                            `$${avgPerCustomer.toFixed(2)}`
                        ]
                    };
                });
                
                // Show/hide map
                document.getElementById('mapPlaceholder').style.display = 'block';
                document.getElementById('provinceMap').style.display = 'none';
                
            } else if (geographyLevel === 'province' && selectedProvince) {
                tableTitle.textContent = `Revenue by Region in ${selectedProvince}`;
                headers = ['Region', '2023 Revenue', '2024 Revenue', '2025 Revenue', 'Total Revenue', 'Customers', 'Avg per Customer'];
                
                // Get regions for selected province
                const regions = [...new Set(sampleData.contacts
                    .filter(c => c.Province === selectedProvince)
                    .map(c => c.Region))];
                
                data = regions.map(region => {
                    const regionContacts = sampleData.contacts.filter(c => 
                        c.Province === selectedProvince && c.Region === region
                    );
                    
                    const regionTransactions = sampleData.transactions.filter(t => {
                        const contact = sampleData.contacts.find(c => c.BhavsContactID === t["New Unique Id"]);
                        return contact && contact.Province === selectedProvince && contact.Region === region;
                    });
                    
                    const revenue2023 = regionTransactions
                        .filter(t => t.Date.startsWith('2023'))
                        .reduce((sum, t) => sum + t["Gross Sales"], 0);
                    
                    const revenue2024 = regionTransactions
                        .filter(t => t.Date.startsWith('2024'))
                        .reduce((sum, t) => sum + t["Gross Sales"], 0);
                    
                    const revenue2025 = regionTransactions
                        .filter(t => t.Date.startsWith('2025'))
                        .reduce((sum, t) => sum + t["Gross Sales"], 0);
                    
                    const totalRevenue = revenue2023 + revenue2024 + revenue2025;
                    const customerCount = regionContacts.filter(c => c["Lead/Customer Status"] === 'customer').length;
                    const avgPerCustomer = customerCount > 0 ? totalRevenue / customerCount : 0;
                    
                    return {
                        name: region,
                        values: [
                            `$${revenue2023.toFixed(2)}`,
                            `$${revenue2024.toFixed(2)}`,
                            `$${revenue2025.toFixed(2)}`,
                            `$${totalRevenue.toFixed(2)}`,
                            customerCount,
                            `$${avgPerCustomer.toFixed(2)}`
                        ]
                    };
                });
                
                // Show/hide map
                document.getElementById('mapPlaceholder').style.display = 'none';
                document.getElementById('provinceMap').style.display = 'block';
                
            } else if (geographyLevel === 'region' && selectedProvince && selectedRegion) {
                tableTitle.textContent = `Revenue by City in ${selectedRegion}, ${selectedProvince}`;
                headers = ['City', '2023 Revenue', '2024 Revenue', '2025 Revenue', 'Total Revenue', 'Customers', 'Avg per Customer'];
                
                // Get cities for selected region
                const cities = [...new Set(sampleData.contacts
                    .filter(c => c.Province === selectedProvince && c.Region === selectedRegion)
                    .map(c => c["Pickup City"]))];
                
                data = cities.map(city => {
                    const cityContacts = sampleData.contacts.filter(c => 
                        c.Province === selectedProvince && 
                        c.Region === selectedRegion && 
                        c["Pickup City"] === city
                    );
                    
                    const cityTransactions = sampleData.transactions.filter(t => {
                        const contact = sampleData.contacts.find(c => c.BhavsContactID === t["New Unique Id"]);
                        return contact && 
                               contact.Province === selectedProvince && 
                               contact.Region === selectedRegion && 
                               contact["Pickup City"] === city;
                    });
                    
                    const revenue2023 = cityTransactions
                        .filter(t => t.Date.startsWith('2023'))
                        .reduce((sum, t) => sum + t["Gross Sales"], 0);
                    
                    const revenue2024 = cityTransactions
                        .filter(t => t.Date.startsWith('2024'))
                        .reduce((sum, t) => sum + t["Gross Sales"], 0);
                    
                    const revenue2025 = cityTransactions
                        .filter(t => t.Date.startsWith('2025'))
                        .reduce((sum, t) => sum + t["Gross Sales"], 0);
                    
                    const totalRevenue = revenue2023 + revenue2024 + revenue2025;
                    const customerCount = cityContacts.filter(c => c["Lead/Customer Status"] === 'customer').length;
                    const avgPerCustomer = customerCount > 0 ? totalRevenue / customerCount : 0;
                    
                    return {
                        name: city,
                        values: [
                            `$${revenue2023.toFixed(2)}`,
                            `$${revenue2024.toFixed(2)}`,
                            `$${revenue2025.toFixed(2)}`,
                            `$${totalRevenue.toFixed(2)}`,
                            customerCount,
                            `$${avgPerCustomer.toFixed(2)}`
                        ]
                    };
                });
                
                // Show/hide map
                document.getElementById('mapPlaceholder').style.display = 'none';
                document.getElementById('provinceMap').style.display = 'block';
            }
            
            // Update table headers
            tableHeaders.innerHTML = '';
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                tableHeaders.appendChild(th);
            });
            
            // Update table body
            tableBody.innerHTML = '';
            data.forEach(item => {
                const row = document.createElement('tr');
                
                // Add name cell
                const nameCell = document.createElement('td');
                nameCell.textContent = item.name;
                if (geographyLevel === 'country') {
                    nameCell.style.cursor = 'pointer';
                    nameCell.style.color = 'var(--primary)';
                    nameCell.addEventListener('click', () => {
                        selectProvinceOnMap(item.name);
                    });
                }
                row.appendChild(nameCell);
                
                // Add value cells
                item.values.forEach(value => {
                    const cell = document.createElement('td');
                    cell.textContent = value;
                    row.appendChild(cell);
                });
                
                tableBody.appendChild(row);
            });
        }

        function generateCalendar() {
            const calendarGrid = document.getElementById('calendar-grid');
            if (!calendarGrid) return;
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            
            // Update month/year display
            document.getElementById('current-month-year').textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            // Get first day of month and total days
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const totalDays = lastDay.getDate();
            const startingDay = firstDay.getDay(); // 0 = Sunday, 1 = Monday, etc.
            
            // Clear calendar
            calendarGrid.innerHTML = '';
            
            // Add day headers
            const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            daysOfWeek.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day';
                dayHeader.style.fontWeight = '600';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            // Add empty cells for days before the first day of month
            for (let i = 0; i < startingDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day other-month';
                emptyDay.textContent = '';
                calendarGrid.appendChild(emptyDay);
            }
            
            // Add days of the month
            const today = new Date();
            const isCurrentMonth = today.getMonth() === currentMonth && today.getFullYear() === currentYear;
            
            for (let day = 1; day <= totalDays; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                
                // Check if today
                if (isCurrentMonth && day === today.getDate()) {
                    dayElement.classList.add('today');
                }
                
                // Check for pickups
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                if (pickupSchedule[dateStr]) {
                    dayElement.classList.add('has-pickup');
                    
                    // Add pickup count badge
                    const pickupCount = document.createElement('div');
                    pickupCount.className = 'pickup-count';
                    pickupCount.textContent = pickupSchedule[dateStr].length;
                    dayElement.appendChild(pickupCount);
                    
                    // Add click event to show pickups for that day
                    dayElement.style.cursor = 'pointer';
                    dayElement.addEventListener('click', () => {
                        showPickupsForDate(dateStr);
                    });
                }
                
                calendarGrid.appendChild(dayElement);
            }
        }

        function updateTodayPickups() {
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            
            // Update today's date display
            document.getElementById('today-date').textContent = today.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Update today's pickups table
            const tableBody = document.querySelector('#today-pickups tbody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            const pickups = pickupSchedule[todayStr] || [];
            document.getElementById('pickup-count').textContent = pickups.length;
            
            pickups.forEach(pickup => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${pickup.time}</td>
                    <td>${pickup.customer}</td>
                    <td>${pickup.location}</td>
                    <td>$${pickup.total.toFixed(2)}</td>
                    <td>${pickup.items}</td>
                    <td><span class="status-badge ${pickup.status === 'confirmed' ? 'status-customer' : 'status-lead'}">${pickup.status}</span></td>
                `;
                tableBody.appendChild(row);
            });
        }

        function showPickupsForDate(dateStr) {
            const date = new Date(dateStr);
            const formattedDate = date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            const pickups = pickupSchedule[dateStr] || [];
            let message = `Pickups for ${formattedDate}:\n\n`;
            
            if (pickups.length === 0) {
                message += "No pickups scheduled for this day.";
            } else {
                pickups.forEach((pickup, index) => {
                    message += `${index + 1}. ${pickup.time} - ${pickup.customer}\n`;
                    message += `   ${pickup.location} - $${pickup.total} - ${pickup.items}\n\n`;
                });
            }
            
            alert(message);
        }

        function setupContactModal() {
            const modalOverlay = document.getElementById('contactModalOverlay');
            const modalClose = document.getElementById('contactModalClose');
            
            // Close modal
            modalClose.addEventListener('click', () => {
                modalOverlay.classList.remove('show');
            });
            
            // Close when clicking overlay
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    modalOverlay.classList.remove('show');
                }
            });
        }
        
        function openContactModal(contactId) {
            const contact = sampleData.contacts.find(c => c.BhavsContactID === contactId);
            if (!contact) return;
            
            const modalOverlay = document.getElementById('contactModalOverlay');
            const modalTitle = document.getElementById('contactModalTitle');
            const modalContent = document.getElementById('contactModalContent');
            
            currentContactModalId = contactId;
            
            // Set modal title
            modalTitle.textContent = `${contact["First Name"]} ${contact["Last Name"]}`;
            
            // Get customer transactions
            const transactions = sampleData.transactions.filter(t => t["New Unique Id"] === contactId);
            const transactionCount = transactions.length;
            const totalValue = transactions.reduce((sum, t) => sum + t["Gross Sales"], 0);
            
            // Get purchase history
            const purchaseHistory = transactions.map(t => {
                const fruits = [];
                if (t['Blueberries Pound'] > 0) fruits.push(`Blueberries: ${t['Blueberries Pound']} lb`);
                if (t['Strawberries Pound'] > 0) fruits.push(`Strawberries: ${t['Strawberries Pound']} lb`);
                if (t['Peaches Pound'] > 0) fruits.push(`Peaches: ${t['Peaches Pound']} lb`);
                if (t['Raspberries Pound'] > 0) fruits.push(`Raspberries: ${t['Raspberries Pound']} lb`);
                if (t['Cherries Pound'] > 0) fruits.push(`Cherries: ${t['Cherries Pound']} lb`);
                if (t['Apples Pound'] > 0) fruits.push(`Apples: ${t['Apples Pound']} lb`);
                
                return {
                    date: t.Date,
                    total: t["Gross Sales"],
                    items: fruits.join(', ')
                };
            });
            
            // Create modal content
            let contentHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                    <div>
                        <h4 style="margin-bottom: 12px; color: var(--muted);">Contact Information</h4>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <div><strong>Email:</strong> ${contact.Email}</div>
                            <div><strong>Phone:</strong> ${contact.Phone}</div>
                            <div><strong>Location:</strong> ${contact["Pickup City"]}, ${contact.Province}</div>
                            <div><strong>Region:</strong> ${contact.Region}</div>
                            <div><strong>Status:</strong> <span class="${contact["Lead/Customer Status"] === 'customer' ? 'status-customer' : 'status-lead'} status-badge">${contact["Lead/Customer Status"]}</span></div>
                            <div><strong>Acquired:</strong> ${contact["Lead Acquisition Date"]}</div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 style="margin-bottom: 12px; color: var(--muted);">Purchase Summary</h4>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <div><strong>Total Transactions:</strong> ${transactionCount}</div>
                            <div><strong>Total Value:</strong> $${totalValue.toFixed(2)}</div>
                            <div><strong>Avg Transaction:</strong> $${transactionCount > 0 ? (totalValue / transactionCount).toFixed(2) : '0.00'}</div>
                            <div><strong>Customer Since:</strong> ${new Date(contact["Lead Acquisition Date"]).toLocaleDateString()}</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add purchase history for customers
            if (contact["Lead/Customer Status"] === 'customer' && purchaseHistory.length > 0) {
                contentHTML += `
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h4 style="color: var(--muted);">Purchase History</h4>
                            <div class="purchase-view-toggle">
                                <button class="view-toggle-btn ${purchaseViewMode === 'grid' ? 'active' : ''}" data-purchase-view="grid">Grid View</button>
                                <button class="view-toggle-btn ${purchaseViewMode === 'list' ? 'active' : ''}" data-purchase-view="list">List View</button>
                            </div>
                        </div>
                        
                        <div id="purchase-history-container">
                            <!-- Purchase history will be rendered here -->
                        </div>
                    </div>
                `;
            } else if (contact["Lead/Customer Status"] === 'lead') {
                contentHTML += `
                    <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; padding: 16px; margin-top: 16px;">
                        <h4 style="margin-bottom: 8px; color: var(--primary);">Lead Status</h4>
                        <p style="font-size: 14px; color: var(--muted);">
                            This contact is currently a lead. They haven't made any purchases yet.
                            Consider reaching out to convert them into a customer.
                        </p>
                    </div>
                `;
            }
            
            modalContent.innerHTML = contentHTML;
            
            // Render purchase history
            if (contact["Lead/Customer Status"] === 'customer' && purchaseHistory.length > 0) {
                renderPurchaseHistory(purchaseHistory);
                
                // Set up purchase view toggle in modal
                const modalToggleButtons = modalContent.querySelectorAll('.view-toggle-btn');
                modalToggleButtons.forEach(btn => {
                    btn.addEventListener('click', function() {
                        const view = this.dataset.purchaseView;
                        modalToggleButtons.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        purchaseViewMode = view;
                        renderPurchaseHistory(purchaseHistory);
                    });
                });
            }
            
            // Show modal
            modalOverlay.classList.add('show');
        }
        
        function renderPurchaseHistory(purchases) {
            const container = document.getElementById('purchase-history-container');
            if (!container) return;
            
            if (purchaseViewMode === 'grid') {
                container.innerHTML = '<div class="purchase-grid" id="modal-purchase-grid"></div>';
                const grid = document.getElementById('modal-purchase-grid');
                
                purchases.forEach(purchase => {
                    const card = document.createElement('div');
                    card.className = 'purchase-card';
                    card.innerHTML = `
                        <div style="font-weight: 600; margin-bottom: 8px;">${purchase.date}</div>
                        <div style="font-size: 20px; font-weight: 700; color: var(--success); margin-bottom: 8px;">
                            $${purchase.total.toFixed(2)}
                        </div>
                        <div style="font-size: 12px; color: var(--muted);">
                            ${purchase.items}
                        </div>
                    `;
                    grid.appendChild(card);
                });
            } else {
                container.innerHTML = '<div class="purchase-list" id="modal-purchase-list"></div>';
                const list = document.getElementById('modal-purchase-list');
                
                purchases.forEach(purchase => {
                    const item = document.createElement('div');
                    item.className = 'purchase-item';
                    item.innerHTML = `
                        <div>
                            <div style="font-weight: 600;">${purchase.date}</div>
                            <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">${purchase.items}</div>
                        </div>
                        <div style="font-size: 18px; font-weight: 700; color: var(--success);">
                            $${purchase.total.toFixed(2)}
                        </div>
                    `;
                    list.appendChild(item);
                });
            }
        }

        function setupCustomerSubViews() {
            const tabs = document.querySelectorAll('#customersViewTabs .view-tab');
            const subviews = document.querySelectorAll('#view-customers .view-subview');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const subview = this.dataset.subview;
                    
                    // Update active tab
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Update active subview
                    subviews.forEach(sv => {
                        sv.classList.remove('active');
                        if (sv.id === `customers-${subview}-subview`) {
                            sv.classList.add('active');
                        }
                    });
                    
                    currentSubView = subview;
                    
                    // Update data for the subview
                    if (subview === 'analysis') {
                        updateCustomerAnalysisFromCurrentData();
                    }
                });
            });
        }
        
        function updateCustomerAnalysisFromCurrentData() {
            // This would be called when switching to analysis tab
            // For now, we'll just trigger an update
            updateViewData();
        }

        function setupPurchaseViewToggle() {
            // This is for the main customers view toggle
            const toggleButtons = document.querySelectorAll('[data-purchase-view]');
            toggleButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const view = this.dataset.purchaseView;
                    toggleButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    purchaseViewMode = view;
                    
                    // If modal is open, update its purchase history view
                    if (currentContactModalId) {
                        const contact = sampleData.contacts.find(c => c.BhavsContactID === currentContactModalId);
                        if (contact && contact["Lead/Customer Status"] === 'customer') {
                            const transactions = sampleData.transactions.filter(t => t["New Unique Id"] === currentContactModalId);
                            const purchaseHistory = transactions.map(t => {
                                const fruits = [];
                                if (t['Blueberries Pound'] > 0) fruits.push(`Blueberries: ${t['Blueberries Pound']} lb`);
                                if (t['Strawberries Pound'] > 0) fruits.push(`Strawberries: ${t['Strawberries Pound']} lb`);
                                if (t['Peaches Pound'] > 0) fruits.push(`Peaches: ${t['Peaches Pound']} lb`);
                                if (t['Raspberries Pound'] > 0) fruits.push(`Raspberries: ${t['Raspberries Pound']} lb`);
                                if (t['Cherries Pound'] > 0) fruits.push(`Cherries: ${t['Cherries Pound']} lb`);
                                if (t['Apples Pound'] > 0) fruits.push(`Apples: ${t['Apples Pound']} lb`);
                                
                                return {
                                    date: t.Date,
                                    total: t["Gross Sales"],
                                    items: fruits.join(', ')
                                };
                            });
                            
                            renderPurchaseHistory(purchaseHistory);
                        }
                    }
                });
            });
        }

        function switchView(view) {
            // Hide all views
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            
            // Hide all filter bars
            document.querySelectorAll('.view-filter-bar').forEach(fb => fb.classList.remove('active'));
            
            // Show selected view
            const viewElement = document.getElementById(`view-${view}`);
            if (viewElement) {
                viewElement.classList.add('active');
                currentView = view;
                
                // Show appropriate filter bar
                const filterBar = document.getElementById(`${view}-filter-bar`);
                if (filterBar) {
                    filterBar.classList.add('active');
                }
                
                // Update navigation active states
                // Desktop sidebar
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.view === view) {
                        item.classList.add('active');
                    }
                });
                
                // Mobile bottom nav
                document.querySelectorAll('.mobile-nav-button').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.view === view) {
                        btn.classList.add('active');
                    }
                });
                
                // Update page title
                const titles = {
                    main: 'Dashboard',
                    customers: 'Customers & Leads',
                    fruits: 'Fruit Analytics',
                    geography: 'Geography',
                    calendar: 'Calendar'
                };
                
                document.getElementById('page-title').textContent = `BerryFarm Analytics - ${titles[view] || view}`;
                document.getElementById('viewFilterText').textContent = `${titles[view] || view} Filters`;
                
                // Update data for this view
                updateViewData();
                updateActiveFiltersDisplay();
                
                // Close sidebar on mobile
                if (window.innerWidth <= 1024) {
                    document.getElementById('sidebar').classList.remove('show');
                }
            }
        }

        // Theme toggle
        function toggleTheme() {
            const isDark = document.body.classList.contains('dark-mode');
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = themeToggle.querySelector('.theme-icon');
            const themeText = themeToggle.querySelector('.theme-text');
            
            if (isDark) {
                document.body.classList.remove('dark-mode');
                document.body.classList.add('light-mode');
                themeIcon.textContent = '‚òÄÔ∏è';
                themeText.textContent = 'Light';
                localStorage.setItem('theme', 'light');
            } else {
                document.body.classList.remove('light-mode');
                document.body.classList.add('dark-mode');
                themeIcon.textContent = 'üåô';
                themeText.textContent = 'Dark';
                localStorage.setItem('theme', 'dark');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set up theme
            const savedTheme = localStorage.getItem('theme') || 'dark';
            if (savedTheme === 'light') {
                document.body.classList.remove('dark-mode');
                document.body.classList.add('light-mode');
                document.getElementById('themeToggle').querySelector('.theme-icon').textContent = '‚òÄÔ∏è';
                document.getElementById('themeToggle').querySelector('.theme-text').textContent = 'Light';
            }
            
            // Set up theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            // Set up mobile menu toggle
            document.getElementById('mobileMenuBtn').addEventListener('click', function() {
                document.getElementById('sidebar').classList.toggle('show');
            });
            
            // Set up navigation
            // Desktop sidebar
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    switchView(this.dataset.view);
                });
            });
            
            // Mobile bottom nav
            document.querySelectorAll('.mobile-nav-button').forEach(button => {
                button.addEventListener('click', function() {
                    switchView(this.dataset.view);
                });
            });
            
            // Calendar navigation
            document.getElementById('prev-month').addEventListener('click', () => {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                generateCalendar();
            });
            
            document.getElementById('next-month').addEventListener('click', () => {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                generateCalendar();
            });
            
            document.getElementById('today-btn').addEventListener('click', () => {
                currentDate = new Date();
                currentMonth = currentDate.getMonth();
                currentYear = currentDate.getFullYear();
                generateCalendar();
                updateTodayPickups();
            });
            
            // Initialize dashboard
            initDashboard();
            
            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', function(e) {
                const sidebar = document.getElementById('sidebar');
                const mobileBtn = document.getElementById('mobileMenuBtn');
                
                if (window.innerWidth <= 1024 && 
                    sidebar.classList.contains('show') &&
                    !sidebar.contains(e.target) && 
                    e.target !== mobileBtn && 
                    !mobileBtn.contains(e.target)) {
                    sidebar.classList.remove('show');
                }
            });
            
            // Handle window resize
            window.addEventListener('resize', function() {
                const sidebar = document.getElementById('sidebar');
                if (window.innerWidth > 1024) {
                    sidebar.classList.remove('show');
                }
            });
        });
    </script>
</body>
</html>
